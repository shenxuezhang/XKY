<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>海外仓索赔管理系统 - 内部版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b', border: '#334155', text: '#f8fafc', muted: '#94a3b8' }
                    }
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="suopei_assets/css/styles.css">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif; 
            background-color: #f8fafc; 
            color: #334155;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body { background-color: #0f172a; color: #f8fafc; }

        /* 自定义滚动条 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }

        /* 纯 CSS 弹窗逻辑 */
        .modal-backdrop {
            position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px);
            z-index: 100; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: white; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%; max-width: 28rem; padding: 1.5rem; margin: 1rem;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .dark .modal-content { background-color: #1e293b; }
        .modal-backdrop.active .modal-content { transform: scale(1); }
        
        /* 物流官网弹窗样式 - 用于iframe显示 */
        .logistics-modal-content {
            background-color: white; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%; max-width: 90vw; max-height: 90vh; padding: 0; margin: 1rem;
            transform: scale(0.95); transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        .dark .logistics-modal-content { background-color: #1e293b; }
        .modal-backdrop.active .logistics-modal-content { transform: scale(1); }
        .logistics-modal-header {
            padding: 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
        }
        .dark .logistics-modal-header { border-bottom-color: #334155; }
        .logistics-modal-iframe {
            flex: 1; width: 100%; border: none; min-height: 1100px; border-radius: 0 0 1rem 1rem;
        }

        /* 状态 Tab 胶囊 */
        .status-pill {
            padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700;
            cursor: pointer; transition: all 0.2s; opacity: 0.7; border: 1px solid transparent;
        }
        .status-pill:hover { opacity: 1; transform: translateY(-1px); }
        .status-pill.active { opacity: 1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-color: currentColor; }
        
        .pill-all { background-color: #e2e8f0; color: #475569; }
        .dark .pill-all { background-color: #334155; color: #e2e8f0; }
        .pill-pending { background-color: #dbeafe; color: #1d4ed8; }
        .dark .pill-pending { background-color: rgba(30, 58, 138, 0.5); color: #93c5fd; }
        .pill-processing { background-color: #e0e7ff; color: #4338ca; }
        .dark .pill-processing { background-color: rgba(49, 46, 129, 0.5); color: #a5b4fc; }
        .pill-waiting { background-color: #fef3c7; color: #b45309; }
        .dark .pill-waiting { background-color: rgba(120, 53, 15, 0.5); color: #fcd34d; }
        .pill-paid { background-color: #d1fae5; color: #047857; }
        .dark .pill-paid { background-color: rgba(6, 78, 59, 0.5); color: #6ee7b7; }
        .pill-rejected { background-color: #fee2e2; color: #b91c1c; }
        .dark .pill-rejected { background-color: rgba(127, 29, 29, 0.5); color: #fca5a5; }

        /* 页面切换动画 */
        .animate-fade-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInUp { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        
        /* 公告淡入动画 */
        .fade-in-down { animation: fadeInDown 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }

        /* Toast */
        @keyframes slideIn { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        .toast-exit { animation: fadeOut 0.3s ease-out forwards; }
        
        /* 玻璃拟态卡片 */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(51, 65, 85, 0.5);
        }

        /* 统一输入框标签样式 */
        .input-group-label {
            display: block; font-size: 0.875rem; font-weight: 700; color: #475569; margin-bottom: 0.5rem;
        }
        .dark .input-group-label { color: #cbd5e1; }
        .bg-blue-50 .input-group-label { color: #1e3a8a; opacity: 0.8; }
        .dark .bg-blue-50 .input-group-label { color: #93c5fd; }

        /* 输入框模式适配 */
        .form-input, .form-textarea, select.form-input {
            color: #1e293b;
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .form-input:focus, .form-textarea:focus, select.form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .dark .form-input, .dark .form-textarea, .dark select.form-input {
            color: #f8fafc;
            background-color: #334155;
            border-color: #475569;
        }
        .dark .form-input:focus, .dark .form-textarea:focus, .dark select.form-input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
        }
        
        /* 文本域样式优化 */
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* 选择框样式优化 */
        select.form-input {
            cursor: pointer;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* 总赔偿金额输入框的placeholder样式 */
        #claim_total::placeholder {
            color: #ef4444;
            opacity: 0.5;
        }
        .dark #claim_total::placeholder {
            color: #f87171;
            opacity: 0.5;
        }
        
        /* 图片光标 */
        .cursor-zoom-in { cursor: zoom-in; }
        
        /* 表格样式增强 */
        .erp-th {
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
            user-select: none;
        }
        .dark .erp-th {
            color: #94a3b8;
            background-color: #1e293b;
            border-bottom-color: #334155;
        }
        .erp-th-sortable { cursor: pointer; transition: color 0.2s; }
        .erp-th-sortable:hover { color: #3b82f6; }
        
        .erp-td {
            padding: 0.625rem 1rem; /* 调整行间距，减小垂直内边距，使行更紧凑 */
            font-size: 0.875rem;
            color: #334155;
            vertical-align: middle;
            border-bottom: 1px solid #f1f5f9; /* 使用更细的分隔线 */
        }
        .dark .erp-td {
            color: #e2e8f0;
            border-bottom-color: #334155;
        }
        
        .erp-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .action-btn {
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        
        /* ==================== vxe-table 风格样式增强 ==================== */
        
        /* 表格容器 - 响应式布局 */
        .vxe-table-wrapper {
            position: relative;
            overflow: hidden;
        }
        
        /* 固定列技术 - 左侧固定（复选框列） */
        .is--fixed-left {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: inherit;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
        }
        
        thead .is--fixed-left {
            background-color: #f8fafc;
        }
        
        .dark thead .is--fixed-left {
            background-color: #1e293b;
        }
        
        tbody .is--fixed-left {
            background-color: #ffffff;
        }
        
        .dark tbody .is--fixed-left {
            background-color: #1e293b;
        }
        
        /* 固定列技术 - 右侧固定（操作列） */
        .is--fixed-right {
            position: sticky;
            right: 0;
            z-index: 10;
            background-color: inherit;
            box-shadow: -2px 0 4px rgba(0, 0, 0, 0.05);
        }
        
        thead .is--fixed-right {
            background-color: #f8fafc;
        }
        
        .dark thead .is--fixed-right {
            background-color: #1e293b;
        }
        
        tbody .is--fixed-right {
            background-color: #ffffff;
        }
        
        .dark tbody .is--fixed-right {
            background-color: #1e293b;
        }
        
        /* 列宽拖拽调整 */
        .vxe-resizable {
            position: relative;
        }
        
        .vxe-resizable--handle {
            position: absolute;
            right: 0;
            top: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            user-select: none;
            z-index: 1;
        }
        
        .vxe-resizable--handle:hover {
            background-color: #3b82f6;
            opacity: 0.5;
        }
        
        .vxe-resizable--dragging {
            background-color: #3b82f6;
            opacity: 0.8;
        }
        
        /* 排序功能增强 - 排序按钮 */
        .vxe-sort--wrapper {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin-left: 4px;
            vertical-align: middle;
        }
        
        .vxe-sort--btn {
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            cursor: pointer;
            transition: border-color 0.2s;
            opacity: 0.3;
        }
        
        .vxe-sort--asc-btn {
            border-bottom: 6px solid currentColor;
            margin-bottom: 2px;
        }
        
        .vxe-sort--desc-btn {
            border-top: 6px solid currentColor;
        }
        
        .erp-th-sortable:hover .vxe-sort--btn {
            opacity: 0.6;
        }
        
        .vxe-sort--asc-btn.is--active {
            opacity: 1;
            color: #3b82f6;
        }
        
        .vxe-sort--desc-btn.is--active {
            opacity: 1;
            color: #3b82f6;
        }
        
        /* 工具提示与防遮挡 - c--tooltip */
        .c--tooltip {
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .c--tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background-color: #1f2937;
            color: #ffffff;
            font-size: 0.75rem;
            white-space: nowrap;
            border-radius: 4px;
            z-index: 1000;
            margin-bottom: 4px;
            pointer-events: none;
        }
        
        .dark .c--tooltip:hover::after {
            background-color: #f9fafb;
            color: #1f2937;
        }
        
        /* 排版控制技术 - 单行文本截断 */
        .oneLine {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }
        
        /* 排版控制技术 - 多行文本截断 */
        .twoLines {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.5;
            max-height: 3em;
        }
        
        /* 复选框列样式 */
        .col--checkbox {
            width: 48px;
            min-width: 48px;
            max-width: 48px;
        }
        
        /* 禁用状态 */
        .is--disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* flex布局辅助类 */
        .ak-justify-between {
            display: flex;
            justify-content: space-between;
        }
        
        .ak-align-center {
            display: flex;
            align-items: center;
        }
        
        /* 表格滚动优化 */
        .table-container {
            position: relative;
            overflow-x: auto;
            overflow-y: auto;
        }
        
        /* ==================== 行高优化 - 固定行高策略 ==================== */
        
        /* 使用CSS变量管理行高，值由JavaScript动态设置 */
        :root {
            --table-row-height: 130px; /* 默认值，将在页面加载时由JavaScript更新 */
        }
        
        /* 固定行高：确保每行统一高度 */
        tbody tr {
            height: var(--table-row-height);
            min-height: var(--table-row-height);
            max-height: var(--table-row-height);
        }
        
        /* 单元格内容容器 - vxe-cell */
        .vxe-cell {
            max-height: var(--table-row-height);
            overflow: hidden;
            display: flex;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        
        /* 文本截断增强 - col--ellipsis */
        .col--ellipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* 确保单元格内容不会撑开行高 */
        .erp-td {
            height: var(--table-row-height);
            vertical-align: middle;
            position: relative;
        }
        
        .erp-td > .vxe-cell {
            max-height: var(--table-row-height);
            overflow: hidden;
        }
        
        /* 多行文本截断优化 - 确保不超过行高 */
        .twoLines.vxe-cell {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: var(--table-row-height);
            line-height: 1.5;
        }
        
        /* 单行文本截断优化 */
        .oneLine.vxe-cell {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-height: var(--table-row-height);
        }
        
        /* 新登录界面样式 */
        .login-container .form-input:focus {
            outline: none;
            border-color: #588bff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }
        
        .login-container .form-input:focus ~ .input-icon {
            color: #588bff;
        }
        
        .login-container .btn-primary:hover {
            background: linear-gradient(135deg, #0057b7 0%, #0057b7 100%);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
            transform: translateY(-2px);
        }
        
        .login-container .btn-primary:active {
            transform: translateY(0);
        }
        
        .login-container .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .login-container .btn-loading {
            position: relative;
            color: transparent;
        }
        
        .login-container .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spinner 0.8s linear infinite;
        }
        
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        
        .login-container .checkbox-wrapper {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            position: relative;
            color: #333;
        }
        
        .dark .login-container .checkbox-wrapper {
            color: #f8fafc;
        }
        
        .dark .login-container .checkbox-wrapper span:not(.checkmark) {
            color: #f8fafc;
        }
        
        .login-container .checkbox-wrapper input[type="checkbox"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
            margin: 0;
            z-index: 2;
        }
        
        .login-container .checkmark {
            width: 20px;
            height: 20px;
            border: 1px solid #e5e5ea;
            border-radius: 4px;
            margin-right: 8px;
            position: relative;
            transition: all 0.3s;
            background: #fff;
            display: inline-block;
            z-index: 1;
        }
        
        .login-container .checkbox-wrapper input:checked ~ .checkmark {
            background: #007aff;
            border-color: #007aff;
        }
        
        .login-container .checkmark::after {
            content: '';
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .login-container .checkbox-wrapper input:checked ~ .checkmark::after {
            display: block;
        }
        
        .login-container .forgot-password:hover {
            text-decoration: underline;
        }
        
        .dark .login-container .form-section {
            background: #1e293b !important;
        }
        
        .dark .login-container .form-label {
            color: #f8fafc !important;
        }
        
        .dark .login-container .form-options {
            color: #f8fafc;
        }
        
        .dark .login-container .checkbox-wrapper span:not(.checkmark) {
            color: #f8fafc !important;
        }
        
        .dark .login-container .checkmark {
            border-color: #475569 !important;
            background: #334155 !important;
        }
        
        .dark .login-container .checkbox-wrapper input:checked ~ .checkmark {
            background: #007aff !important;
            border-color: #007aff !important;
        }
        
        .dark .login-container {
            background: #1e293b !important;
            border-color: #334155 !important;
        }
        
        .dark .login-container .form-title {
            color: #f8fafc !important;
        }
        
        .dark .login-container .form-subtitle {
            color: #cbd5e1 !important;
        }
        
        .dark .login-container .register-link {
            color: #cbd5e1 !important;
        }
        
        .login-container .register-link a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .login-container {
                flex-direction: column !important;
                height: auto !important;
                max-width: 400px !important;
            }
            
            .login-container .brand-section {
                padding: 40px 30px !important;
                text-align: center;
            }
            
            .login-container .brand-title {
                font-size: 32px !important;
            }
            
            .login-container .brand-subtitle {
                font-size: 16px !important;
            }
            
            .login-container .form-section {
                padding: 40px 30px !important;
            }
        }
    </style>
</head>
<body class="antialiased relative min-h-screen flex transition-colors duration-300">

    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[9999] flex flex-col gap-3 pointer-events-none px-4 md:px-0 w-full max-w-md items-center"></div>
    
    <div id="login-container" class="fixed inset-0 bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-slate-900 dark:to-slate-800 flex items-center justify-center z-50 hidden" style="background: #f2f2f7; padding: 20px;">
        <div class="login-container" style="width: 100%; max-width: 1200px; height: 700px; display: flex; background: #fff; border-radius: 20px; border: 1px solid #e5e5ea; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); overflow: hidden; position: relative;">
            <div class="brand-section" style="flex: 1; background: linear-gradient(135deg, #007aff 0%, #0057b7 100%); color: white; padding: 60px; display: flex; flex-direction: column; justify-content: center; position: relative;">
                <div class="brand-content" style="position: relative; z-index: 1;">
                    <div class="logo" style="display: flex; align-items: center; margin-bottom: 40px; font-size: 28px; font-weight: 700;">
                        <div class="logo-icon" style="width: 50px; height: 50px; background: rgba(255, 255, 255, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 24px; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1);">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <span>TechCorp</span>
                    </div>
                    <h1 id="system-title-main" class="brand-title" style="font-size: 48px; font-weight: 800; margin-bottom: 20px; background: linear-gradient(to right, #fff, #588bff); -webkit-background-clip: text; background-clip: text; color: transparent;">海外仓索赔管理系统 <span style="font-size: 24px; color: rgba(255, 255, 255, 0.9); -webkit-background-clip: unset; background-clip: unset; background: none;">v2.6.1</span></h1>
                    <p class="brand-subtitle" style="font-size: 20px; opacity: 0.85; margin-bottom: 40px; line-height: 1.6;">安全、高效、智能的应用解决方案，助力提升人效</p>
                    
                    <ul class="feature-list" style="list-style: none;">
                        <li class="feature-item" style="display: flex; align-items: center; margin-bottom: 20px; font-size: 16px; opacity: 0.9;">
                            <div class="feature-icon" style="width: 36px; height: 36px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 16px; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1);">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <span>自主开发护航</span>
                        </li>
                        <li class="feature-item" style="display: flex; align-items: center; margin-bottom: 20px; font-size: 16px; opacity: 0.9;">
                            <div class="feature-icon" style="width: 36px; height: 36px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 16px; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1);">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <span>碎片数据集成</span>
                        </li>
                        <li class="feature-item" style="display: flex; align-items: center; margin-bottom: 20px; font-size: 16px; opacity: 0.9;">
                            <div class="feature-icon" style="width: 36px; height: 36px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 16px; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1);">
                                <i class="fas fa-users"></i>
                            </div>
                            <span>团队协作管理</span>
                        </li>
                        <li class="feature-item" style="display: flex; align-items: center; margin-bottom: 20px; font-size: 16px; opacity: 0.9;">
                            <div class="feature-icon" style="width: 36px; height: 36px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 16px; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1);">
                                <i class="fas fa-cloud"></i>
                            </div>
                            <span>云端同步存储</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="form-section" style="flex: 1; padding: 60px; display: flex; flex-direction: column; justify-content: center; background: #fff;">
                <div class="form-container" style="max-width: 400px; width: 100%; margin: 0 auto;">
                    <div class="error-message" id="errorMessage" style="background: rgba(255, 59, 48, 0.15); border: 1px solid rgba(255, 59, 48, 0.3); color: #ff3b30; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: none; align-items: center; backdrop-filter: blur(5px);">
                        <i class="fas fa-exclamation-circle" style="margin-right: 8px; font-size: 16px;"></i>
                        <span id="errorText"></span>
                    </div>

                    <div class="success-message" id="successMessage" style="background: rgba(76, 217, 100, 0.15); border: 1px solid rgba(76, 217, 100, 0.3); color: #4cd964; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: none; align-items: center; backdrop-filter: blur(5px);">
                        <i class="fas fa-check-circle" style="margin-right: 8px; font-size: 16px;"></i>
                        <span id="successText"></span>
                    </div>

                    <div id="loginForm" class="form-content">
                        <div class="form-header" style="text-align: center; margin-bottom: 40px;">
                            <h2 class="form-title" style="font-size: 32px; font-weight: 700; color: #000; margin-bottom: 10px;">欢迎回来</h2>
                            <p class="form-subtitle" style="color: #999; font-size: 16px;">请输入您的登录凭据</p>
                        </div>

                        <form id="login-form">
                            <div class="form-group" style="margin-bottom: 24px; position: relative;">
                                <label class="form-label" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px;">账号</label>
                                <div class="input-wrapper" style="position: relative;">
                                    <i class="fas fa-user input-icon" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #999; font-size: 18px;"></i>
                                    <input type="email" id="login-email" class="form-input" style="width: 100%; padding: 16px 20px 16px 50px; border: 1px solid #e5e5ea; border-radius: 12px; font-size: 16px; transition: all 0.3s; background: #fff; color: #000;" placeholder="请输入您的邮箱" autocomplete="username" required>
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 24px; position: relative;">
                                <label class="form-label" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px;">密码</label>
                                <div class="input-wrapper" style="position: relative;">
                                    <i class="fas fa-lock input-icon" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #999; font-size: 18px;"></i>
                                    <input type="password" id="login-password" class="form-input" style="width: 100%; padding: 16px 50px 16px 50px; border: 1px solid #e5e5ea; border-radius: 12px; font-size: 16px; transition: all 0.3s; background: #fff; color: #000;" placeholder="请输入密码" autocomplete="current-password" required>
                                    <i class="fas fa-eye password-toggle" id="toggle-login-password" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; font-size: 18px; transition: all 0.3s;"></i>
                                </div>
                            </div>

                            <div class="form-options" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; font-size: 14px;">
                                <label class="checkbox-wrapper remember-me">
                                    <input type="checkbox" id="rememberMe">
                                    <span class="checkmark"></span>
                                    <span>记住我</span>
                                </label>
                                <a href="#" id="forgot-password" class="forgot-password" style="color: #007aff; text-decoration: none; font-weight: 500; transition: all 0.3s;">忘记密码？</a>
                            </div>

                            <button type="submit" class="btn btn-primary" id="loginButton" style="width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; background: linear-gradient(135deg, #007aff 0%, #0057b7 100%); color: white; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);">
                                <span>登录</span>
                            </button>
                        </form>

                        <div class="register-link" style="text-align: center; margin-top: 32px; color: #999;">
                            还没有账号？<a href="#" id="showRegister" style="color: #007aff; text-decoration: none; font-weight: 600; transition: all 0.3s;">立即注册</a>
                        </div>
                    </div>

                    <div id="registerForm" class="form-content" style="display: none;">
                        <div class="form-header" style="text-align: center; margin-bottom: 40px;">
                            <h2 class="form-title" style="font-size: 32px; font-weight: 700; color: #000; margin-bottom: 10px;">创建账号</h2>
                            <p class="form-subtitle" style="color: #999; font-size: 16px;">开始使用我们的应用服务</p>
                        </div>

                        <form id="register-form">
                            <div class="form-group" style="margin-bottom: 24px; position: relative;">
                                <label class="form-label" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px;">用户名</label>
                                <div class="input-wrapper" style="position: relative;">
                                    <i class="fas fa-user input-icon" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #999; font-size: 18px;"></i>
                                    <input type="text" id="register-username" class="form-input" style="width: 100%; padding: 16px 20px 16px 50px; border: 1px solid #e5e5ea; border-radius: 12px; font-size: 16px; transition: all 0.3s; background: #fff; color: #000;" placeholder="请输入用户名" autocomplete="username" required>
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 24px; position: relative;">
                                <label class="form-label" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px;">邮箱</label>
                                <div class="input-wrapper" style="position: relative;">
                                    <i class="fas fa-envelope input-icon" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #999; font-size: 18px;"></i>
                                    <input type="email" id="register-email" class="form-input" style="width: 100%; padding: 16px 20px 16px 50px; border: 1px solid #e5e5ea; border-radius: 12px; font-size: 16px; transition: all 0.3s; background: #fff; color: #000;" placeholder="请输入您的邮箱" autocomplete="email" required>
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 24px; position: relative;">
                                <label class="form-label" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px;">密码</label>
                                <div class="input-wrapper" style="position: relative;">
                                    <i class="fas fa-lock input-icon" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #999; font-size: 18px;"></i>
                                    <input type="password" id="register-password" class="form-input" style="width: 100%; padding: 16px 50px 16px 50px; border: 1px solid #e5e5ea; border-radius: 12px; font-size: 16px; transition: all 0.3s; background: #fff; color: #000;" placeholder="请设置密码（至少6位）" autocomplete="new-password" minlength="6" required>
                                    <i class="fas fa-eye password-toggle" id="toggle-register-password" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; font-size: 18px; transition: all 0.3s;"></i>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" id="registerButton" style="width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; background: linear-gradient(135deg, #007aff 0%, #0057b7 100%); color: white; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);">
                                <span>注册</span>
                            </button>
                        </form>

                        <div class="register-link" style="text-align: center; margin-top: 32px; color: #999;">
                            已有账号？<a href="#" id="showLogin" style="color: #007aff; text-decoration: none; font-weight: 600; transition: all 0.3s;">立即登录</a>
                        </div>
                    </div>

                    <div id="forgotForm" class="form-content" style="display: none;">
                        <div class="form-header" style="text-align: center; margin-bottom: 40px;">
                            <h2 class="form-title" style="font-size: 32px; font-weight: 700; color: #000; margin-bottom: 10px;">重置密码</h2>
                            <p class="form-subtitle" style="color: #999; font-size: 16px;">请输入您的注册邮箱</p>
                        </div>

                        <form id="reset-form">
                            <div class="form-group" style="margin-bottom: 24px; position: relative;">
                                <label class="form-label" style="display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px;">邮箱</label>
                                <div class="input-wrapper" style="position: relative;">
                                    <i class="fas fa-envelope input-icon" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #999; font-size: 18px;"></i>
                                    <input type="email" id="reset-email" class="form-input" style="width: 100%; padding: 16px 20px 16px 50px; border: 1px solid #e5e5ea; border-radius: 12px; font-size: 16px; transition: all 0.3s; background: #fff; color: #000;" placeholder="请输入您的注册邮箱" autocomplete="email" required>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" id="resetPasswordButton" style="width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; background: linear-gradient(135deg, #007aff 0%, #0057b7 100%); color: white; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);">
                                <span>发送重置链接</span>
                            </button>
                        </form>

                        <div class="register-link" style="text-align: center; margin-top: 32px; color: #999;">
                            想起密码了？<a href="#" id="back-to-login" style="color: #007aff; text-decoration: none; font-weight: 600; transition: all 0.3s;">返回登录</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 全屏图片查看器 -->
    <div id="lightbox" class="fixed inset-0 z-[100] bg-slate-900/95 backdrop-blur hidden flex-col items-center justify-center p-4 transition-opacity duration-300 opacity-0" onclick="window.closeLightbox()">
        <button class="absolute top-6 right-6 text-white/70 hover:text-white p-2 rounded-full hover:bg-white/10 transition z-50">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <img id="lightbox-img" src="" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl scale-95 transition-transform duration-300 select-none" onclick="event.stopPropagation()">
        <p class="text-white/50 mt-6 text-sm font-mono select-none">点击背景区域关闭预览</p>
    </div>

    <!-- 自定义列模态框 -->
    <div id="columnModal" class="modal-backdrop" onclick="if(event.target === this) toggleColumnModal()">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 dark:border-slate-700 pb-3">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white">自定义显示列</h3>
                <button onclick="toggleColumnModal()" class="text-slate-400 hover:text-slate-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="grid grid-cols-2 gap-3" id="columnCheckboxes"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="resetColumns()" class="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-lg dark:hover:bg-slate-700 dark:text-slate-400 transition-colors">重置默认</button>
                <button onclick="saveColumns()" class="px-4 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-md transition-colors">保存设置</button>
            </div>
        </div>
    </div>

    <!-- 状态编辑弹窗 -->
    <div id="statusModal" class="modal-backdrop" onclick="if(event.target === this) closeStatusModal()">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 dark:border-slate-700 pb-3">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white">更新状态</h3>
                <button onclick="closeStatusModal()" class="text-slate-400 hover:text-slate-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <input type="hidden" id="statusEditId">
            <div class="space-y-3">
                <button onclick="updateStatus('待审核')" class="w-full text-left px-4 py-3 rounded-xl bg-slate-50 hover:bg-slate-100 text-slate-600 font-bold dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-300">待审核</button>
                <button onclick="updateStatus('处理中')" class="w-full text-left px-4 py-3 rounded-xl bg-blue-50 hover:bg-blue-100 text-blue-600 font-bold dark:bg-blue-900/30 dark:hover:bg-blue-900/50 dark:text-blue-400">处理中</button>
                <button onclick="updateStatus('等待赔付')" class="w-full text-left px-4 py-3 rounded-xl bg-amber-50 hover:bg-amber-100 text-amber-600 font-bold dark:bg-amber-900/30 dark:hover:bg-amber-900/50 dark:text-amber-400">等待赔付</button>
                <button onclick="updateStatus('已赔付')" class="w-full text-left px-4 py-3 rounded-xl bg-emerald-50 hover:bg-emerald-100 text-emerald-600 font-bold dark:bg-emerald-900/30 dark:hover:bg-emerald-900/50 dark:text-emerald-400">已赔付</button>
                <button onclick="updateStatus('已驳回')" class="w-full text-left px-4 py-3 rounded-xl bg-red-50 hover:bg-red-100 text-red-600 font-bold dark:bg-red-900/30 dark:hover:bg-red-900/50 dark:text-red-400">已驳回</button>
            </div>
        </div>
    </div>

    <!-- 物流官网弹窗 -->
    <div id="logisticsModal" class="modal-backdrop hidden" onclick="if(event.target === this) closeLogisticsModal()">
        <div class="logistics-modal-content">
            <div class="logistics-modal-header">
                <h3 id="logisticsModalTitle" class="text-lg font-bold text-slate-800 dark:text-white">物流官网</h3>
                <button onclick="closeLogisticsModal()" class="text-slate-400 hover:text-slate-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <iframe id="logisticsModalIframe" class="logistics-modal-iframe" src=""></iframe>
        </div>
    </div>

    <!-- 添加用户模态框 -->
    <div id="addUserModal" class="modal-backdrop" onclick="if(event.target === this) window.closeAddUserModal()">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 dark:border-slate-700 pb-3">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white">添加用户</h3>
                <button onclick="window.closeAddUserModal()" class="text-slate-400 hover:text-slate-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <form id="addUserForm" class="space-y-4">
                <div>
                    <label class="input-group-label"><span class="text-red-500 mr-1">*</span>用户名</label>
                    <input type="text" id="add-username" class="form-input w-full bg-white dark:bg-slate-700" placeholder="请输入用户名" required>
                    <div id="username-error" class="text-red-500 text-xs mt-1 hidden">用户名已存在</div>
                </div>
                <div>
                    <label class="input-group-label"><span class="text-red-500 mr-1">*</span>邮箱</label>
                    <input type="email" id="add-email" class="form-input w-full bg-white dark:bg-slate-700" placeholder="请输入邮箱" required>
                    <div id="email-error" class="text-red-500 text-xs mt-1 hidden">邮箱格式不正确或已存在</div>
                </div>
                <div>
                    <label class="input-group-label"><span class="text-red-500 mr-1">*</span>密码</label>
                    <input type="password" id="add-password" class="form-input w-full bg-white dark:bg-slate-700" placeholder="请输入密码（至少6位，包含字母和数字）" required>
                    <div id="password-error" class="text-red-500 text-xs mt-1 hidden">密码强度不足</div>
                </div>
                <div>
                    <label class="input-group-label">角色</label>
                    <select id="add-role" class="form-input w-full bg-white dark:bg-slate-700 cursor-pointer" onchange="window.togglePermissionPanel()">
                        <option value="user">普通用户</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
                
                <!-- 权限面板 -->
                <div id="permission-panel" class="bg-slate-50 dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">权限配置</h4>
                    <div id="permission-checkboxes" class="grid grid-cols-2 gap-3"></div>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-slate-700">
                    <button type="button" onclick="window.closeAddUserModal()" class="px-6 py-2.5 text-slate-500 font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-700 dark:hover:text-slate-200 rounded-xl transition-colors">取消</button>
                    <button type="submit" class="px-8 py-2.5 bg-blue-600 text-white font-bold text-sm rounded-xl hover:bg-blue-700 hover:shadow-lg hover:shadow-blue-200 transition-all transform active:scale-95">
                        立即添加
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 编辑公告模态框 -->
    <div id="editNoticeModal" class="modal-backdrop">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 dark:border-slate-700 pb-3">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white">编辑公告</h3>
                <button onclick="window.closeEditNoticeModal()" class="text-slate-400 hover:text-slate-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <form id="editNoticeForm" class="space-y-4">
                <!-- 隐藏的公告ID -->
                <input type="hidden" id="edit-notice-id">
                
                <!-- 标题输入 -->
                <div>
                    <label class="input-group-label"><span class="text-red-500 mr-1">*</span>公告标题：</label>
                    <input type="text" id="edit-notice-title" class="form-input bg-white dark:bg-slate-700" required>
                </div>
                
                <!-- 内容输入 -->
                <div>
                    <label class="input-group-label"><span class="text-red-500 mr-1">*</span>公告内容：</label>
                    <textarea id="edit-notice-content" rows="4" class="form-textarea bg-white dark:bg-slate-700" required></textarea>
                </div>
                
                <!-- 图片上传 -->
                <div>
                    <label class="input-group-label">公告图片：</label>
                    <div id="edit-upload-zone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition-colors" onclick="document.getElementById('edit-notice-file').click()">
                        <input type="file" id="edit-notice-file" accept="image/*" class="hidden" onchange="window.handleEditFileSelect(this)">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="w-10 h-10 text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <p id="edit-file-name-display" class="text-sm text-slate-500 dark:text-slate-400">支持 JPG, PNG, GIF 格式</p>
                            <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">点击或拖拽图片到此处上传</p>
                        </div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-slate-700">
                    <button type="button" onclick="window.closeEditNoticeModal()" class="px-6 py-2.5 text-slate-500 font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-700 dark:hover:text-slate-200 rounded-xl transition-colors">取消</button>
                    <button type="button" onclick="window.saveNoticeChanges()" class="px-8 py-2.5 bg-blue-600 text-white font-bold text-sm rounded-xl hover:bg-blue-700 hover:shadow-lg hover:shadow-blue-200 transition-all transform active:scale-95">
                        保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 侧边栏 -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 z-40 transition-transform duration-300 flex flex-col">
        <!-- Logo -->
        <div class="h-20 flex items-center px-6 border-b border-slate-100 dark:border-slate-800 shrink-0">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-3 shadow-lg shadow-blue-200 dark:shadow-none">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            </div>
            <span id="system-title-secondary" class="text-lg font-black text-slate-800 dark:text-white tracking-tight">海外仓索赔管理系统 <span class="text-sm font-normal opacity-75">v2.5.1</span></span>
        </div>
        <!-- 用户信息 (已修改：支持角色标签和真实数据) -->
        <div id="user-info" class="hidden p-4 border-b border-slate-100 dark:border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center shrink-0">
                    <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                </div>
                <div class="overflow-hidden">
                    <div class="flex items-center gap-2 mb-0.5">
                        <div id="user-name" class="text-sm font-bold text-slate-800 dark:text-white truncate">用户</div>
                        <span id="user-role-label" class="text-[10px] px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 font-medium whitespace-nowrap">
                            成员账号
                        </span>
                    </div>
                    <div id="user-email" class="text-xs text-slate-500 dark:text-slate-400 truncate">email@example.com</div>
                </div>
            </div>
        </div>

        <!-- 菜单 -->
        <nav class="p-4 space-y-2 flex-1 overflow-y-auto">
            <div onclick="switchView('form')" id="nav-form" class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all cursor-pointer dark:text-slate-400 dark:hover:bg-slate-800">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <span>填写登记</span>
            </div>
            <div onclick="switchView('data')" id="nav-data" class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all cursor-pointer dark:text-slate-400 dark:hover:bg-slate-800">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                <span>数据列表</span>
            </div>
            <div onclick="switchView('kanban')" id="nav-kanban" class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all cursor-pointer dark:text-slate-400 dark:hover:bg-slate-800">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path></svg>
                <span>看板视图</span>
            </div>
            <!-- 公告中心 -->
            <div onclick="switchView('notice')" id="nav-notice" class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all cursor-pointer dark:text-slate-400 dark:hover:bg-slate-800">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                <span>公告中心</span>
            </div>
            <!-- 用户管理 -->
            <div onclick="switchView('users')" id="nav-users" class="hidden flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all cursor-pointer dark:text-slate-400 dark:hover:bg-slate-800">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <span>用户管理</span>
</div>
            <!-- 用户登录监控系统 -->
            <div onclick="switchView('login-monitor')" id="nav-login-monitor" class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all cursor-pointer dark:text-slate-400 dark:hover:bg-slate-800">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span>登录监控</span>
            </div>
        </nav>

        <!-- 底部工具 -->
        <div class="p-4 border-t border-slate-100 dark:border-slate-800 space-y-2">
            <button onclick="toggleDarkMode()" class="flex items-center gap-3 w-full px-4 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 transition-all dark:text-slate-400 dark:hover:bg-slate-800 group">
                <svg id="sunIcon" class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <span class="group-hover:text-slate-800 dark:group-hover:text-white transition-colors">切换模式</span>
            </button>
            <button onclick="handleLogout()" class="flex items-center gap-3 w-full px-4 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 transition-all dark:text-slate-400 dark:hover:bg-slate-800 group">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                <span class="group-hover:text-slate-800 dark:group-hover:text-white transition-colors">退出登录</span>
            </button>
        </div>
    </aside>

    <!-- 主内容区 -->
    <main class="ml-64 p-6 w-full min-h-screen">
        
        <!-- 视图一：填写登记 -->
        <section id="view-form" class="space-y-6 animate-fade-up">
            <div class="glass-card overflow-hidden">
                <div class="p-4 border-b border-slate-100 dark:border-slate-700">
                    <h2 class="text-xl font-bold text-slate-800 dark:text-white">新建索赔申请</h2>
                </div>
                <form id="claimForm" class="p-4 md:p-6 space-y-5" oninput="markFormDirty()">
                    
                    <!-- 1. 客户信息 -->
                    <div class="form-section section-customer">
                        <h3 class="section-title flex items-center gap-2 text-lg font-extrabold text-slate-800 dark:text-white">
                            <svg class="section-title-icon w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span>客户信息</span>
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>客户名称 (公司全称)：</label><input type="text" id="cust_name" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" value="深圳市信凯源科技有限公司" required></div>
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>联系人：</label><input type="text" id="contact_name" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" value="沈学章" required></div>
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>联系方式：</label><input type="text" id="contact_info" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" value="shenxz1989@foxmail.com" required></div>
                        </div>
                    </div>

                    <!-- 2. 订单信息 -->
                    <div class="form-section section-order">
                        <h3 class="section-title flex items-center gap-2 text-lg font-extrabold text-slate-800 dark:text-white">
                            <svg class="section-title-icon w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>订单信息</span>
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>所属店铺：</label><select id="store_by" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" required><option value="">请选择</option><option value="XKY">XKY</option><option value="SZ POWCHO【SHEIN】">SZ POWCHO【SHEIN】</option><option value="CRQ">CRQ</option><option value="TEMU Love pin local【XKY】">TEMU Love pin local【XKY】</option><option value="Your love local">Your love local</option><option value="TEMU（Domiciliary local）KDM">TEMU（Domiciliary local）KDM</option><option value="TEMU（Electronically local）KDM">TEMU（Electronically local）KDM</option><option value="CRRQ">CRRQ</option><option value="美半包2店">美半包2店</option><option value="美半包1店">美半包1店</option></select></div>
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>海外仓单号（OBS出库号）：</label><input type="text" id="order_no" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" required placeholder="系统生成的唯一单号(领星ERP-运单号)"></div>
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>物流运单号：</label><input type="text" id="tracking_no" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" required placeholder="头程/尾程物流单号"></div>
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>发货日期：</label><input type="date" id="ship_date" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" required></div>
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>订单 SKU：</label><input type="text" id="sku" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" required placeholder="货物发货SKU"></div>
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>发货仓：</label><select id="warehouse" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" required><option value="美西-4仓">美西-4仓</option><option value="美西-2仓">美西-2仓</option><option value="美东-4仓">美东-4仓</option><option value="美西-1仓">美西-1仓</option></select></div>
                        </div>
                    </div>

                    <!-- 3. 索赔详情 -->
                    <div class="form-section section-claim">
                        <h3 class="section-title flex items-center gap-2 text-lg font-extrabold text-slate-800 dark:text-white">
                            <svg class="section-title-icon w-5 h-5 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <span>索赔详情</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>索赔类型：</label><select id="claim_type" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600 cursor-pointer"><option>货物损坏</option><option>丢失</option><option>延误</option><option>库存不符</option><option>错发</option><option>发货数量不符</option></select></div>
                            <div><label class="input-group-label">责任方判定：</label><select id="liable_party" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600 cursor-pointer"><option>待核实</option><option>海外仓责任</option><option>物流商责任</option><option>客户责任</option></select></div>
                            <div class="md:col-span-2">
                                <label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>问题描述：</label>
                                <textarea id="description" rows="2" class="form-textarea bg-white dark:bg-slate-700 dark:border-slate-600 resize" placeholder="详细说明异常情况（如损坏程度、延误天数等）" required></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 4. 赔偿计算 -->
                    <div class="form-section section-compensation">
                        <h3 class="section-title flex items-center gap-2 text-lg font-extrabold text-slate-800 dark:text-white">
                            <svg class="section-title-icon w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <span>赔偿计算</span>
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <div><label class="input-group-label">赔偿币种：</label><select id="currency" class="form-input dark:bg-slate-700 dark:border-slate-600 cursor-pointer bg-white"><option value="USD">USD ($)</option><option value="EUR">EUR (€)</option><option value="GBP">GBP (£)</option><option value="CNY">CNY (¥)</option></select></div>
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>货物声明价值：</label><input type="number" id="val_amount" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" step="0.01" required placeholder="商品采购价或投保价值"></div>
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>索赔数量：</label><input type="number" id="claim_qty" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" required placeholder="需赔付的商品数量"></div>
                            <div><label class="input-group-label">赔偿比例 (%)：</label><input type="number" id="claim_ratio" class="form-input bg-white dark:bg-slate-700 dark:border-slate-600" value="100" required></div>
                            <div><label class="input-group-label"><span class="text-red-600 font-extrabold mr-1">*</span>总赔偿金额：</label><input type="number" id="claim_total" class="form-input text-emerald-700 font-black text-lg bg-white dark:bg-slate-700 dark:border-slate-600" step="0.01" required placeholder="最高赔偿100USD"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- 证明资料卡片 -->
                        <div class="glass-card p-4 border border-slate-100 dark:border-slate-700 hover:shadow-lg transition-shadow">
                            <h3 class="text-sm font-bold text-slate-800 dark:text-white mb-3">证明资料</h3>
                            <label class="input-group-label">附件清单：</label>
                            <textarea id="attachments" rows="10" class="form-textarea bg-slate-50 dark:bg-slate-700 dark:border-slate-600" placeholder="上传图片/视频/物流凭证（用超链接或标注存储路径）"></textarea>
                        </div>

                        <!-- 截图超链接工具模块 -->
                        <div class="glass-card p-4 border border-slate-100 dark:border-slate-700 hover:shadow-lg transition-shadow">
                            <h3 class="text-sm font-bold text-slate-800 dark:text-white mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                截图超链接工具
                            </h3>
                            
                            <!-- 文件选择 -->
                            <div class="mb-3">
                                <input type="file" id="imageFileInput" accept="image/*" multiple style="display: none;" onchange="updateImageFileLabel()">
                                <div class="flex gap-2">
                                    <div id="imageDropZone" class="flex-1 px-3 py-2 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-800 hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors cursor-pointer flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4 text-slate-500 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <span class="text-xs text-slate-600 dark:text-slate-300 font-medium">拖拽或粘贴</span>
                                    </div>
                                    <button type="button" onclick="document.getElementById('imageFileInput').click()" class="flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        选择图片
                                    </button>
                                </div>
                                <div id="imageFileInfo" class="text-xs text-slate-400 dark:text-slate-500 mt-1.5">未选择文件</div>
                            </div>

                            <!-- 操作按钮组 -->
                            <div class="space-y-2 mb-3">
                                <div class="flex gap-2">
                                    <button type="button" id="imageUploadBtn" onclick="uploadImagesToGitHub()" class="flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        批量上传
                                    </button>
                                    <button type="button" onclick="resetImageUpload(event)" class="flex-1 px-3 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 text-sm font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        重置
                                    </button>
                                </div>
                                <button type="button" onclick="fillImageLinksToAttachments()" class="w-full px-3 py-2 border border-blue-600 dark:border-blue-500 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 text-sm font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    一键填入
                                </button>
                            </div>

                            <!-- 结果显示 -->
                            <div class="mb-3">
                                <label class="input-group-label text-xs">图片直链结果：</label>
                                <textarea id="imageResultLink" rows="3" class="form-textarea bg-white dark:bg-slate-700 dark:border-slate-600 font-mono text-xs" placeholder="上传成功后在此显示链接..." readonly></textarea>
                            </div>

                            <!-- 状态显示 -->
                            <div id="imageUploadStatus" class="text-xs max-h-32 overflow-y-auto custom-scrollbar p-2 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700"></div>
                        </div>

                        <!-- 处理进度卡片 -->
                        <div class="glass-card p-4 border border-slate-100 dark:border-slate-700 hover:shadow-lg transition-shadow">
                            <h3 class="text-sm font-bold text-slate-800 dark:text-white mb-3">处理进度</h3>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div><label class="input-group-label">申请提交日期：</label><input type="date" id="entry_date" class="form-input bg-slate-200 dark:bg-slate-700 dark:border-slate-600" readonly></div>
                                    <div><label class="input-group-label">处理状态：</label><select id="process_status" class="form-input bg-slate-50 font-bold text-blue-600 dark:text-blue-400 dark:bg-slate-700 dark:border-slate-600 cursor-pointer"><option value="待审核">待审核</option><option value="处理中">处理中</option><option value="等待赔付">等待赔付</option><option value="已赔付">已赔付</option><option value="已驳回">已驳回</option></select></div>
                                </div>
                                <div><label class="input-group-label">备注：</label><input type="text" id="remarks" class="form-input bg-slate-50 dark:bg-slate-700 dark:border-slate-600" placeholder="海外仓填写，客户不填"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pt-3 flex gap-3">
                        <button type="button" id="submitBtn" onclick="processEntry()" class="btn-primary flex-[2]"><span id="submitBtnText">确认提交并保存</span></button>
                        <button type="button" id="cancelEditBtn" onclick="cancelEditMode()" class="btn-secondary hidden flex-1">取消修改</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- 视图二：数据列表 -->
        <section id="view-data" class="hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 animate-fade-up">
                <!-- 统计卡片 -->
                <div class="glass-card p-5 flex flex-col justify-center gap-4 lg:col-span-1">
                    <div class="flex items-center justify-between border-b border-slate-100 dark:border-slate-700 pb-4">
                        <div><p class="text-xs font-bold text-slate-400 uppercase">当前列表单数</p><p id="count_text" class="text-2xl font-black text-slate-800 dark:text-white mt-1">0</p></div>
                        <div class="p-3 bg-blue-50 text-blue-600 rounded-xl dark:bg-blue-900/30 dark:text-blue-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg></div>
                    </div>
                    <div><p class="text-xs font-bold text-slate-400 uppercase">当前列表金额 (折合USD)</p><p id="money_text" class="text-2xl font-black text-emerald-500 mt-1">$0.00</p></div>
                </div>

                <!-- 类型分布 -->
                <div class="glass-card p-4 relative lg:col-span-1 flex flex-col items-center justify-center">
                    <h4 class="absolute top-4 left-4 text-xs font-bold text-slate-400 uppercase">类型分布</h4>
                    <div class="h-32 w-full mt-4"><canvas id="pieChart"></canvas></div>
                </div>

                <!-- 趋势图 -->
                <div class="glass-card p-4 relative lg:col-span-2 flex flex-col justify-center">
                    <h4 class="absolute top-4 left-4 text-xs font-bold text-slate-400 uppercase">近6个月金额趋势</h4>
                    <div class="h-32 w-full mt-4"><canvas id="lineChart" style="display: block; box-sizing: border-box;"></canvas></div>
                </div>
            </div>

            <header id="top-bar" class="flex flex-col xl:flex-row gap-4 justify-between items-start xl:items-center bg-white dark:bg-slate-800 p-3 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                <div class="flex gap-2">
                    <button onclick="copyToWeChat()" class="h-12 px-5 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all duration-200 flex items-center gap-2 text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white font-medium text-sm group">
                        <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24"><path d="M8.5,13.5A1.5,1.5 0 1,1 10,12A1.5,1.5 0 0,1 8.5,13.5M15.5,13.5A1.5,1.5 0 1,1 17,12A1.5,1.5 0 0,1 15.5,13.5M12,2C6.48,2 2,5.58 2,10C2,12.63 3.65,14.95 6.18,16.29C6.03,17.29 5.67,19.34 5.67,19.34C5.67,19.34 7.67,19.12 9.77,17.65C10.5,17.88 11.24,18 12,18C17.52,18 22,14.42 22,10C22,5.58 17.52,2 12,2Z"/></svg>
                        复制微信格式
                    </button>
                    <button 
                        onclick="openSubmitFormModal()"
                        class="h-12 px-5 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all duration-200 flex items-center gap-2 text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white font-medium text-sm group"
                    >
                        <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        提交表格
                    </button>
                    <button onclick="exportFilteredData()" class="h-12 px-5 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all duration-200 flex items-center gap-2 text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white font-medium text-sm group">
                        <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                        导出全量数据
                    </button>
                    <button onclick="downloadImportTemplate()" class="h-12 px-5 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all duration-200 flex items-center gap-2 text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white font-medium text-sm group">
                        <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        下载格式范本
                    </button>
                    <label for="importFileInput" class="h-12 px-5 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all duration-200 flex items-center gap-2 text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white font-medium text-sm group cursor-pointer">
                        <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        导入数据
                    </label>
                    <input type="file" id="importFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleImportFile(event)">
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-slate-700 dark:text-slate-300 whitespace-nowrap">海外物流查询官网：</span>
                    <button onclick="openLogisticsModal('GOFO')" class="h-10 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-bold flex-shrink-0">
                        GOFO
                    </button>
                    <button onclick="openLogisticsModal('UNINI')" class="h-10 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-bold flex-shrink-0">
                        UNINI
                    </button>
                    <button onclick="openLogisticsModal('USPS')" class="h-10 px-4 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 transition text-sm font-bold flex-shrink-0">
                        USPS
                    </button>
                </div>
            </header>

            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden mt-4 transition-all">
                <div class="p-2 md:p-3 flex flex-col gap-3 md:gap-4 border-b border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-2 md:gap-3 flex-wrap">
                        <div class="flex flex-wrap gap-2 shrink-0">
                            <button 
                                onclick="switchSubTab('all')" 
                                id="tab-all" 
                                class="filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-blue-500 text-white hover:bg-blue-600" 
                                data-status="all"
                            >
                                全部 <span id="count-all" class="ml-1 opacity-75">(0)</span>
                            </button>
                            <button 
                                onclick="switchSubTab('待审核')" 
                                id="tab-pending" 
                                class="filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600" 
                                data-status="待审核"
                            >
                                待审核 <span id="count-pending" class="ml-1 opacity-75">(0)</span>
                            </button>
                            <button 
                                onclick="switchSubTab('处理中')" 
                                id="tab-processing" 
                                class="filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600" 
                                data-status="处理中"
                            >
                                处理中 <span id="count-processing" class="ml-1 opacity-75">(0)</span>
                            </button>
                            <button 
                                onclick="switchSubTab('等待赔付')" 
                                id="tab-waiting" 
                                class="filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600" 
                                data-status="等待赔付"
                            >
                                等待赔付 <span id="count-waiting" class="ml-1 opacity-75">(0)</span>
                            </button>
                            <button 
                                onclick="switchSubTab('已赔付')" 
                                id="tab-paid" 
                                class="filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600" 
                                data-status="已赔付"
                            >
                                已赔付 <span id="count-paid" class="ml-1 opacity-75">(0)</span>
                            </button>
                            <button 
                                onclick="switchSubTab('已驳回')" 
                                id="tab-rejected" 
                                class="filter-btn px-3 py-1.5 rounded-lg text-sm transition-colors bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600" 
                                data-status="已驳回"
                            >
                                已驳回 <span id="count-rejected" class="ml-1 opacity-75">(0)</span>
                            </button>
                        </div>
                        
                        <div class="bg-blue-500 dark:bg-blue-600 p-1.5 rounded-lg shadow-md shrink-0">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        
                        <div class="relative flex-1 group min-w-0" style="min-width: 200px; max-width: 400px;">
                            <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 dark:text-slate-500 group-focus-within:text-blue-500 dark:group-focus-within:text-blue-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input 
                                id="quickSearch"
                                type="text"
                                placeholder="搜索：海外仓单号、物流运单号、订单SKU"
                                class="w-full pl-9 pr-20 py-1.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white dark:focus:bg-slate-700 outline-none transition-all text-sm text-slate-900 dark:text-slate-100 placeholder:text-slate-400 dark:placeholder:text-slate-500"
                            >
                            <select id="searchModeSelect" class="absolute right-2 top-1/2 -translate-y-1/2 px-2 py-1 bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded text-xs font-semibold text-slate-700 dark:text-slate-200 cursor-pointer focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <option value="fuzzy">模糊</option>
                                <option value="exact">精准</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center gap-2 shrink-0">
                            <button onclick="handleQuickSearch()" class="bg-blue-500 dark:bg-blue-600 hover:bg-blue-600 dark:hover:bg-blue-700 text-white px-4 py-1.5 rounded-lg font-semibold text-sm transition-all shadow-md active:scale-95 whitespace-nowrap">
                                搜索
                            </button>
                            
                            <button type="button" onclick="handleResetFilters()" class="flex items-center justify-center gap-1.5 px-4 py-1.5 border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 rounded-lg text-sm font-semibold hover:bg-slate-50 dark:hover:bg-slate-700 transition-all whitespace-nowrap">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                重置条件
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-2 lg:gap-2">
                        <select id="quickFilterStoreBy" class="px-2.5 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm cursor-pointer text-slate-900 dark:text-slate-100 h-9 min-w-[140px]">
                            <option value="">全部店铺</option>
                            <option value="XKY">XKY</option>
                            <option value="SZ POWCHO【SHEIN】">SZ POWCHO【SHEIN】</option>
                            <option value="CRQ">CRQ</option>
                            <option value="TEMU Love pin local【XKY】">TEMU Love pin local【XKY】</option>
                            <option value="Your love local">Your love local</option>
                            <option value="TEMU（Domiciliary local）KDM">TEMU（Domiciliary local）KDM</option>
                            <option value="TEMU（Electronically local）KDM">TEMU（Electronically local）KDM</option>
                            <option value="CRRQ">CRRQ</option>
                            <option value="美半包2店">美半包2店</option>
                            <option value="美半包1店">美半包1店</option>
                        </select>
                        
                        <select id="quickFilterWarehouse" class="px-2.5 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm cursor-pointer text-slate-900 dark:text-slate-100 h-9 min-w-[100px]">
                            <option value="">全部仓库</option>
                            <option value="美西-4仓">美西-4仓</option>
                            <option value="美西-2仓">美西-2仓</option>
                            <option value="美东-4仓">美东-4仓</option>
                            <option value="美西-1仓">美西-1仓</option>
                        </select>
                        
                        <select id="quickFilterClaimType" class="px-2.5 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm cursor-pointer text-slate-900 dark:text-slate-100 h-9 min-w-[120px]">
                            <option value="">全部类型</option>
                            <option value="货物损坏">货物损坏</option>
                            <option value="丢失">丢失</option>
                            <option value="延误">延误</option>
                            <option value="库存不符">库存不符</option>
                            <option value="错发">错发</option>
                            <option value="发货数量不符">发货数量不符</option>
                        </select>
                        
                        <div class="flex items-center gap-1 flex-wrap">
                            <span class="text-xs text-slate-600 dark:text-slate-300 whitespace-nowrap">发货日期：</span>
                            <input id="quickFilterShipDateStart" type="date" class="px-2 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm text-slate-900 dark:text-slate-100 h-9 w-28 sm:w-32">
                            <span class="text-xs text-slate-500 dark:text-slate-400">至</span>
                            <input id="quickFilterShipDateEnd" type="date" class="px-2 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm text-slate-900 dark:text-slate-100 h-9 w-28 sm:w-32">
                        </div>
                        
                        <div class="flex items-center gap-1 flex-wrap">
                            <span class="text-xs text-slate-600 dark:text-slate-300 whitespace-nowrap">申请日期：</span>
                            <input id="quickFilterEntryDateStart" type="date" class="px-2 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm text-slate-900 dark:text-slate-100 h-9 w-28 sm:w-32">
                            <span class="text-xs text-slate-500 dark:text-slate-400">至</span>
                            <input id="quickFilterEntryDateEnd" type="date" class="px-2 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm text-slate-900 dark:text-slate-100 h-9 w-28 sm:w-32">
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card flex-1 flex flex-col overflow-hidden min-h-[500px]">
                <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200">明细列表</h3>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-1">
                            <div id="dbStatusIndicator" class="w-2.5 h-2.5 rounded-full bg-green-500 animate-ping relative">
                                <div class="absolute top-0 left-0 w-full h-full rounded-full bg-green-500 opacity-75"></div>
                            </div>
                            <span class="text-xs text-slate-400">数据库连接状态</span>
                        </div>
                        
                        <button id="refreshBtn" onclick="refreshDatabase()" class="px-3 py-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded text-sm font-bold text-slate-700 dark:text-slate-200 shadow-sm hover:border-blue-500 dark:hover:border-blue-400 transition-all flex items-center gap-1">
                            <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            刷新
                        </button>
                        
                        <button onclick="toggleColumnModal()" class="text-sm text-blue-600 font-bold hover:underline">自定义列</button>
                    </div>
                </div>
                <div class="table-container overflow-x-auto custom-scrollbar flex-1 relative pb-24">
                    <table class="w-full text-left border-collapse" id="dataTable">
                        <thead class="bg-slate-50 dark:bg-slate-900"><tr id="tableHeaderRow"></tr></thead>
                        <tbody id="dbContent" class="bg-white dark:bg-slate-800 divide-y divide-slate-50 dark:divide-slate-700"></tbody>
                    </table>
                    <div id="emptyState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-slate-300 dark:text-slate-600"><span class="font-bold text-sm">暂无数据</span></div>
                </div>
                <div id="pagination-container"></div>
            </div>
            
            <!-- 批量操作工具栏 -->
            <div id="batch-action-bar" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 shadow-lg transform transition-transform duration-300 translate-y-full z-40" style="display: none;">
                <div class="container mx-auto px-4 py-3">
                    <div class="flex items-center justify-between gap-4 flex-wrap">
                        <!-- 选择信息 -->
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-bold text-slate-700 dark:text-slate-300">
                                已选择 <span id="selected-count" class="text-blue-600 dark:text-blue-400">0</span> 项
                            </span>
                            <button onclick="clearSelection()" class="text-xs text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 underline">
                                清除选择
                            </button>
                        </div>
                        
                        <!-- 操作按钮组 -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <!-- 状态选择下拉框和批量修改状态按钮 -->
                            <div class="flex items-center gap-2">
                                <select id="bulk-status-select" class="form-input bg-slate-50 text-slate-800 dark:bg-slate-700 dark:text-white border border-slate-200 dark:border-slate-600 rounded-md px-2.5 py-1.5 text-xs">
                                    <option value="">选择状态</option>
                                    <option value="待审核">待审核</option>
                                    <option value="处理中">处理中</option>
                                    <option value="等待赔付">等待赔付</option>
                                    <option value="已赔付">已赔付</option>
                                    <option value="已驳回">已驳回</option>
                                </select>
                                <button id="batch-update-status-btn" onclick="batchUpdateStatusFromSelect()" class="px-4 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-xs font-medium transition-all hover:scale-105 whitespace-nowrap">
                                    批量修改状态
                                </button>
                            </div>
                            
                            <!-- 导出选中按钮 -->
                            <button id="batch-export-btn" onclick="batchExportSelected()" class="px-4 py-1.5 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 text-xs font-medium transition-all hover:scale-105 whitespace-nowrap">
                                导出选中
                            </button>
                            
                            <!-- 批量删除按钮 -->
                            <button id="batch-delete-btn" onclick="batchDelete()" class="px-4 py-1.5 bg-red-600 text-white rounded-md hover:bg-red-700 text-xs font-medium transition-all hover:scale-105 whitespace-nowrap">
                                批量删除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
    <!-- 编辑弹窗模态框 -->
    <div id="editModalBackdrop" class="edit-modal-backdrop hidden">
        <div class="edit-modal-content">
            <!-- 卡片头部 -->
            <div class="edit-modal-header">
                <h2 class="edit-modal-title">编辑索赔申请</h2>
                <button id="editModalCloseBtn" class="edit-modal-close-btn" aria-label="关闭">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- 卡片内容区（可滚动） -->
            <div class="edit-modal-body">
                <form id="editClaimForm" class="edit-form">
                    <!-- 信息分组卡片将通过 JavaScript 动态生成 -->
                    <div id="editFormSections"></div>
                </form>
            </div>
            
            <!-- 卡片底部 -->
            <div class="edit-modal-footer">
                <button id="editModalCancelBtn" class="edit-btn-cancel">取消</button>
                <button id="editModalSubmitBtn" class="edit-btn-submit">确认修改</button>
            </div>
        </div>
    </div>

    <!-- 数据冲突解决对话框 -->
    <div id="conflictModalBackdrop" class="modal-backdrop hidden">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 dark:border-slate-700 pb-3">
                <h3 class="text-lg font-bold text-red-600 dark:text-red-400">⚠️ 数据冲突检测</h3>
                <button onclick="closeConflictDialog()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <p class="text-sm text-slate-600 dark:text-slate-400">
                    检测到数据已被其他用户修改，请选择如何处理：
                </p>
                <div id="conflictFieldsList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-slate-700">
                    <button onclick="closeConflictDialog()" class="px-6 py-2.5 text-slate-500 font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-colors">取消</button>
                    <button onclick="resolveConflict('useCurrent')" class="px-6 py-2.5 bg-blue-600 text-white font-bold text-sm rounded-xl hover:bg-blue-700 transition-colors">使用服务器版本</button>
                    <button onclick="resolveConflict('useMine')" class="px-6 py-2.5 bg-emerald-600 text-white font-bold text-sm rounded-xl hover:bg-emerald-700 transition-colors">使用我的版本</button>
                </div>
            </div>
        </div>
    </div>

            <!-- 提交表格弹窗模态框 -->
            <!-- 注意：此弹窗内嵌腾讯文档iframe，iframe内部会输出Aegis监控日志到控制台，这是正常现象，不影响功能 -->
            <div id="submitFormModalBackdrop" class="submit-form-modal-backdrop hidden">
                <div class="edit-modal-content">
                    <!-- 卡片头部 -->
                    <div class="edit-modal-header">
                        <div class="flex items-center gap-3 flex-1">
                            <h2 class="edit-modal-title">提交表格</h2>
                            <!-- 选中数据信息显示区域（可复制） -->
                            <div id="submitFormSelectedInfo" class="flex flex-col gap-2 px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm hidden">
                                <!-- 第一行：基础信息 -->
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="text-slate-600 dark:text-slate-300">海外仓单号：</span>
                                    <span id="selectedOrderNo" class="font-semibold text-slate-900 dark:text-slate-100">-</span>
                                    <button id="copyOrderNoBtn" class="ml-1 p-0.5 text-slate-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" title="复制海外仓单号">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                    </button>
                                    <span class="text-slate-400 dark:text-slate-500">|</span>
                                    <span class="text-slate-600 dark:text-slate-300">索赔类型：</span>
                                    <span id="selectedClaimType" class="font-semibold text-slate-900 dark:text-slate-100">-</span>
                                    <span class="text-slate-400 dark:text-slate-500">|</span>
                                    <span class="text-slate-600 dark:text-slate-300">总赔偿金额：</span>
                                    <span id="selectedClaimTotal" class="font-semibold text-slate-900 dark:text-slate-100">-</span>
                                </div>
                                <!-- 第二行：固定信息和计算字段 -->
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="text-slate-600 dark:text-slate-300">客户代码：</span>
                                    <span class="font-semibold text-slate-900 dark:text-slate-100">1535172</span>
                                    <button id="copyCustomerCodeBtn" class="ml-1 p-0.5 text-slate-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" title="复制客户代码">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                    </button>
                                    <span class="text-slate-400 dark:text-slate-500">|</span>
                                    <span class="text-slate-600 dark:text-slate-300">公司名称：</span>
                                    <span class="font-semibold text-slate-900 dark:text-slate-100">深圳市信凯源科技有限公司</span>
                                    <button id="copyCompanyNameBtn" class="ml-1 p-0.5 text-slate-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" title="复制公司名称">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                    </button>
                                    <span class="text-slate-400 dark:text-slate-500">|</span>
                                    <span class="text-slate-600 dark:text-slate-300">USD汇率：</span>
                                    <input type="number" id="usdExchangeRate" step="0.01" min="0" placeholder="请输入汇率" class="w-20 px-2 py-0.5 border border-slate-300 dark:border-slate-600 rounded text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500" value="">
                                    <span class="text-slate-400 dark:text-slate-500">|</span>
                                    <span class="text-slate-600 dark:text-slate-300">索赔金额(￥)：</span>
                                    <span id="calculatedClaimAmount" class="font-semibold text-slate-900 dark:text-slate-100">-</span>
                                    <button id="copyClaimAmountBtn" class="ml-1 p-0.5 text-slate-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" title="复制索赔金额">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="submitFormAutoBtn" class="submit-form-header-btn">自动化操作</button>
                            <button id="submitFormModalCloseBtn" class="edit-modal-close-btn" aria-label="关闭">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 卡片内容区（iframe容器） -->
                    <div class="submit-form-modal-body">
                        <iframe 
                            id="submitFormIframe"
                            src="https://doc.weixin.qq.com/forms/AN4AngdQAEkAYMACwYrAGkCN6dB6Pb9cf"
                            frameborder="0"
                            class="submit-form-iframe"
                            allow="clipboard-read; clipboard-write"
                            sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"
                            title="提交表格表单"
                        ></iframe>
                    </div>
                </div>
            </div>
        </section>

        <!-- 视图三：看板视图 -->
        <section id="view-kanban" class="hidden h-full overflow-hidden flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-slate-800 dark:text-white">进度看板</h2>
                <div class="flex gap-2">
                    <button onclick="switchSubTab('all')" class="px-3 py-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded text-sm font-bold text-slate-700 dark:text-slate-200 shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">刷新</button>
                </div>
            </div>
            <div class="flex gap-4 overflow-x-auto h-[calc(100vh-140px)] pb-4 items-start" id="kanban-container"></div>
        </section>
        
        <!-- 视图四：公告中心 -->
        <section id="view-notice" class="hidden h-full overflow-y-auto custom-scrollbar">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-2xl font-black text-slate-800 dark:text-white tracking-tight">公告中心</h1>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1 font-medium">发布政策更新与重要通知</p>
                    </div>
                    <button onclick="window.togglePublisher()" class="flex items-center gap-2 px-5 py-2.5 bg-slate-800 dark:bg-slate-700 text-white text-sm font-bold rounded-xl hover:bg-black dark:hover:bg-slate-600 transition shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 group">
                        <span class="bg-white/20 p-1 rounded-md group-hover:rotate-90 transition-transform duration-300">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
                        </span>
                        发布新公告
                    </button>
                </div>

                <div id="publisher" class="hidden mb-10 fade-in-down">
                    <div class="glass-card p-1 bg-white dark:bg-slate-800 shadow-2xl ring-1 ring-slate-100/50 dark:ring-slate-700/50">
                        <div class="bg-white dark:bg-slate-800 rounded-xl p-8">
                            <div class="flex justify-between items-center mb-8 border-b border-slate-50 dark:border-slate-700 pb-4">
                                <h3 class="text-base font-black text-slate-800 dark:text-white flex items-center gap-2">
                                    <span class="w-2.5 h-2.5 bg-blue-600 rounded-full shadow-lg shadow-blue-300"></span> 
                                    撰写公告
                                </h3>
                                <button onclick="window.togglePublisher()" class="group text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded-full transition-all">
                                    <svg class="w-6 h-6 transition-transform group-hover:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <svg class="w-5 h-5 text-slate-400 group-focus-within:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                    </div>
                                    <input type="text" id="post-title" 
                                           class="block w-full pl-12 pr-4 py-4 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white text-lg font-bold placeholder:font-medium placeholder:text-slate-400 focus:bg-white dark:focus:bg-slate-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all duration-200" 
                                           placeholder="请输入公告标题">
                                </div>
                                <div class="relative">
                                    <textarea id="post-content" rows="6" 
                                              class="block w-full p-4 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 text-sm leading-relaxed placeholder:text-slate-400 focus:bg-white dark:focus:bg-slate-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all duration-200 resize-y" 
                                              placeholder="在此输入公告正文内容...&#10;支持换行排版"></textarea>
                                </div>
                                <div class="relative group">
                                    <input type="file" id="post-file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="image/*" onchange="window.handleFileSelect(this)">
                                    <div id="upload-zone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-8 flex flex-col items-center justify-center bg-slate-50/50 dark:bg-slate-900/50 group-hover:bg-blue-50/50 dark:group-hover:bg-blue-900/20 group-hover:border-blue-400 transition-all duration-300">
                                        <div class="p-4 bg-white dark:bg-slate-800 rounded-full shadow-sm mb-3 group-hover:scale-110 group-hover:shadow-md transition-all duration-300">
                                            <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        </div>
                                        <p class="text-sm font-bold text-slate-600 dark:text-slate-300 group-hover:text-blue-700 dark:group-hover:text-blue-400 transition-colors">点击或拖拽图片到此处上传</p>
                                        <p class="text-xs text-slate-400 mt-1" id="file-name-display">支持 JPG, PNG, GIF 格式</p>
                                    </div>
                                </div>
                                <div class="flex justify-end gap-3 pt-4 border-t border-slate-50 dark:border-slate-700">
                                    <button onclick="window.togglePublisher()" class="px-6 py-2.5 text-slate-500 font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-700 dark:hover:text-slate-200 rounded-xl transition-colors">取消</button>
                                    <button onclick="window.publishNotice()" class="px-8 py-2.5 bg-blue-600 text-white font-bold text-sm rounded-xl hover:bg-blue-700 hover:shadow-lg hover:shadow-blue-200 transition-all transform active:scale-95 flex items-center gap-2">
                                        <span>立即发布</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="notice-list" class="space-y-6 min-h-[300px]">
                    <div id="empty-state" class="flex flex-col items-center justify-center py-20 text-center fade-in-down select-none">
                        <div class="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 shadow-inner ring-4 ring-white dark:ring-slate-700">
                            <svg class="w-10 h-10 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white">暂无公告内容</h3>
                        <p class="text-sm text-slate-400 mt-2 max-w-xs mx-auto">点击右上角的“发布新公告”按钮，发布第一条通知。</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 视图五：用户管理 -->
        <section id="view-users" class="hidden space-y-6">
            <div class="glass-card overflow-hidden">
                <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                    <h2 class="text-xl font-bold text-slate-800 dark:text-white">用户管理</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">管理系统用户和权限</p>
                </div>
                <div class="p-6">
                    <!-- 用户列表 -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200">用户列表</h3>
                            <button onclick="window.openAddUserModal()" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition shadow-md">
                                添加用户
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 dark:bg-slate-900">
                                    <tr>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">用户名</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">邮箱</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">角色</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">状态</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">创建时间</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                                    <!-- 用户数据将通过JavaScript动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 视图六：用户登录监控系统 -->
        <section id="view-login-monitor" class="hidden space-y-6">
            <div class="glass-card overflow-hidden">
                <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">用户登录监控系统</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">实时监控系统登录状态和在线用户</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span id="last-refresh-time" class="text-xs text-slate-400 dark:text-slate-500">
                                最后更新：--
                            </span>
                            <button 
                                id="monitor-refresh-btn" 
                                onclick="window.manualRefreshMonitor()"
                                class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md">
                                <svg class="w-4 h-4 refresh-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span>刷新</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <!-- 在线用户统计 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="glass-card p-6 border border-blue-200 dark:border-blue-900/50 bg-blue-50/50 dark:bg-blue-900/10">
                            <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-2">当前在线成员</h3>
                            <div class="flex items-center justify-between">
                                <div class="text-3xl font-black text-blue-600 dark:text-blue-400" id="online-users-count">12</div>
                                <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">实时更新</p>
                        </div>
                        <div class="glass-card p-6 border border-green-200 dark:border-green-900/50 bg-green-50/50 dark:bg-green-900/10">
                            <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-2">今日登录次数</h3>
                            <div class="flex items-center justify-between">
                                <div class="text-3xl font-black text-green-600 dark:text-green-400">48</div>
                                <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">24小时统计</p>
                        </div>
                        <div class="glass-card p-6 border border-purple-200 dark:border-purple-900/50 bg-purple-50/50 dark:bg-purple-900/10">
                            <h3 class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-2">活跃用户数</h3>
                            <div class="flex items-center justify-between">
                                <div class="text-3xl font-black text-purple-600 dark:text-purple-400">32</div>
                                <div class="w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">最近7天活跃</p>
                        </div>
                    </div>
                    
                    <!-- 在线用户列表 -->
                    <div class="glass-card p-6">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">在线用户列表</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 dark:bg-slate-900">
                                    <tr>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">用户名</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">邮箱</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">角色</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">登录时间</th>
                                        <th class="px-6 py-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">登录IP</th>
                                    </tr>
                                </thead>
                                <tbody id="onlineUsersTableBody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                                    <tr>
                                        <td colspan="5" class="px-6 py-8 text-center text-slate-400 text-sm">
                                            <div class="flex flex-col items-center">
                                                <span>正在获取在线用户列表...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 引入模块化JavaScript文件（按依赖顺序加载） -->
    <script src="suopei_assets/js/config.js"></script>
    <script src="suopei_assets/js/utils.js"></script>
    <script src="suopei_assets/js/auth.js"></script>
    <script src="suopei_assets/js/database.js"></script>
    <script src="suopei_assets/js/realtime.js"></script>
    <script src="suopei_assets/js/ui.js"></script>
    <script src="suopei_assets/js/charts.js"></script>
    <script src="suopei_assets/js/imageUpload.js"></script>
    <script src="suopei_assets/js/main.js"></script>
    <script src="suopei_assets/js/logistics.js"></script>

    <script>
        if (typeof supabaseClient === 'undefined' && typeof SUPABASE_CONFIG !== 'undefined' && typeof supabase !== 'undefined') {
            supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        }
        
        window.togglePublisher = function() {
            const pub = document.getElementById('publisher');
            if (!pub) return;
            if(pub.classList.contains('hidden')) {
                pub.classList.remove('hidden');
                setTimeout(() => {
                    const titleInput = document.getElementById('post-title');
                    if (titleInput) titleInput.focus();
                }, 100);
            } else {
                pub.classList.add('hidden');
            }
        };
        
        window.closeEditNoticeModal = function() {
            const modal = document.getElementById('editNoticeModal');
            const form = document.getElementById('editNoticeForm');
            
            modal.classList.remove('active');
            form.reset();
            document.getElementById('edit-notice-file').value = '';
            document.getElementById('edit-file-name-display').textContent = '支持 JPG, PNG, GIF 格式';
        };
        
        window.editNotice = async function(id) {
            const client = window.supabaseClient || supabaseClient;
            if (!client) return;
            
            try {
                const { data: notice, error } = await client
                    .from('notices')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) {
                    showToast('获取公告数据失败', 'error');
                    return;
                }
                
                document.getElementById('edit-notice-id').value = notice.id;
                document.getElementById('edit-notice-title').value = notice.title;
                document.getElementById('edit-notice-content').value = notice.content;
                
                const modal = document.getElementById('editNoticeModal');
                modal.classList.add('active');
            } catch (error) {
                showToast('编辑公告失败', 'error');
            }
        };
        
        window.handleEditFileSelect = async function(input) {
            if (!input.files || input.files.length === 0) return;
            
            const file = input.files[0];
            
            if (!file.type.startsWith('image/')) {
                showToast('请上传图片文件', 'error');
                input.value = '';
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('图片大小不能超过5MB', 'error');
                input.value = '';
                return;
            }
            
            document.getElementById('edit-file-name-display').textContent = file.name;
        };
        
        window.saveNoticeChanges = async function() {
            const client = window.supabaseClient || supabaseClient;
            if (!client) return;
            
            try {
                const id = document.getElementById('edit-notice-id').value;
                const title = document.getElementById('edit-notice-title').value;
                const content = document.getElementById('edit-notice-content').value;
                const fileInput = document.getElementById('edit-notice-file');
                
                const currentUser = getCurrentUser();
                if (!currentUser || currentUser.role !== 'admin') {
                    showToast('您没有权限修改公告', 'error');
                    return;
                }
                
                if (!confirm('确定要保存修改吗？')) {
                    return;
                }
                
                const { data: originalNotice, error: fetchError } = await client
                    .from('notices')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (fetchError) throw fetchError;
                
                let newImageUrl = originalNotice.image_url;
                if (fileInput.files && fileInput.files.length > 0) {
                    if (originalNotice.image_url) {
                        try {
                            const url = new URL(originalNotice.image_url);
                            const path = url.pathname.replace('/storage/v1/object/public/claim-images/', '');
                            
                            await client
                                .storage
                                .from('claim-images')
                                .remove([path]);
                        } catch (urlError) {
                            // 继续执行，不影响新图片上传
                        }
                    }
                    
                    const file = fileInput.files[0];
                    const fileName = `notice-${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${file.name.split('.').pop()}`;
                    
                    const { data: uploadData, error: uploadError } = await client
                        .storage
                        .from('claim-images')
                        .upload(fileName, file);
                    
                    if (uploadError) {
                        showToast('图片上传失败', 'error');
                        return;
                    }
                    
                    const { data: urlData } = client
                        .storage
                        .from('claim-images')
                        .getPublicUrl(fileName);
                    
                    newImageUrl = urlData.publicUrl;
                }
                
                const { data: updatedData, error: updateError } = await client
                    .from('notices')
                    .update({
                        title,
                        content,
                        image_url: newImageUrl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id)
                    .select();

                if (updateError) throw updateError;

                if (!updatedData || updatedData.length === 0) {
                    showToast('保存失败：数据库权限不足 (RLS拒绝更新)', 'error');
                    return;
                }
                
                const { error: historyError } = await client
                    .from('notice_history')
                    .insert([{
                        notice_id: id,
                        old_title: originalNotice.title,
                        new_title: title,
                        old_content: originalNotice.content,
                        new_content: content,
                        old_image_url: originalNotice.image_url,
                        new_image_url: newImageUrl,
                        updated_by: currentUser.username,
                        updated_at: new Date().toISOString()
                    }]);
                
                if (historyError) {
                    // 历史记录失败不影响公告修改，继续执行
                }
                
                window.closeEditNoticeModal();
                await window.loadNotices();
                showToast('公告修改成功', 'success');
            } catch (error) {
                showToast('保存公告修改失败', 'error');
            }
        };
        const tableColumns = (typeof TABLE_COLUMNS !== 'undefined') ? TABLE_COLUMNS : [
            { key: 'store_by', label: '所属店铺', minW: '140px', sort: true },
            { key: 'order_no', label: '海外仓单号', minW: '140px', sort: true },
            { key: 'tracking_no', label: '物流运单号', minW: '140px', sort: true },
            { key: 'warehouse', label: '发货仓', minW: '100px', sort: true },
            { key: 'ship_date', label: '发货日期', minW: '110px', sort: true },
            { key: 'sku', label: '订单SKU', minW: '120px', sort: true },
            { key: 'claim_type', label: '索赔类型', minW: '100px', sort: true },
            { key: 'description', label: '问题描述', minW: '200px', sort: false },
            { key: 'val_amount', label: '货物声明价值', minW: '100px', sort: true },
            { key: 'claim_qty', label: '索赔数量', minW: '80px', sort: true, center: true },
            { key: 'claim_total', label: '总赔偿金额', minW: '120px', sort: true },
            { key: 'currency', label: '币种', minW: '60px', sort: false },
            { key: 'process_status', label: '处理状态', minW: '100px', sort: true },
            { key: 'entry_date', label: '申请提交日期', minW: '110px', sort: true },
            { key: 'remarks', label: '备注', minW: '150px', sort: false, hidden: true }
        ];
        
        // 用户认证状态已在auth.js中定义（currentUser, isAuthenticated）
        // visibleColumns已在ui.js中定义（第9行），这里不再重复声明
        // 如果需要访问，直接使用 ui.js 中定义的版本
        // ListState已在main.js中定义
        
        // 全局状态对象已在main.js中定义
        // 为保持兼容性，检查是否已定义，如果未定义则创建
        if (typeof ListState === 'undefined') {
            window.ListState = {
                data: [], // 当前页的数据数组
                totalCount: 0, // 数据库中的总记录数
                pagination: {
                    page: 1, // 当前页码
                    pageSize: parseInt(localStorage.getItem('wh_claims_pageSize')) || 20, // 每页条数，从localStorage恢复或使用默认值
                    pageSizeOptions: [20, 50, 100, 200] // 可选条数
                },
                sort: null, // 排序状态：{ field: 'order_no', order: 'asc' | 'desc' }
                filters: {
                    status: 'all', // 状态筛选
                    type: 'all', // 类型筛选
                    search: '', // 搜索关键词（快速搜索）
                    searchMode: 'fuzzy', // 搜索模式：fuzzy（模糊）或 exact（精确）
                    searchField: 'all', // 搜索字段：'all'（全部字段）或指定字段名
                    advancedSearch: null,
                    advancedFilters: null
                },
                sorting: {
                    col: 'entry_date', // 排序字段
                    asc: false // 排序方向
                },
                isLoading: false, // 加载状态标记
                isLargeDataset: false, // 是否为超大数据集（1万+条记录）
                loadedRanges: [] // 已加载的数据范围，用于分片加载策略
            };
        }
        // editingId 已在 ui.js 中定义，此处不重复声明
        // 如果需要访问 editingId，它已经在 ui.js 模块中声明为全局变量
        
        // 数据库连接状态管理已在database.js中定义
        // dbConnectionState 和 setDbConnectionState 已在database.js模块中定义
        // 此处不重复声明，直接使用模块中定义的版本
        
        // 数据库连接状态管理函数已在database.js中定义
        // updateDbStatusIndicator 和 setDbConnectionState 已在database.js模块中定义
        // setRefreshButtonState 函数也在database.js中定义
        // 此处不重复定义，直接使用模块中定义的版本
        
        // formatDateTimeDisplay 函数已在utils.js中定义
        // 此处不重复定义，直接使用模块中定义的版本
        // 刷新数据库数据
        async function refreshDatabase() {
            // 【简化方案】直接刷新页面，确保所有数据都是最新的
            // 这样可以清除所有缓存和状态，确保数据完全刷新
            location.reload();
        }
        if (!document._domContentLoadedRegistered) {
            document.addEventListener('DOMContentLoaded', () => {
                if (typeof initImageUploadModule === 'function') {
                    initImageUploadModule();
                }
                
                if (document.getElementById('notice-list')) {
                    window.loadNotices();
                }
                
                const rowHeight = (typeof TABLE_ROW_HEIGHT !== 'undefined') ? TABLE_ROW_HEIGHT : 130;
                document.documentElement.style.setProperty('--table-row-height', `${rowHeight}px`);
                
                initNewSearchFunctions();
            });
            document._domContentLoadedRegistered = true;
        }
        
        function initNewSearchFunctions() {
            initFilterStatusButtons();
            
            const quickSearchInput = document.getElementById('quickSearch');
            if (quickSearchInput) {
                quickSearchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleQuickSearch();
                    }
                });
            }
        }
        
        async function checkSupabaseTableStructure() {
            if (!supabaseClient) return;
            try {
                const { data: tableInfo, error: tableError } = await supabaseClient
                    .from('claims_v2')
                    .select('*')
                    .limit(1);
                
                if (tableError) {
                    // 表结构检查失败，静默处理
                }
            } catch (error) {
                // 检查表结构异常，静默处理
            }
        }
        
        function initLoginForms() {
            const showRegister = document.getElementById('showRegister');
            const showLogin = document.getElementById('showLogin');
            const forgotPassword = document.getElementById('forgot-password');
            const backToLogin = document.getElementById('back-to-login');
            
            if (showRegister) {
                showRegister.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (typeof showError === 'function') {
                        showError('此功能暂停使用');
                    } else if (typeof showToast === 'function') {
                        showToast('此功能暂停使用', 'info');
                    } else {
                        alert('此功能暂停使用');
                    }
                });
            }
            
            if (showLogin) {
                showLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    showForm('login');
                });
            }
            
            if (forgotPassword) {
                forgotPassword.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (typeof showError === 'function') {
                        showError('此功能暂停使用');
                    } else if (typeof showToast === 'function') {
                        showToast('此功能暂停使用', 'info');
                    } else {
                        alert('此功能暂停使用');
                    }
                });
            }
            
            if (backToLogin) {
                backToLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    showForm('login');
                });
            }
            
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const resetForm = document.getElementById('reset-form');
            
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await handleLogin();
                });
            }
            
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await handleRegister();
                });
            }
            
            if (resetForm) {
                resetForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await handlePasswordReset();
                });
            }
            
            initPasswordToggle();
            loadRememberedCredentials();
            initRememberMeHandler();
        }
        
        function initRememberMeHandler() {
            const rememberMeCheckbox = document.getElementById('rememberMe');
            if (rememberMeCheckbox) {
                rememberMeCheckbox.addEventListener('change', function() {
                    if (!this.checked) {
                        localStorage.removeItem('rememberedEmail');
                        localStorage.removeItem('rememberedPassword');
                        localStorage.removeItem('rememberMe');
                    }
                });
            }
        }
        
        function loadRememberedCredentials() {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            const rememberedPassword = localStorage.getItem('rememberedPassword');
            const rememberMe = localStorage.getItem('rememberMe');
            const rememberMeCheckbox = document.getElementById('rememberMe');
            
            if (rememberMe === 'true' && rememberedEmail && rememberedPassword) {
                const emailInput = document.getElementById('login-email');
                const passwordInput = document.getElementById('login-password');
                
                if (emailInput) {
                    emailInput.value = rememberedEmail;
                }
                if (passwordInput) {
                    passwordInput.value = rememberedPassword;
                }
                if (rememberMeCheckbox) {
                    rememberMeCheckbox.checked = true;
                }
            } else {
                if (rememberMeCheckbox) {
                    rememberMeCheckbox.checked = false;
                }
            }
        }
        
        function initPasswordToggle() {
            const loginPasswordInput = document.getElementById('login-password');
            const loginToggleBtn = document.getElementById('toggle-login-password');
            
            const registerPasswordInput = document.getElementById('register-password');
            const registerToggleBtn = document.getElementById('toggle-register-password');
            
            function setupPasswordToggle(passwordInput, toggleBtn) {
                if (!passwordInput || !toggleBtn) return;
                
                toggleBtn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    passwordInput.type = 'text';
                    this.classList.remove('fa-eye');
                    this.classList.add('fa-eye-slash');
                });
                
                toggleBtn.addEventListener('mouseup', function(e) {
                    e.preventDefault();
                    passwordInput.type = 'password';
                    this.classList.remove('fa-eye-slash');
                    this.classList.add('fa-eye');
                });
                
                toggleBtn.addEventListener('mouseleave', function(e) {
                    passwordInput.type = 'password';
                    this.classList.remove('fa-eye-slash');
                    this.classList.add('fa-eye');
                });
                
                toggleBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    passwordInput.type = 'text';
                    this.classList.remove('fa-eye');
                    this.classList.add('fa-eye-slash');
                }, { passive: false });
                
                toggleBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    passwordInput.type = 'password';
                    this.classList.remove('fa-eye-slash');
                    this.classList.add('fa-eye');
                }, { passive: false });
            }
            
            setupPasswordToggle(loginPasswordInput, loginToggleBtn);
            setupPasswordToggle(registerPasswordInput, registerToggleBtn);
        }
        
        // 初始化系统标题同步功能
        function initTitleSync() {
            const mainTitle = document.getElementById('system-title-main');
            const secondaryTitle = document.getElementById('system-title-secondary');
            
            // 确保两个元素都存在
            if (!mainTitle || !secondaryTitle) {
                return;
            }
            
            // 定义同步函数
            function syncTitles() {
                // 使用主标题内容更新次要标题
                secondaryTitle.textContent = mainTitle.textContent;
            }
            
            // 立即执行一次同步
            syncTitles();
            
            // 创建MutationObserver来监听主标题内容变化
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        syncTitles();
                    }
                });
            });
            
            // 配置并启动观察者
            observer.observe(mainTitle, {
                childList: true,
                characterData: true,
                subtree: true
            });
        }
        
        function showForm(formType) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const forgotForm = document.getElementById('forgotForm');
            
            if (loginForm) loginForm.style.display = 'none';
            if (registerForm) registerForm.style.display = 'none';
            if (forgotForm) forgotForm.style.display = 'none';
            
            if (formType === 'login' && loginForm) {
                loginForm.style.display = 'block';
            } else if (formType === 'register' && registerForm) {
                registerForm.style.display = 'block';
            } else if (formType === 'reset' && forgotForm) {
                forgotForm.style.display = 'block';
            }
            
            clearMessages();
        }
        
        function clearMessages() {
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            if (errorMsg) errorMsg.style.display = 'none';
            if (successMsg) successMsg.style.display = 'none';
        }
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            if (errorElement && errorText) {
                errorText.textContent = message;
                errorElement.style.display = 'flex';
                setTimeout(() => {
                    if (errorElement) errorElement.style.display = 'none';
                }, 5000);
            } else if (typeof showToast === 'function') {
                showToast(message, 'error');
            }
        }
        
        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            if (successElement && successText) {
                successText.textContent = message;
                successElement.style.display = 'flex';
                setTimeout(() => {
                    if (successElement) successElement.style.display = 'none';
                }, 5000);
            } else if (typeof showToast === 'function') {
                showToast(message, 'success');
            }
        }
        
        // 初始化认证
        function initAuth() {
            checkUserSession();
            supabaseClient.auth.onAuthStateChange((event, session) => {
                handleAuthChange(event, session);
            });
        }
        
        // 检查用户会话
        async function checkUserSession() {
            // 先隐藏登录界面，等待session检查完成
            const loginContainer = document.getElementById('login-container');
            if (loginContainer) {
                loginContainer.classList.add('hidden');
            }
            
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                handleAuthChange('SIGNED_IN', session);
            } else {
                // 只有在确认没有session时才显示登录界面
                if (loginContainer) {
                    loginContainer.classList.remove('hidden');
                }
            }
        }
        
        // 处理认证状态变化
        async function handleAuthChange(event, session) {
            if (event === 'SIGNED_IN' && session) {
                // 获取完整用户信息，包括角色
                try {
                    const { data: userData, error } = await supabaseClient
                        .from('users_v2')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();
                    
                    if (error) {
                        // 针对42P17错误（无限递归策略）进行特殊处理
                        if (error.code === '42P17') {
                            showToast('数据库策略存在问题，无法获取用户角色', 'error');
                        }
                        
                        // 降级处理：使用 session 中的元数据
                        currentUser = {
                            ...session.user,
                            role: session.user.user_metadata?.role || 'user',
                            username: session.user.user_metadata?.username || '用户',
                            status: 'active',
                            permissions: session.user.user_metadata?.permissions || {}
                        };
                    } else {
                        // 正常获取：使用数据库数据
                        currentUser = {
                            ...session.user,
                            role: userData.role, // 数据库字段映射
                            username: userData.username || session.user.user_metadata?.username || '用户', // 数据库字段映射
                            status: userData.status,
                            permissions: userData.permissions || {} // 数据库字段映射
                        };
                    }
                } catch (error) {
                    currentUser = {
                        ...session.user,
                        permissions: session.user.user_metadata?.permissions || {}
                    };
                }
                
                isAuthenticated = true;
                
                document.getElementById('login-container').classList.add('hidden');
                
                // --- 更新侧边栏用户信息 (核心修改) ---
                const userInfo = document.getElementById('user-info');
                const userNameEl = document.getElementById('user-name');
                const userEmailEl = document.getElementById('user-email');
                const userRoleEl = document.getElementById('user-role-label');
                
                userInfo.classList.remove('hidden');
                
                // 1. 映射 Username
                userNameEl.textContent = currentUser.username || '用户';
                userNameEl.title = currentUser.username; // 鼠标悬停显示全名
                
                // 2. 映射 Email
                userEmailEl.textContent = currentUser.email;
                userEmailEl.title = currentUser.email;
                
                // 3. 映射 Role (管理员账号/成员账号)
                if (userRoleEl) {
                    if (currentUser.role === 'admin') {
                        userRoleEl.textContent = '管理员账号';
                        userRoleEl.className = 'text-[10px] px-1.5 py-0.5 rounded border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 font-medium whitespace-nowrap';
                        document.getElementById('nav-users').classList.remove('hidden');
        
    } else {
                        userRoleEl.textContent = '成员账号';
                        userRoleEl.className = 'text-[10px] px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 font-medium whitespace-nowrap';
                        document.getElementById('nav-users').classList.add('hidden');
                    }
                }
                // -------------------------------------
                
                // 【修复】检查当前视图，避免在用户管理页面等非数据视图触发数据加载
                const currentView = localStorage.getItem('wh_claims_currentView') || 'form';
                const isDataRelatedView = ['form', 'data', 'kanban'].includes(currentView);
                
                // 只在数据相关视图初始化数据
                if (isDataRelatedView) {
                    database = await loadDataFromSupabase();
                    
                    renderTableHeader();
                    renderColumnModal();
                    renderKanban();
                    initCharts();
                    if (typeof window.fetchTableData === 'function') {
                        window.fetchTableData();
                    } else if (typeof fetchTableData === 'function') {
                        fetchTableData();
                    } else {
                        // fetchTableData函数未定义，等待模块加载
                        setTimeout(() => {
                            if (typeof window.fetchTableData === 'function') {
                                window.fetchTableData();
                            }
                        }, 100);
                    }
                }
                
                // 启动心跳机制，证明我在线
                startHeartbeat(session.user.id);
                
                // 登录成功后启动状态统计更新
                setTimeout(() => {
                    updateStatusCounts();
                    if (typeof window.statusCountsInterval === 'undefined' || !window.statusCountsInterval) {
                        window.statusCountsInterval = setInterval(updateStatusCounts, 30000);
                    }
                }, 1000);
                
                // 恢复之前打开的视图
                const savedView = localStorage.getItem('wh_claims_currentView') || 'form';
                if (typeof switchView === 'function') {
                    await switchView(savedView);
                } else if (typeof window.switchView === 'function') {
                    await window.switchView(savedView);
                } else {
                    // 如果switchView还未加载，等待一下
                    setTimeout(async () => {
                        if (typeof window.switchView === 'function') {
                            await window.switchView(savedView);
                        }
                    }, 100);
                }
                
                const loginContainer = document.getElementById('login-container');
                if (loginContainer && loginContainer.classList.contains('hidden') === false) {
                    showToast('登录成功！', 'success');
                }
            } else if (event === 'SIGNED_OUT') {
                // 停止心跳（使用 auth.js 中定义的 heartbeatInterval）
                if (typeof window.heartbeatInterval !== 'undefined' && window.heartbeatInterval) {
                    clearInterval(window.heartbeatInterval);
                    window.heartbeatInterval = null;
                }
                
                // 停止状态统计更新
                if (typeof window.statusCountsInterval !== 'undefined' && window.statusCountsInterval) {
                    clearInterval(window.statusCountsInterval);
                    window.statusCountsInterval = null;
                }
                
                currentUser = null;
                isAuthenticated = false;
                document.getElementById('user-info').classList.add('hidden');
                database = [];
                document.getElementById('login-container').classList.remove('hidden');
            }
        }
        
        async function handleLogin() {
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            const rememberMeCheckbox = document.getElementById('rememberMe');
            
            if (!emailInput || !passwordInput) return;
            
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            
            if (!email || !password) {
                showError('请填写完整的登录信息');
                return;
            }
            
            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.disabled = true;
                loginButton.classList.add('btn-loading');
            }
            
            try {
                const { error, data } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    showError(error.message || '登录失败，请检查您的凭据');
                } else {
                    if (data.user) {
                        const { data: userDetails } = await supabaseClient
                            .from('users_v2')
                            .select('*')
                            .eq('id', data.user.id)
                            .single();
                            
                        const userInfo = {
                            ...data.user,
                            username: userDetails?.username || '用户',
                            role: userDetails?.role || 'user'
                        };
                        
                        if (rememberMeCheckbox && rememberMeCheckbox.checked) {
                            localStorage.setItem('rememberedEmail', email);
                            localStorage.setItem('rememberedPassword', password);
                            localStorage.setItem('rememberMe', 'true');
                        } else {
                            localStorage.removeItem('rememberedEmail');
                            localStorage.removeItem('rememberedPassword');
                            localStorage.removeItem('rememberMe');
                        }
                        
                        logUserLogin(userInfo);
                    }
                }
            } catch (error) {
                showError(error.message || '登录失败，请稍后重试');
            } finally {
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.classList.remove('btn-loading');
                }
            }
        }
        
        // --- 新增：获取公网IP (利用第三方免费API) ---
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (e) {
                return '未知IP'; // 获取失败时
            }
        }

        // --- 新增：记录登录日志 ---
        async function logUserLogin(user) {
            const ip = await getClientIP();
            
            // 1. 插入登录历史表
            const { error: logError } = await supabaseClient
                .from('login_history')
                .insert([{
                    user_id: user.id,
                    username: user.username || user.user_metadata?.username,
                    email: user.email,
                    role: user.role || 'user',
                    ip_address: ip,
                    login_at: new Date().toISOString()
                }]);


            // 2. 立即更新 users_v2 表的活跃时间
            await updateUserHeartbeat(user.id);
        }

        // --- 新增：更新用户心跳 (保活) ---
        async function updateUserHeartbeat(userId) {
            if (!userId) return;
            const { error } = await supabaseClient
                .from('users_v2')
                .update({ last_active_at: new Date().toISOString() })
                .eq('id', userId);
                
        }

        // --- 新增：启动心跳定时器 ---
        // 注意：heartbeatInterval 已在 auth.js 中定义，此处不再重复声明
        // 如果需要在这里使用，应该使用 auth.js 中定义的版本
        function startHeartbeat(userId) {
            // 使用 auth.js 中的 heartbeatInterval
            if (typeof window.heartbeatInterval !== 'undefined' && window.heartbeatInterval) {
                clearInterval(window.heartbeatInterval);
            }
            
            // 立即执行一次
            updateUserHeartbeat(userId);
            
            // 每 2 分钟执行一次 (300000ms)
            window.heartbeatInterval = setInterval(() => {
                updateUserHeartbeat(userId);
            }, 300000);
        }
        
        async function handleRegister() {
            if (typeof showError === 'function') {
                showError('此功能暂停使用');
            } else if (typeof showToast === 'function') {
                showToast('此功能暂停使用', 'info');
            } else {
                alert('此功能暂停使用');
            }
            return;
        }
        
        async function handlePasswordReset() {
            if (typeof showError === 'function') {
                showError('此功能暂停使用');
            } else if (typeof showToast === 'function') {
                showToast('此功能暂停使用', 'info');
            } else {
                alert('此功能暂停使用');
            }
            return;
        }
        
        // 登出功能
        function handleLogout() {
            supabaseClient.auth.signOut();
        }
        
        // 从Supabase加载数据（兼容旧版，仅用于本地缓存）
        async function loadDataFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('claims_v2')
                    .select('*')
                    .order('entry_date', { ascending: false });
                
                if (error) {
                    return JSON.parse(localStorage.getItem('wh_claims_db_pro')) || [];
                } else {
                    // 保存到本地缓存
                    localStorage.setItem('wh_claims_db_pro', JSON.stringify(data || []));
                    return data || [];
                }
            } catch (error) {
                return JSON.parse(localStorage.getItem('wh_claims_db_pro')) || [];
            }
        }
        
        // 注意：currentFetchController、fetchRequestId 和 fetchTableData 已在 database.js 中定义
        // 这里不再重复声明，直接使用 database.js 中的版本
        
        // 用户管理相关功能
        // users 数组需要在全局作用域中声明，以便其他函数访问
        window.users = [];
        
        // 切换权限面板显示/隐藏（全局函数，供onclick调用）
        window.togglePermissionPanel = function() {
            const roleSelect = document.getElementById('add-role');
            const permissionPanel = document.getElementById('permission-panel');
            // 管理员角色隐藏权限面板，普通用户显示
            if (roleSelect.value === 'admin') {
                permissionPanel.classList.add('hidden');
            } else {
                permissionPanel.classList.remove('hidden');
                // 渲染权限复选框
                window.renderPermissionCheckboxes('permission-checkboxes', {});
            }
        };
        
        // 动态渲染权限复选框（全局函数，供内部调用）
        window.renderPermissionCheckboxes = function(containerId, currentPermissions = {}) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // 清空容器
            container.innerHTML = '';
            
            // 遍历权限定义，生成复选框
            PERMISSION_DEFINITIONS.forEach(permission => {
                const isChecked = Boolean(currentPermissions[permission.key]);
                
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'flex items-start gap-2';
                
                checkboxItem.innerHTML = `
                    <div class="flex items-center h-5">
                        <input id="perm-${permission.key}" type="checkbox" class="w-4 h-4 text-blue-600 bg-white border-slate-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-slate-800 focus:ring-2 dark:bg-slate-700 dark:border-slate-600" ${isChecked ? 'checked' : ''}>
                    </div>
                    <div class="ml-1.5 text-sm">
                        <label for="perm-${permission.key}" class="text-sm font-medium text-slate-700 dark:text-slate-300 cursor-pointer">${permission.label}</label>
                        <p class="text-xs text-slate-500 dark:text-slate-400">${permission.desc}</p>
                    </div>
                `;
                
                container.appendChild(checkboxItem);
            });
        };
        
        // 打开添加用户模态框（全局函数，供onclick调用）
        window.openAddUserModal = function() {
            document.getElementById('addUserModal').classList.add('active');
            // 初始化权限面板
            window.togglePermissionPanel();
        };
        
        // 关闭添加用户模态框（全局函数，供onclick调用）
        window.closeAddUserModal = function() {
            document.getElementById('addUserModal').classList.remove('active');
            document.getElementById('addUserForm').reset();
            // 清空错误提示
            document.querySelectorAll('#addUserForm .text-red-500').forEach(el => el.classList.add('hidden'));
        };
        
        // 验证用户名唯一性
        function isUsernameUnique(username) {
            return !window.users.some(user => user.username === username);
        }
        
        // 日志记录函数
        function logAction(action, details) {
        }
        
        // 验证邮箱唯一性（异步版）
        async function isEmailUnique(email) {
            const startTime = new Date();
            
            try {
                // 先检查本地数组
                const isLocalUnique = !window.users.some(user => user.email === email);
                
                    logAction('检查邮箱唯一性', {
                        email,
                        step: 'local_check',
                        result: isLocalUnique,
                        local_user_count: window.users.length
                    });
                
                if (!isLocalUnique) {
                    logAction('邮箱唯一性检查结果', {
                        email,
                        unique: false,
                        reason: 'local_array',
                        duration: new Date() - startTime
                    });
                    return false;
                }
                
                // 查询Supabase数据库
                const { data, error } = await supabaseClient.auth.admin.listUsers({
                    email,
                    perPage: 1
                });
                
                if (error) {
                    logAction('邮箱唯一性检查错误', {
                        email,
                        error: error.message,
                        duration: new Date() - startTime
                    });
                    // 如果数据库查询失败，至少返回本地检查结果
                    return isLocalUnique;
                }
                
                const isUnique = data.users.length === 0;
                
                logAction('邮箱唯一性检查结果', {
                    email,
                    unique: isUnique,
                    reason: 'database',
                    database_count: data.users.length,
                    duration: new Date() - startTime
                });
                
                // 如果数据库中存在该邮箱，返回false
                return isUnique;
            } catch (error) {
                logAction('邮箱唯一性检查异常', {
                    email,
                    error: error.message,
                    duration: new Date() - startTime
                });
                // 异常情况下，至少返回本地检查结果
                return !window.users.some(user => user.email === email);
            }
        }
        
        // loadUsersFromSupabase 已在脚本开头定义，此处不再重复定义
        
        // 本地用户数据（与supabase/users_v2.json内容同步）
        const LOCAL_USERS_DATA = [
            {
                "id": "4c0571a3-990b-46e1-8497-215b991b592f",
                "username": "SXZ",
                "email": "123456789@qq.com",
                "role": "user",
                "status": "active",
                "created_at": "2025-12-23 16:23:42.064276+00",
                "updated_at": "2025-12-23 16:23:42.064276+00"
            },
            {
                "id": "73db2569-5116-49db-ba98-c76e5dcced9c",
                "username": "沈学章",
                "email": "907368105@qq.com",
                "role": "admin",
                "status": "active",
                "created_at": "2025-12-23 16:06:17.093512+00",
                "updated_at": "2025-12-23 16:06:17.093512+00"
            }
        ];
        
        // 根据用户ID获取本地用户数据
        function getLocalUserById(userId) {
            return LOCAL_USERS_DATA.find(user => user.id === userId) || null;
        }
        
        // 使用本地JSON数据作为备选
        function useLocalUserData() {
            // 转换为应用需要的格式
            window.users = LOCAL_USERS_DATA.map(user => ({
                id: user.id,
                username: user.username || '未设置',
                email: user.email,
                role: user.role || 'user',
                status: user.status === 'active' ? 'active' : 'disabled',
                created_at: user.created_at
            }));
            
            showToast('使用本地用户数据', 'info');
        }
        
        // 验证邮箱格式
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // 验证密码强度
        function isPasswordStrong(password) {
            return password.length >= 6 && /[a-zA-Z]/.test(password) && /[0-9]/.test(password);
        }
        
        // 显示加载状态（优化：添加淡入淡出动画和10ms延迟）
        let loadingTimeout = null;
        function showLoading(message = '加载中...') {
            // 清除之前的延迟定时器
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
            }
            
            // 检查是否已存在加载遮罩
            let loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                // 如果已存在，只更新消息
                const messageEl = loadingOverlay.querySelector('p');
                if (messageEl) {
                    messageEl.textContent = message;
                }
                return;
            }
            
            // 10ms延迟显示，避免快速加载时的闪烁
            loadingTimeout = setTimeout(() => {
                // 创建加载遮罩
                loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loading-overlay';
                loadingOverlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 transition-opacity duration-300';
                loadingOverlay.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 rounded-lg p-6 shadow-lg flex flex-col items-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
                        <p class="text-slate-700 dark:text-slate-300 font-medium">${message}</p>
                    </div>
                `;
                document.body.appendChild(loadingOverlay);
                
                // 触发淡入动画
                requestAnimationFrame(() => {
                    loadingOverlay.classList.remove('opacity-0');
                    loadingOverlay.classList.add('opacity-100');
                });
            }, 10);
        }
        
        // 隐藏加载状态（优化：添加淡出动画）
        function hideLoading() {
            // 清除延迟定时器
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                // 添加淡出动画
                loadingOverlay.classList.remove('opacity-100');
                loadingOverlay.classList.add('opacity-0');
                
                // 动画结束后移除元素
                setTimeout(() => {
                    if (loadingOverlay && loadingOverlay.parentNode) {
                        loadingOverlay.remove();
                    }
                }, 300); // 与CSS transition duration一致
            }
        }
        
        // 渲染用户列表 (动态渲染真实数据)（全局函数，供ui.js调用）
        window.renderUserManagement = function() {
            // 【骨架屏】在渲染真实数据前，确保骨架屏已隐藏
            if (typeof hideSkeletonTableUsers === 'function') {
                hideSkeletonTableUsers();
            }
            
            const tbody = document.getElementById('usersTableBody');
            
            if (!window.users || window.users.length === 0) {
                // 【骨架屏】空数据时确保清除骨架屏
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500">暂无用户数据</td></tr>';
                return;
            }

            tbody.innerHTML = window.users.map(user => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-slate-900 dark:text-white">${user.username || '未设置'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <!-- 核心修正：这里直接映射 users_v2 表的 email 字段 -->
                        <div class="text-sm text-slate-700 dark:text-slate-300">${user.email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'admin' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300' : 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400'}">
                            ${user.role === 'admin' ? '管理员' : '普通用户'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'active' ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400' : 'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-400'}">
                            ${user.status === 'active' ? '活跃' : '禁用'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                        ${new Date(user.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="window.editUser('${user.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 mr-4">编辑</button>
                        <button onclick="window.deleteUser('${user.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">删除</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // 打开编辑用户模态框（全局函数，供editUser调用）
        window.openEditUserModal = async function(id) {
            try {
                // 查找要编辑的用户
                const userToEdit = window.users.find(user => user.id === id);
                if (!userToEdit) {
                    showToast('未找到该用户', 'error');
                    return;
                }
                
                // 复制添加用户模态框的HTML结构
                const addUserModal = document.getElementById('addUserModal');
                const editUserModal = document.createElement('div');
                editUserModal.id = 'editUserModal';
                editUserModal.className = 'modal-backdrop';
                editUserModal.innerHTML = `
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4 border-b border-slate-100 dark:border-slate-700 pb-3">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white">编辑用户</h3>
                            <button onclick="window.closeEditUserModal()" class="text-slate-400 hover:text-slate-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                        </div>
                        <form id="editUserForm" class="space-y-4">
                            <!-- 隐藏的用户ID -->
                            <input type="hidden" id="edit-user-id" value="${userToEdit.id}">
                            <div>
                                <label class="input-group-label"><span class="text-red-500 mr-1">*</span>用户名</label>
                                <input type="text" id="edit-username" class="form-input w-full bg-white dark:bg-slate-700" value="${userToEdit.username}" required>
                                <div id="edit-username-error" class="text-red-500 text-xs mt-1 hidden">用户名已存在</div>
                            </div>
                            <div>
                                <label class="input-group-label"><span class="text-red-500 mr-1">*</span>邮箱</label>
                                <input type="email" id="edit-email" class="form-input w-full bg-white dark:bg-slate-700" value="${userToEdit.email}" disabled>
                            </div>
                            <div>
                                <label class="input-group-label">角色</label>
                                <select id="edit-role" class="form-input w-full bg-white dark:bg-slate-700 cursor-pointer" onchange="window.toggleEditPermissionPanel()">
                                    <option value="user" ${userToEdit.role === 'user' ? 'selected' : ''}>普通用户</option>
                                    <option value="admin" ${userToEdit.role === 'admin' ? 'selected' : ''}>管理员</option>
                                </select>
                            </div>
                            <div>
                                <label class="input-group-label">状态</label>
                                <select id="edit-status" class="form-input w-full bg-white dark:bg-slate-700 cursor-pointer">
                                    <option value="active" ${userToEdit.status === 'active' ? 'selected' : ''}>活跃</option>
                                    <option value="disabled" ${userToEdit.status === 'disabled' ? 'selected' : ''}>禁用</option>
                                </select>
                            </div>
                            
                            <!-- 权限面板 -->
                            <div id="edit-permission-panel" class="bg-slate-50 dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                                <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">权限配置</h4>
                                <div id="edit-permission-checkboxes" class="grid grid-cols-2 gap-3"></div>
                            </div>
                            
                            <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-slate-700">
                                <button type="button" onclick="window.closeEditUserModal()" class="px-6 py-2.5 text-slate-500 font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-700 dark:hover:text-slate-200 rounded-xl transition-colors">取消</button>
                                <button type="submit" class="px-8 py-2.5 bg-blue-600 text-white font-bold text-sm rounded-xl hover:bg-blue-700 hover:shadow-lg hover:shadow-blue-200 transition-all transform active:scale-95">
                                    保存修改
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                // 添加到文档中
                document.body.appendChild(editUserModal);
                
                // 显示模态框
                editUserModal.classList.add('active');
                
                // 渲染权限复选框
                window.renderPermissionCheckboxes('edit-permission-checkboxes', userToEdit.permissions || {});
                
                // 切换权限面板显示/隐藏
                window.toggleEditPermissionPanel();
                
                // 添加表单提交事件监听
                const editUserForm = editUserModal.querySelector('#editUserForm');
                editUserForm.addEventListener('submit', async (e) => {
                    await window.handleEditUserSubmit(e);
                });
            } catch (error) {
                showToast('打开编辑用户模态框失败：' + error.message, 'error');
            }
        };
        
        // 关闭编辑用户模态框（全局函数，供onclick调用）
        window.closeEditUserModal = function() {
            const editUserModal = document.getElementById('editUserModal');
            if (editUserModal) {
                editUserModal.remove();
            }
        };
        
        // 切换编辑用户的权限面板显示/隐藏（全局函数，供onchange调用）
        window.toggleEditPermissionPanel = function() {
            const roleSelect = document.getElementById('edit-role');
            const permissionPanel = document.getElementById('edit-permission-panel');
            if (!roleSelect || !permissionPanel) return;
            // 管理员角色隐藏权限面板，普通用户显示
            if (roleSelect.value === 'admin') {
                permissionPanel.classList.add('hidden');
            } else {
                permissionPanel.classList.remove('hidden');
            }
        };
        
        // 处理编辑用户表单提交（全局函数，供openEditUserModal内部调用）
        window.handleEditUserSubmit = async function(e) {
            e.preventDefault();
            
            try {
                // 获取表单数据
                const id = document.getElementById('edit-user-id').value;
                const username = document.getElementById('edit-username').value.trim();
                const role = document.getElementById('edit-role').value;
                const status = document.getElementById('edit-status').value;
                
                // 收集权限数据
                const permissions = {};
                if (role === 'user') {
                    // 只对普通用户收集权限
                    PERMISSION_DEFINITIONS.forEach(perm => {
                        const checkbox = document.getElementById(`perm-${perm.key}`);
                        permissions[perm.key] = checkbox && checkbox.checked;
                    });
                } else {
                    // 管理员权限设为{"all": true}
                    permissions.all = true;
                }
                
                // 显示加载状态
                showLoading('正在更新用户信息...');
                
                // 更新Supabase users_v2表中的用户信息
                const { error } = await supabaseClient
                    .from('users_v2')
                    .update({
                        username,
                        role,
                        status,
                        permissions
                    })
                    .eq('id', id);
                
                if (error) {
                    hideLoading();
                    showToast('更新用户失败：' + error.message, 'error');
                    return;
                }
                
                // 关闭模态框
                window.closeEditUserModal();
                
                // 重新加载用户数据
                const reloadSuccess = await window.loadUsersFromSupabase();
                if (reloadSuccess) {
                    window.renderUserManagement();
                }
                
                hideLoading();
                showToast('用户信息更新成功！', 'success');
            } catch (error) {
                hideLoading();
                showToast('编辑用户失败：' + error.message, 'error');
            }
        };
        
        // 编辑用户（调用模态框）（全局函数，供onclick调用）
        window.editUser = function(id) {
            window.openEditUserModal(id);
        };
        
        // 删除用户（全局函数，供onclick调用）
        window.deleteUser = async function(id) {
            if (confirm('确定要删除该用户吗？')) {
                try {
                    // 显示加载状态
                    showLoading('正在删除用户...');
                    
                    // 从Supabase删除用户
                    const { error } = await supabaseClient.auth.admin.deleteUser(id);
                    
                    if (error) {
                        hideLoading();
                        showToast('删除用户失败：' + error.message, 'error');
                        return;
                    }
                    
                    // 从Supabase users_v2表中删除对应的用户记录
                    const { error: usersV2Error } = await supabaseClient
                        .from('users_v2')
                        .delete()
                        .eq('id', id);
                    
                    if (usersV2Error) {
                        // 删除users_v2表记录失败，静默处理
                    }
                    
                    // 重新加载用户数据
                    const reloadSuccess = await window.loadUsersFromSupabase();
                    if (reloadSuccess) {
                        window.renderUserManagement();
                    }
                    
                    hideLoading();
                    showToast('用户已删除', 'success');
                } catch (error) {
                    hideLoading();
                    showToast('删除用户失败：' + error.message, 'error');
                }
            }
        };
        
        // 初始化添加用户表单事件监听
        document.addEventListener('DOMContentLoaded', () => {
            const addUserForm = document.getElementById('addUserForm');
            if (addUserForm) {
                addUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // 获取表单数据
                    const username = document.getElementById('add-username').value.trim();
                    const email = document.getElementById('add-email').value.trim();
                    const password = document.getElementById('add-password').value;
                    const role = document.getElementById('add-role').value;
                    
                    // 验证用户名
                    const usernameError = document.getElementById('username-error');
                    if (!isUsernameUnique(username)) {
                        usernameError.classList.remove('hidden');
                    } else {
                        usernameError.classList.add('hidden');
                    }
                    
                    // 验证邮箱
                    const emailError = document.getElementById('email-error');
                    if (!isValidEmail(email)) {
                        emailError.classList.remove('hidden');
                    } else {
                        // 异步检查邮箱唯一性
                        const isUnique = await isEmailUnique(email);
                        if (!isUnique) {
                            emailError.classList.remove('hidden');
                        } else {
                            emailError.classList.add('hidden');
                        }
                    }
                    
                    // 验证密码
                    const passwordError = document.getElementById('password-error');
                    if (!isPasswordStrong(password)) {
                        passwordError.classList.remove('hidden');
                    } else {
                        passwordError.classList.add('hidden');
                    }
                    
                    // 如果所有验证通过
                    if (isUsernameUnique(username) && isValidEmail(email) && isPasswordStrong(password)) {
                        // 再次异步检查邮箱唯一性
                        const isEmailUniqueResult = await isEmailUnique(email);
                        if (!isEmailUniqueResult) {
                            const emailError = document.getElementById('email-error');
                            emailError.classList.remove('hidden');
                            return;
                        }
                        
                        try {
                            // 【修复】保存当前管理员会话，防止创建用户后自动切换账号
                            const { data: { session: currentSession } } = await supabaseClient.auth.getSession();
                            if (!currentSession) {
                                showToast('无法获取当前会话，请重新登录', 'error');
                                return;
                            }
                            
                            // 收集权限数据
                            const permissions = {};
                            if (role === 'user') {
                                // 只对普通用户收集权限
                                PERMISSION_DEFINITIONS.forEach(perm => {
                                    const checkbox = document.getElementById(`perm-${perm.key}`);
                                    permissions[perm.key] = checkbox && checkbox.checked;
                                });
                            } else {
                                // 管理员权限设为{"all": true}
                                permissions.all = true;
                            }
                            
                            // 使用Supabase Auth创建用户
                            const { data, error } = await supabaseClient.auth.signUp({
                                email,
                                password,
                                options: {
                                    data: { username, role, permissions }
                                }
                            });
                            
                            if (error) {
                                handleError(error, '添加用户');
                            } else if (data && data.user) {
                                // 【修复】保存当前视图状态，防止恢复会话时触发不必要的数据加载
                                const currentView = localStorage.getItem('wh_claims_currentView') || 'form';
                                const isUsersView = currentView === 'users';
                                
                                // 【修复】立即恢复管理员会话，防止自动切换到新用户
                                await supabaseClient.auth.setSession({
                                    access_token: currentSession.access_token,
                                    refresh_token: currentSession.refresh_token
                                });
                                
                                // 等待一段时间，确保会话恢复完成
                                await new Promise(resolve => setTimeout(resolve, 300));
                                
                                // 恢复视图状态（如果当前在用户管理页面）
                                if (isUsersView) {
                                    localStorage.setItem('wh_claims_currentView', 'users');
                                }
                                
                                // 等待一段时间，确保数据库触发器执行完毕
                                await new Promise(resolve => setTimeout(resolve, 500));
                                
                                // 更新users_v2表的permissions字段
                                const { error: updateError } = await supabaseClient
                                    .from('users_v2')
                                    .update({ permissions })
                                    .eq('id', data.user.id);
                                
                                if (updateError) {
                                    // 更新用户权限失败，静默处理
                                }
                                
                                // 重新加载用户数据，确保从数据库获取最新数据
                                const reloadSuccess = await window.loadUsersFromSupabase();
                                if (reloadSuccess) {
                                    // 更新用户列表
                                    window.renderUserManagement();
                                }
                                
                                // 关闭模态框
                                window.closeAddUserModal();
                                
                                showToast('用户添加成功！', 'success');
                            }
                        } catch (error) {
                            showToast('添加用户失败：' + error.message, 'error');
                        }
                    }
                });
            }
        });
        
        // 注意：switchView 函数已在 ui.js 中定义
        // 此处不再重复定义，直接使用 ui.js 中的版本
        // 如果需要覆盖，确保 ui.js 中的 switchView 已正确暴露到全局作用域
        
        // 渲染用户管理连接错误界面（全局函数，供ui.js调用）
        window.renderUserManagementConnectionError = function() {
            const userListContainer = document.getElementById('user-list-container');
            userListContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-96 text-center">
                    <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-6">
                        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-3">数据库连接失败</h3>
                    <p class="text-slate-500 dark:text-slate-400 max-w-md mb-8">
                        当前无法连接到Supabase数据库，请检查您的网络连接或联系管理员。
                    </p>
                    <button 
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors"
                        onclick="window.retryLoadUsers()"
                    >
                        重试连接
                    </button>
                </div>
            `;
        }
        
        // 重试加载用户数据（全局函数，供onclick调用）
        window.retryLoadUsers = async function() {
            const success = await window.loadUsersFromSupabase();
            if (success) {
                window.renderUserManagement();
            }
        };
        
        // 注意：DB_ALLOWED_COLUMNS 和 sanitizeDataForSupabase 已在 config.js 和 utils.js 中定义
        // 这里不再重复声明，直接使用模块中定义的版本

        // 保存数据到Supabase (已修复字段缺失报错)
        async function saveDataToSupabase() {
            try {
                const latestRecord = database[0];
                if (!latestRecord) return;
                
                // 【修复点】使用白名单清洗数据，过滤掉 'attachments' 等不存在的列
                // sanitizeDataForSupabase 已在 utils.js 中定义
                const dataToSave = sanitizeDataForSupabase(latestRecord);
                
                if (!dataToSave.id) {
                     return;
                }
                
                const { data, error } = await supabaseClient
                    .from('claims_v2')
                    .insert([dataToSave])
                    .select();
                
                if (error) {
                    showToast('云端保存失败: ' + error.message, 'error');
                    localStorage.setItem('wh_claims_db_pro', JSON.stringify(database));
                } else {
                    showToast('数据已同步至云端', 'success');
                }
            } catch (error) {
                localStorage.setItem('wh_claims_db_pro', JSON.stringify(database));
            }
        }
        
        // 更新数据到Supabase (已修复字段缺失报错)
        async function updateDataInSupabase(id, data) {
            try {
                // 【修复点】同样使用白名单清洗数据
                // sanitizeDataForSupabase 已在 utils.js 中定义
                const dataToUpdate = sanitizeDataForSupabase(data);
                delete dataToUpdate.id;

                const { error } = await supabaseClient
                    .from('claims_v2')
                    .update(dataToUpdate)
                    .eq('id', id);
                
                if (error) {
                    handleError(error, '云端更新');
                    const index = database.findIndex(item => item.id === id);
                    if (index !== -1) {
                        database[index] = data;
                        localStorage.setItem('wh_claims_db_pro', JSON.stringify(database));
                    }
                    return false;
                } else {
                    showToast('云端数据已更新', 'success');
                    return true;
                }
            } catch (error) {
                const index = database.findIndex(item => item.id === id);
                if (index !== -1) {
                    database[index] = data;
                    localStorage.setItem('wh_claims_db_pro', JSON.stringify(database));
                }
                return false;
            }
        }
        // --- 修复结束 ---
        
        // 删除数据从Supabase
        async function deleteDataFromSupabase(id) {
            try {
                const { error } = await supabaseClient
                    .from('claims_v2')
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    handleError(error, '删除数据');
                    // 本地仍需删除
                    database = database.filter(item => item.id !== id);
                    localStorage.setItem('wh_claims_db_pro', JSON.stringify(database));
                } else {
                    database = database.filter(item => item.id !== id);
                    localStorage.setItem('wh_claims_db_pro', JSON.stringify(database));
                }
            } catch (error) {
                database = database.filter(item => item.id !== id);
                localStorage.setItem('wh_claims_db_pro', JSON.stringify(database));
            }
        }

        // 核心功能函数
        function markFormDirty() { isFormDirty = true; }
        function initTheme() {
            // 仅当localStorage中明确设置为dark时才使用深色模式，首次访问默认浅色模式
            if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        }
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        function toggleColumnModal() { document.getElementById('columnModal').classList.toggle('active'); }
        function renderColumnModal() {
            // visibleColumns 在 ui.js 中定义，通过全局作用域访问
            const cols = typeof visibleColumns !== 'undefined' ? visibleColumns : (window.visibleColumns || []);
            document.getElementById('columnCheckboxes').innerHTML = tableColumns.map(col => `
                <label class="flex items-center space-x-2 p-2 rounded hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer">
                    <input type="checkbox" value="${col.key}" ${cols.includes(col.key) ? 'checked' : ''} class="w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500">
                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">${col.label}</span>
                </label>`).join('');
        }
        function saveColumns() {
            const checked = Array.from(document.querySelectorAll('#columnCheckboxes input:checked')).map(cb => cb.value);
            if(checked.length === 0) return alert('至少保留一列');
            // visibleColumns 在 ui.js 中定义，直接赋值即可（它是 let 声明，在模块作用域内）
            if (typeof visibleColumns !== 'undefined') {
                visibleColumns = checked;
            }
            // 同时更新 window 对象，确保全局可访问
            window.visibleColumns = checked;
            localStorage.setItem('wh_claims_cols', JSON.stringify(checked));
            renderTableHeader(); renderDatabase(); toggleColumnModal();
        }
        function resetColumns() {
            const defaultColumns = tableColumns.map(c => c.key).filter(k => k !== 'remarks');
            // visibleColumns 在 ui.js 中定义，直接赋值即可
            if (typeof visibleColumns !== 'undefined') {
                visibleColumns = defaultColumns;
            }
            // 同时更新 window 对象
            window.visibleColumns = defaultColumns;
            document.querySelectorAll('#columnCheckboxes input').forEach(cb => cb.checked = defaultColumns.includes(cb.value));
            // 更新localStorage并刷新界面
            localStorage.setItem('wh_claims_cols', JSON.stringify(defaultColumns));
            renderTableHeader();
            renderDatabase();
        }

        // 渲染表头：增加了全选框 - vxe-table风格增强版
        function renderTableHeader() {
            // 获取当前排序状态
            const currentSort = ListState.sort || {};
            const sortField = currentSort.field || '';
            const sortOrder = currentSort.order || '';
            
            // 复选框列（固定左侧）
            const checkboxTh = `<th class="erp-th text-center col--checkbox is--fixed-left vxe-resizable" style="width: 48px; min-width: 48px;">
                <div class="ak-justify-between ak-align-center">
                    <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" class="w-4 h-4 text-emerald-600 rounded border-slate-300 focus:ring-emerald-500 cursor-pointer bg-slate-100 dark:bg-slate-700 dark:border-slate-600">
                    <div class="vxe-resizable--handle"></div>
                </div>
            </th>`;

            // visibleColumns 在 ui.js 中定义，通过全局作用域访问
            const cols = (typeof visibleColumns !== 'undefined' ? visibleColumns : (window.visibleColumns || []));
            let html = cols.map(key => {
                const col = tableColumns.find(c => c.key === key);
                const isSorted = sortField === key;
                const isAsc = isSorted && sortOrder === 'asc';
                const isDesc = isSorted && sortOrder === 'desc';
                
                // vxe-table风格的排序按钮
                let sortHtml = '';
                if (col.sort) {
                    sortHtml = `
                        <span class="vxe-sort--wrapper" onclick="event.stopPropagation(); sortColumn('${key}')">
                            <i class="vxe-sort--btn vxe-sort--asc-btn ${isAsc ? 'is--active' : ''}" onclick="event.stopPropagation(); sortColumn('${key}', 'asc')" title="升序"></i>
                            <i class="vxe-sort--btn vxe-sort--desc-btn ${isDesc ? 'is--active' : ''}" onclick="event.stopPropagation(); sortColumn('${key}', 'desc')" title="降序"></i>
                        </span>
                    `;
                }
                
                // 复制按钮（仅对海外仓单号和物流运单号列显示）
                let copyBtnHtml = '';
                if (key === 'order_no' || key === 'tracking_no') {
                    copyBtnHtml = `
                        <button id="copyBtn_${key}" onclick="event.stopPropagation(); copyColumnData('${key}')" 
                                class="ml-1 p-0.5 text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors copy-column-btn" 
                                title="复制已选数据" style="display: none;">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                        </button>
                    `;
                }
                
                // 列宽拖拽句柄
                const resizableHandle = col.sort || true ? '<div class="vxe-resizable--handle"></div>' : '';
                
                return `<th ${col.sort ? `onclick="sortColumn('${key}')"` : ''} class="erp-th vxe-resizable ${col.sort ? 'erp-th-sortable' : ''} ${col.center ? 'text-center' : ''}" style="min-width: ${col.minW}; width: ${col.minW};">
                    <div class="ak-justify-between ak-align-center" style="position: relative;">
                        <span>${col.label}${sortHtml}${copyBtnHtml}</span>
                        ${resizableHandle}
                    </div>
                </th>`;
            }).join('');
            
            // 操作列（固定右侧）
            const actionTh = `<th class="erp-th text-center is--fixed-right vxe-resizable" style="min-width: 120px; width: 120px;">
                <div class="ak-justify-between ak-align-center">
                    <span>操作</span>
                    <div class="vxe-resizable--handle"></div>
                </div>
            </th>`;
            
            document.getElementById('tableHeaderRow').innerHTML = checkboxTh + html + actionTh;
            
            // 初始化复制按钮的显示状态
            if (typeof updateCopyButtonsVisibility === 'function') {
                updateCopyButtonsVisibility();
            }
            
            // 初始化列宽拖拽功能
            initColumnResize();
        }

        /**
         * 【P1-2修复】删除重复的 switchSubTab 函数
         * 统一使用 suopei_assets/js/ui.js 中的版本（已在全局作用域暴露）
         * 如果 HTML 中的函数覆盖了 ui.js 中的函数，会导致功能不一致
         * 
         * 注意：ui.js 中的 switchSubTab 函数已经包含了所有必要的功能：
         * - 更新状态筛选
         * - 清空干扰项
         * - 更新按钮样式
         * - 清除缓存
         * - 强制刷新数据
         * - 立即保存页面状态
         */
        
        /**
         * 【状态筛选按钮样式改造】获取各状态的统计数量
         */
        async function updateStatusCounts() {
            if (!supabaseClient) return;
            
            try {
                // 优化：将多个请求合并为一个请求，减少请求数量
                // 使用count()和groupBy()获取所有状态的统计数据
                const { data, error } = await supabaseClient
                    .from('claims_v2')
                    .select('process_status, count()', { count: 'exact' })
                    .group('process_status');
                
                if (error) throw error;
                
                // 构建状态统计映射
                const statusMap = {
                    '待审核': 'pending',
                    '处理中': 'processing', 
                    '等待赔付': 'waiting',
                    '已赔付': 'paid',
                    '已驳回': 'rejected'
                };
                
                const statusCounts = {};
                let totalCount = 0;
                
                // 计算各状态数量和总数量
                data.forEach(item => {
                    const count = parseInt(item.count, 10);
                    statusCounts[item.process_status] = count;
                    totalCount += count;
                });
                
                // 更新"全部"按钮的统计
                const allCountEl = document.getElementById('count-all');
                if (allCountEl) {
                    allCountEl.textContent = `(${totalCount || 0})`;
                }
                
                // 更新各状态按钮的统计
                for (const [status, key] of Object.entries(statusMap)) {
                    const count = statusCounts[status] || 0;
                    const countId = `count-${key}`;
                    const countEl = document.getElementById(countId);
                    if (countEl) {
                        countEl.textContent = `(${count})`;
                    }
                }
            } catch (error) {
                // 如果获取失败，显示0或保持原值
            }
        }
        function getStatusBadge(status) {
            const colors = { '待审核': 'bg-slate-100 text-slate-600', '处理中': 'bg-blue-50 text-blue-600', '等待赔付': 'bg-amber-50 text-orange-600', '已赔付': 'bg-emerald-50 text-emerald-600', '已驳回': 'bg-red-50 text-red-600' };
            return `<span class="erp-badge ${colors[status] || colors['待审核']}">${status}</span>`;
        }
        function openStatusModal(id) { document.getElementById('statusEditId').value = id; document.getElementById('statusModal').classList.add('active'); }
        function closeStatusModal() { document.getElementById('statusModal').classList.remove('active'); }
        
        async function updateStatus(newStatus) {
            const id = document.getElementById('statusEditId').value;
            const index = database.findIndex(i => i.id === id);
            if(index !== -1) {
                // 1. 更新内存中的数据
                const oldStatus = database[index].process_status;
                database[index].process_status = newStatus;
                
                // 2. 更新本地存储
                localStorage.setItem('wh_claims_db_pro', JSON.stringify(database));
                
                // 3. 【修复】同步更新 ListState.data 中对应的项，确保UI能立即反映状态变化
                const listStateIndex = ListState.data.findIndex(i => i.id === id);
                if (listStateIndex !== -1) {
                    ListState.data[listStateIndex].process_status = newStatus;
                    
                    // 【修复】直接更新虚拟滚动管理器内部的数据，并强制重新渲染可见区域
                    const vManager = (typeof window !== 'undefined' && window.virtualScrollManager) ? window.virtualScrollManager : null;
                    if (vManager) {
                        // 更新虚拟滚动管理器内部的数据引用（同步最新的ListState.data）
                        const dataIndex = vManager.data.findIndex(i => i && i.id === id);
                        if (dataIndex !== -1) {
                            vManager.data[dataIndex].process_status = newStatus;
                        }
                        
                        // 强制重新渲染可见区域
                        if (vManager.startIndex >= 0 && vManager.endIndex > vManager.startIndex) {
                            vManager.renderVisibleItems();
                        }
                    }
                }
                
                // 4. 立即刷新UI，确保及时性
                renderKanban(); 
                renderDatabase();
                
                // 5. 同步到后端
                const success = await updateDataInSupabase(id, database[index]);
                
                // 更新状态成功后，重置排序为默认值
                if (typeof window !== 'undefined' && typeof window.resetSortingToDefault === 'function') {
                    window.resetSortingToDefault();
                }
                
                // 6. 【修复】清除所有缓存，确保获取最新数据
                if (typeof window !== 'undefined' && typeof window.clearAllCache === 'function') {
                    window.clearAllCache();
                }
                
                // 7. 【修复】状态更新后，只在必要时刷新数据，避免数据重新排序导致用户找不到刚刚操作的记录
                // 保存当前滚动位置和更新的记录ID，用于刷新后定位
                const container = document.getElementById('dbContent');
                const savedScrollTop = container ? container.scrollTop : 0;
                const updatedItemId = id;
                
                if (ListState.filters.status !== 'all') {
                    // 如果记录更新前在筛选范围内，更新后不在，则需要刷新数据（记录会从列表中消失）
                    if (oldStatus === ListState.filters.status && newStatus !== ListState.filters.status) {
                        // 【修复】使用强制刷新参数，确保获取最新数据
                        if (typeof window !== 'undefined' && typeof window.fetchTableData === 'function') {
                            await window.fetchTableData(false, true); // append=false, forceRefresh=true
                        } else if (typeof fetchTableData === 'function') {
                            await fetchTableData(false, true);
                        }
                        // 恢复滚动位置
                        if (container) {
                            container.scrollTop = savedScrollTop;
                        }
                    } else if (success) {
                        // 【修复】如果更新成功且记录仍在筛选范围内，不刷新数据，只更新当前行显示
                        // 这样数据不会重新排序，用户可以看到刚刚更新的记录
                        // 已经通过上面的代码更新了 ListState.data 和虚拟滚动管理器的数据
                        // 只需要重新渲染可见区域即可
                        const vManager = (typeof window !== 'undefined' && window.virtualScrollManager) ? window.virtualScrollManager : null;
                        if (vManager) {
                            vManager.renderVisibleItems();
                        }
                        // 高亮显示刚刚更新的行
                        setTimeout(() => {
                            const updatedRow = container ? container.querySelector(`tr[data-item-id="${updatedItemId}"]`) : null;
                            if (updatedRow) {
                                updatedRow.classList.add('bg-blue-50', 'dark:bg-blue-900/20');
                                updatedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                // 3秒后移除高亮
                                setTimeout(() => {
                                    updatedRow.classList.remove('bg-blue-50', 'dark:bg-blue-900/20');
                                }, 3000);
                            }
                        }, 100);
                    }
                } else {
                    // 【修复】如果没有状态筛选，不刷新数据，只更新当前行显示，避免数据重新排序
                    // 已经通过上面的代码更新了 ListState.data 和虚拟滚动管理器的数据
                    const vManager = (typeof window !== 'undefined' && window.virtualScrollManager) ? window.virtualScrollManager : null;
                    if (vManager) {
                        vManager.renderVisibleItems();
                    }
                    // 高亮显示刚刚更新的行
                    setTimeout(() => {
                        const updatedRow = container ? container.querySelector(`tr[data-item-id="${updatedItemId}"]`) : null;
                        if (updatedRow) {
                            updatedRow.classList.add('bg-blue-50', 'dark:bg-blue-900/20');
                            updatedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            // 3秒后移除高亮
                            setTimeout(() => {
                                updatedRow.classList.remove('bg-blue-50', 'dark:bg-blue-900/20');
                            }, 3000);
                        }
                    }, 100);
                }
                
                showToast(`状态更新为：${newStatus}`, 'info');
            }
            closeStatusModal();
        }

        // 注意：VirtualScrollManager 类已在 main.js 中定义
        // virtualScrollManager 变量已在 main.js 中声明为全局变量
        // 这里不再重复声明，直接使用全局变量
        
        // 【删除】renderDatabase 函数已移至 main.js，这里不再保留
        // 如果 main.js 中的 renderDatabase 函数已加载，直接使用它
        // 如果需要调用，使用 window.renderDatabase 或直接调用（如果已暴露到全局）
        
        function toggleRowCheckbox(tr) {
            const checkbox = tr.querySelector('.row-checkbox');
            if(checkbox) {
                checkbox.checked = !checkbox.checked;
                updateSelectAllState();
            }
        }

        function renderKanban() {
            const container = document.getElementById('kanban-container');
            const statuses = ['待审核', '处理中', '等待赔付', '已赔付', '已驳回'];
            const dotColors = { '待审核': 'bg-slate-400', '处理中': 'bg-blue-500', '等待赔付': 'bg-amber-500', '已赔付': 'bg-emerald-500', '已驳回': 'bg-red-500' };

            let html = '';
            statuses.forEach(status => {
                const items = database.filter(i => i.process_status === status);
                html += `
                <div class="flex-shrink-0 w-72 bg-slate-100/50 dark:bg-slate-800/50 rounded-2xl border border-slate-200 dark:border-slate-700 flex flex-col max-h-full">
                    <div class="p-3 font-bold text-sm text-slate-600 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center sticky top-0 bg-inherit rounded-t-2xl z-10">
                        <div class="flex items-center"><span class="w-1.5 h-1.5 rounded-full mr-2 inline-block ${dotColors[status]}"></span><span>${status}</span><span class="ml-2 px-2 py-0.5 bg-white dark:bg-slate-700 rounded-full text-xs">${items.length}</span></div>
                    </div>
                    <div class="p-2 overflow-y-auto custom-scrollbar flex-1 space-y-2">
                        ${items.map(item => `
                            <div class="bg-white dark:bg-slate-700 p-3 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm hover:shadow-md transition-all cursor-pointer hover:border-blue-300 group" onclick="openStatusModal('${item.id}')">
                                <div class="flex justify-between items-start mb-2"><span class="font-bold text-blue-600 text-xs">${item.order_no}</span><span class="text-[10px] text-slate-400">${item.entry_date}</span></div>
                                <div class="text-xs text-slate-600 dark:text-slate-300 mb-2 line-clamp-2">${item.description}</div>
                                <div class="flex justify-between items-center"><span class="text-xs font-mono font-bold text-emerald-600">${item.currency||'$'} ${item.claim_total}</span><span class="text-[10px] bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-slate-500">${item.claim_type}</span></div>
                            </div>`).join('')}
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // 注意：trySwitchView 函数已在 ui.js 中定义
        // 此处不再重复定义，直接使用 ui.js 中的版本
        // 如果需要覆盖，使用 window.trySwitchView 或直接调用 ui.js 中的函数

        function updateNavState(activeView) {
            const items = ['nav-form', 'nav-data', 'nav-kanban', 'nav-notice', 'nav-users', 'nav-login-monitor'];
            items.forEach(id => {
                const el = document.getElementById(id);
                if (id === `nav-${activeView}`) {
                    el.className = "flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold bg-blue-50 text-blue-600 transition-all cursor-pointer dark:bg-blue-900/20 dark:text-blue-400";
                } else {
                    el.className = "flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all cursor-pointer dark:text-slate-400 dark:hover:bg-slate-800";
                }
            });
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // 用户登录监控系统功能
        // 注意：这些变量需要在全局作用域中声明，以便ui.js中的trySwitchView函数可以访问
        let onlineUsersData = [];
        window.monitorInterval = null; // 使用window对象确保全局可访问
        
        // 【优化】刷新控制状态
        const MONITOR_REFRESH_INTERVALS = {
            development: 60000,    // 开发环境：60秒
            production: 300000,   // 生产环境：5分钟（300秒）
            manual: null           // 手动模式：不自动刷新
        };
        
        let monitorRefreshState = {
            interval: null,
            isRefreshing: false,
            lastRefreshTime: null,
            refreshInterval: MONITOR_REFRESH_INTERVALS.production
        };
        
        // 页面可见性状态
        let isPageVisible = !document.hidden;
        let isMonitorViewActive = false;
        
        // 监听页面可见性变化
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;
            handleMonitorRefreshState();
        });
        
        // 处理监控刷新状态
        function handleMonitorRefreshState() {
            // 同步全局状态
            if (typeof window !== 'undefined') {
                window.isMonitorViewActive = isMonitorViewActive;
            }
            
            if (isMonitorViewActive && isPageVisible) {
                // 页面可见且监控视图激活，启动自动刷新
                startMonitorAutoRefresh();
            } else {
                // 页面不可见或监控视图未激活，暂停自动刷新
                stopMonitorAutoRefresh();
            }
        }
        
        // 启动自动刷新
        function startMonitorAutoRefresh() {
            // 清除现有定时器
            stopMonitorAutoRefresh();
            
            // 如果设置为手动模式，不启动自动刷新
            if (!monitorRefreshState.refreshInterval) {
                return;
            }
            
            // 启动定时器
            monitorRefreshState.interval = setInterval(() => {
                if (!monitorRefreshState.isRefreshing) {
                    updateMonitorView();
                    monitorRefreshState.lastRefreshTime = new Date();
                    updateLastRefreshTime();
                }
            }, monitorRefreshState.refreshInterval);
        }
        
        // 停止自动刷新
        function stopMonitorAutoRefresh() {
            if (monitorRefreshState.interval) {
                clearInterval(monitorRefreshState.interval);
                monitorRefreshState.interval = null;
            }
        }
        
        // 暴露到全局，供 ui.js 调用
        window.stopMonitorAutoRefresh = stopMonitorAutoRefresh;
        window.isMonitorViewActive = false; // 初始状态为 false
        
        // 手动刷新
        window.manualRefreshMonitor = async function() {
            if (monitorRefreshState.isRefreshing) {
                return; // 正在刷新，忽略重复请求
            }
            
            monitorRefreshState.isRefreshing = true;
            updateRefreshButtonState(true);
            
            try {
                await updateMonitorView();
                monitorRefreshState.lastRefreshTime = new Date();
                updateLastRefreshTime();
                
                if (typeof showToast === 'function') {
                    showToast('数据已刷新', 'success');
                }
            } catch (error) {
                console.error('刷新失败:', error);
                if (typeof showToast === 'function') {
                    showToast('刷新失败，请稍后重试', 'error');
                }
            } finally {
                monitorRefreshState.isRefreshing = false;
                updateRefreshButtonState(false);
            }
        };
        
        // 更新刷新按钮状态
        function updateRefreshButtonState(isRefreshing) {
            const refreshBtn = document.getElementById('monitor-refresh-btn');
            const refreshIcon = refreshBtn?.querySelector('.refresh-icon');
            
            if (!refreshBtn) return;
            
            if (isRefreshing) {
                refreshBtn.disabled = true;
                refreshBtn.classList.add('refreshing');
                if (refreshIcon) {
                    refreshIcon.classList.add('animate-spin');
                }
                const span = refreshBtn.querySelector('span');
                if (span) span.textContent = '刷新中...';
            } else {
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('refreshing');
                if (refreshIcon) {
                    refreshIcon.classList.remove('animate-spin');
                }
                const span = refreshBtn.querySelector('span');
                if (span) span.textContent = '刷新';
            }
        }
        
        // 更新最后刷新时间显示
        function updateLastRefreshTime() {
            const timeEl = document.getElementById('last-refresh-time');
            if (!timeEl) return;
            
            if (!monitorRefreshState.lastRefreshTime) {
                timeEl.textContent = '最后更新：--';
                return;
            }
            
            const now = new Date();
            const diff = Math.floor((now - monitorRefreshState.lastRefreshTime) / 1000);
            
            let timeText = '';
            if (diff < 60) {
                timeText = `${diff}秒前`;
            } else if (diff < 3600) {
                timeText = `${Math.floor(diff / 60)}分钟前`;
            } else {
                timeText = `${Math.floor(diff / 3600)}小时前`;
            }
            
            timeEl.textContent = `最后更新：${timeText}`;
        }
        
        // 定期更新最后刷新时间显示（每30秒）
        setInterval(updateLastRefreshTime, 30000);
        
        // 格式化相对时间
        function formatRelativeTime(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffMinutes < 1) return '刚刚';
            if (diffMinutes < 60) return `${diffMinutes}分钟前`;
            if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}小时前`;
            return `${Math.floor(diffMinutes / 1440)}天前`;
        }
        
        // 更新在线用户列表
        async function updateOnlineUsersList() {
            const tableBody = document.getElementById('onlineUsersTableBody');
            if (!tableBody) return;
            
            // 显示加载状态
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-slate-400 text-sm">
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-3"></div>
                            <span>正在获取在线用户列表...</span>
                        </div>
                    </td>
                </tr>
            `;
            
            try {
                if (!supabaseClient) {
                    // 显示Supabase连接失败提示
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center">
                                <div class="flex flex-col items-center">
                                    <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center mb-3">
                                        <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </div>
                                    <h3 class="text-sm font-bold text-red-600 dark:text-red-400 mb-1">连接失败</h3>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-3 max-w-xs">无法连接到服务器，请检查网络连接或联系管理员</p>
                                    <button onclick="updateMonitorView()" class="px-3 py-1 text-xs font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 dark:text-blue-400 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                                        重试
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // 获取最近5分钟内活跃的用户（在线用户）
                const { data: onlineUsers, error } = await supabaseClient
                    .from('users_v2')
                    .select('username, email, role, last_active_at, id')
                    .gte('last_active_at', new Date(Date.now() - 5 * 60 * 1000).toISOString())
                    .order('last_active_at', { ascending: false });
                
                if (error) {
                    // 显示查询错误提示
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center">
                                <div class="flex flex-col items-center">
                                    <div class="w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center mb-3">
                                        <svg class="w-6 h-6 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                    </div>
                                    <h3 class="text-sm font-bold text-amber-600 dark:text-amber-400 mb-1">数据获取失败</h3>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-3 max-w-xs">无法获取在线用户数据，请稍后重试</p>
                                    <button onclick="updateMonitorView()" class="px-3 py-1 text-xs font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 dark:text-blue-400 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                                        重试
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // 数据有效性检查
                if (!Array.isArray(onlineUsers)) {
                    throw new Error('获取的在线用户数据格式不正确');
                }
                
                onlineUsersData = onlineUsers;
                
                // 获取每个在线用户的最新登录记录（用于获取登录IP）
                const usersWithLoginInfo = await Promise.all(onlineUsers.map(async (user) => {
                    // 验证用户数据完整性
                    if (!user || !user.id) {
                        return {
                            username: '未知用户',
                            email: 'unknown@example.com',
                            role: 'user',
                            ip: '未知',
                            loginTime: '未知'
                        };
                    }
                    
                    // 【修复】移除 .single()，避免在查询结果为空时返回 406 错误
                    const { data: loginRecords, error: loginError } = await supabaseClient
                        .from('login_history')
                        .select('ip_address, login_at')
                        .eq('user_id', user.id)
                        .order('login_at', { ascending: false })
                        .limit(1);
                    
                    // 获取第一条记录（如果存在）
                    const loginRecord = loginRecords && loginRecords.length > 0 ? loginRecords[0] : null;
                    
                    if (loginError) {
                        // 获取用户登录记录失败，静默处理（可能是用户没有登录记录）
                    }
                    
                    return {
                        ...user,
                        ip: loginRecord?.ip_address || '未知',
                        loginTime: loginRecord ? formatRelativeTime(loginRecord.login_at) : '未知'
                    };
                }));
                
                // 渲染在线用户列表
                if (usersWithLoginInfo.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center text-slate-400 text-sm">
                                <div class="flex flex-col items-center">
                                    <span>当前没有在线用户</span>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = usersWithLoginInfo.map((user) => `
                        <tr class="transition-all hover:bg-slate-50 dark:hover:bg-slate-700/50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full ${user.role === 'admin' ? 'bg-blue-100 dark:bg-blue-900/30' : 'bg-green-100 dark:bg-green-900/30'} flex items-center justify-center mr-3">
                                        <svg class="w-4 h-4 ${user.role === 'admin' ? 'text-blue-600 dark:text-blue-400' : 'text-green-600 dark:text-green-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    </div>
                                    <div class="text-sm font-medium text-slate-900 dark:text-white">${user.username || '未命名'}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${user.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'admin' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300' : 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'}">${user.role === 'admin' ? '管理员' : '普通用户'}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${user.loginTime}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${user.ip}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                // 显示通用错误提示
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center">
                            <div class="flex flex-col items-center">
                                <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center mb-3">
                                    <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <h3 class="text-sm font-bold text-red-600 dark:text-red-400 mb-1">系统错误</h3>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mb-3 max-w-xs">处理请求时发生错误，请稍后重试</p>
                                <button onclick="updateMonitorView()" class="px-3 py-1 text-xs font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 dark:text-blue-400 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                                    重试
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        // 更新在线用户统计
        async function updateOnlineStats() {
            // 获取统计元素
            const onlineCountEl = document.getElementById('online-users-count');
            const todayLoginEl = document.querySelector('#view-login-monitor .glass-card:nth-child(2) .text-3xl');
            const activeUsersEl = document.querySelector('#view-login-monitor .glass-card:nth-child(3) .text-3xl');
            
            if (!onlineCountEl || !todayLoginEl || !activeUsersEl) return;
            
            // 显示加载状态
            const loadingText = '...';
            onlineCountEl.textContent = loadingText;
            todayLoginEl.textContent = loadingText;
            activeUsersEl.textContent = loadingText;
            
            try {
                if (!supabaseClient) {
                    // 显示连接失败状态
                    onlineCountEl.textContent = 'N/A';
                    todayLoginEl.textContent = 'N/A';
                    activeUsersEl.textContent = 'N/A';
                    return;
                }
                
                // 1. 获取当前在线用户数（最近5分钟内活跃）
                const { count: onlineCount, error: onlineError } = await supabaseClient
                    .from('users_v2')
                    .select('id', { count: 'exact' })
                    .gte('last_active_at', new Date(Date.now() - 5 * 60 * 1000).toISOString());
                
                if (onlineError) {
                    onlineCountEl.textContent = 'N/A';
                } else {
                    // 验证数据有效性
                    const validOnlineCount = Number.isInteger(onlineCount) ? onlineCount : 0;
                    onlineCountEl.textContent = validOnlineCount;
                }
                
                // 2. 获取今日登录次数
                const todayStart = new Date(new Date().setHours(0, 0, 0, 0)).toISOString();
                const { count: todayLoginCount, error: loginError } = await supabaseClient
                    .from('login_history')
                    .select('id', { count: 'exact' })
                    .gte('login_at', todayStart);
                
                if (loginError) {
                    todayLoginEl.textContent = 'N/A';
                } else {
                    // 验证数据有效性
                    const validTodayLoginCount = Number.isInteger(todayLoginCount) ? todayLoginCount : 0;
                    todayLoginEl.textContent = validTodayLoginCount;
                }
                
                // 3. 获取活跃用户数（最近7天内活跃）
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
                const { count: activeUsersCount, error: activeError } = await supabaseClient
                    .from('users_v2')
                    .select('id', { count: 'exact' })
                    .gte('last_active_at', weekAgo);
                
                if (activeError) {
                    activeUsersEl.textContent = 'N/A';
                } else {
                    // 验证数据有效性
                    const validActiveUsersCount = Number.isInteger(activeUsersCount) ? activeUsersCount : 0;
                    activeUsersEl.textContent = validActiveUsersCount;
                }
            } catch (error) {
                // 显示错误状态
                onlineCountEl.textContent = 'N/A';
                todayLoginEl.textContent = 'N/A';
                activeUsersEl.textContent = 'N/A';
            }
        }
        
        // 更新监控视图
        async function updateMonitorView() {
            await Promise.all([updateOnlineUsersList(), updateOnlineStats()]);
        }
        
        // 初始化登录监控系统（全局函数，供ui.js调用）- 优化版
        window.initLoginMonitor = function() {
            // 标记监控视图已激活
            isMonitorViewActive = true;
            
            // 立即执行一次刷新
            updateMonitorView();
            monitorRefreshState.lastRefreshTime = new Date();
            updateLastRefreshTime();
            
            // 根据页面可见性决定是否启动自动刷新
            handleMonitorRefreshState();
        };

        function getFormDataFromInput() {
            return {
                id: editingId || generateUUID(),
        cust_name: document.getElementById('cust_name').value, 
        contact_name: document.getElementById('contact_name').value, 
        contact_info: document.getElementById('contact_info').value,
        store_by: document.getElementById('store_by').value,
        order_no: document.getElementById('order_no').value.trim(), 
        tracking_no: document.getElementById('tracking_no').value, 
        ship_date: document.getElementById('ship_date').value, 
        sku: document.getElementById('sku').value, 
        warehouse: document.getElementById('warehouse').value,
        claim_type: document.getElementById('claim_type').value, 
        description: document.getElementById('description').value, 
        currency: document.getElementById('currency').value, 
        val_amount: document.getElementById('val_amount').value, 
        claim_qty: document.getElementById('claim_qty').value, 
        claim_total: document.getElementById('claim_total').value, 
        liable_party: document.getElementById('liable_party').value,
        claim_ratio: document.getElementById('claim_ratio').value,
        attachments: document.getElementById('attachments').value,
        remarks: document.getElementById('remarks').value,
// entry_date 现在是 timestamp 类型，如果用户选择了日期，转换为当天的开始时间（00:00:00）
// 如果没有选择，使用当前时间戳
entry_date: (() => {
    const dateValue = document.getElementById('entry_date').value;
    if (dateValue) {
        // 将日期字符串转换为当天的开始时间戳
        return new Date(dateValue + 'T00:00:00').toISOString();
    } else {
        // 使用当前时间戳
        return new Date().toISOString();
    }
})(),
process_status: document.getElementById('process_status').value, remarks: document.getElementById('remarks').value
            };
        }

        async function processEntry() {
            const form = document.getElementById('claimForm'); 
            if (!form.checkValidity()) {
                return form.reportValidity();
            }
            
            const inputOrderNo = document.getElementById('order_no').value.trim();
            
            const isDuplicate = database.some(item => {
                if (editingId && item.id === editingId) return false;
                return item.order_no === inputOrderNo;
            });
            if(isDuplicate) {
                showToast('错误：该海外仓单号已存在，请勿重复添加！', 'error');
                return;
            }

            const record = getFormDataFromInput();
            
            if (editingId) {
                const index = database.findIndex(i => i.id === editingId);
                if (index !== -1) { 
                    database[index] = record; 
                    await updateDataInSupabase(editingId, record);
                    localStorage.setItem('wh_claims_db_pro', JSON.stringify(database));
                    
                    // 【修复】编辑后强制刷新数据（跳过缓存），确保修改后的数据能立即显示
                    if (typeof window.fetchTableData === 'function') {
                        await window.fetchTableData(false, true); // forceRefresh=true 跳过缓存
                    } else if (typeof fetchTableData === 'function') {
                        await fetchTableData(false, true); // forceRefresh=true 跳过缓存
                    } else {
                        // fetchTableData函数未定义，等待模块加载
                        await new Promise((resolve) => {
                            setTimeout(async () => {
                                if (typeof window.fetchTableData === 'function') {
                                    await window.fetchTableData(false, true);
                                } else if (typeof fetchTableData === 'function') {
                                    await fetchTableData(false, true);
                                }
                                resolve();
                            }, 100);
                        });
                    }
                    renderKanban(); // 更新看板视图
                    showToast('数据修改已保存', 'success'); 
                    cancelEditMode(); 
                    return; 
                }
            } else { 
                database.unshift(record); 
                await saveDataToSupabase();
                localStorage.setItem('wh_claims_db_pro', JSON.stringify(database)); 
                
                // 【修复】提交后强制刷新数据（跳过缓存），确保新数据能立即显示
                if (typeof window.fetchTableData === 'function') {
                    await window.fetchTableData(false, true); // forceRefresh=true 跳过缓存
                } else if (typeof fetchTableData === 'function') {
                    await fetchTableData(false, true); // forceRefresh=true 跳过缓存
                } else {
                    // fetchTableData函数未定义，等待模块加载
                    await new Promise((resolve) => {
                        setTimeout(async () => {
                            if (typeof window.fetchTableData === 'function') {
                                await window.fetchTableData(false, true);
                            } else if (typeof fetchTableData === 'function') {
                                await fetchTableData(false, true);
                            }
                            resolve();
                        }, 100);
                    });
                }
                renderKanban(); // 更新看板视图
                showToast('提交成功', 'success'); 
                
                // 保存后导航回数据列表模块
                isFormDirty = false;
                editingId = null;
                form.reset(); 
                
                // 重置页面状态
                document.getElementById('cust_name').value = "深圳市信凯源科技有限公司";
                document.getElementById('contact_name').value = "沈学章";
                document.getElementById('contact_info').value = "shenxz1989@foxmail.com";
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                document.getElementById('entry_date').value = `${year}-${month}-${day}`;
                document.getElementById('currency').value = 'USD'; 
                document.getElementById('process_status').value = '待审核';
                
                // 切换回数据列表视图（trySwitchView 中会再次强制刷新，确保数据最新）
                await switchView('data');
            }
        }



 async function editRowById(id) {
    const item = database.find(i => i.id === id); 
    if (!item) return;
    
    await trySwitchView('form');
    document.getElementById('liable_party').value = item.liable_party || '待核实'; 
    document.getElementById('claim_ratio').value = item.claim_ratio || '100'; 
    document.getElementById('attachments').value = item.attachments || ''; 
    document.getElementById('remarks').value = item.remarks || '';
    document.getElementById('cust_name').value = item.cust_name || ''; 
    document.getElementById('contact_name').value = item.contact_name || ''; 
    document.getElementById('contact_info').value = item.contact_info || '';
    document.getElementById('store_by').value = item.store_by || '';
    document.getElementById('order_no').value = item.order_no || ''; 
    document.getElementById('tracking_no').value = item.tracking_no || ''; 
    document.getElementById('ship_date').value = item.ship_date || '';
    document.getElementById('sku').value = item.sku || ''; 
    document.getElementById('warehouse').value = item.warehouse || ''; 
    document.getElementById('claim_type').value = item.claim_type || '货物损坏';
    document.getElementById('description').value = item.description || ''; 
    document.getElementById('currency').value = item.currency || 'USD';
    document.getElementById('val_amount').value = item.val_amount || ''; 
    document.getElementById('claim_qty').value = item.claim_qty || ''; 
    document.getElementById('claim_total').value = item.claim_total || ''; 
    document.getElementById('process_status').value = item.process_status || '待审核'; 
let dateValue = item.entry_date || '';
if (dateValue && dateValue.length >= 10) {
    dateValue = dateValue.substring(0, 10);
}
document.getElementById('entry_date').value = dateValue;
            document.getElementById('process_status').value = item.process_status || '待审核'; 
            document.getElementById('remarks').value = item.remarks || '';
    editingId = id; 
    document.getElementById('submitBtnText').innerText = "确认修改"; 
    document.getElementById('cancelEditBtn').classList.remove('hidden'); 
    showToast('已进入编辑模式', 'info');
        }

        async function cancelEditMode() {
            editingId = null; 
            document.getElementById('claimForm').reset(); 
            document.getElementById('cust_name').value = "深圳市信凯源科技有限公司";
            document.getElementById('contact_name').value = "沈学章";
            document.getElementById('contact_info').value = "shenxz1989@foxmail.com";
            document.getElementById('submitBtnText').innerText = "确认提交并保存"; 
            document.getElementById('cancelEditBtn').classList.add('hidden'); 
            isFormDirty = false;
            await trySwitchView('data'); 
        }

        async function deleteRowById(id) {
            if(confirm('确定删除该条记录吗？')) {
                database = database.filter(i => i.id !== id); 
                await deleteDataFromSupabase(id);
                localStorage.setItem('wh_claims_db_pro', JSON.stringify(database));
                if(editingId === id) cancelEditMode(); else { renderKanban(); fetchTableData(); } 
                showToast('记录已删除', 'error');
            }
        }

        function downloadRowById(id) {
            const item = database.find(i => i.id === id);
            if(item) { exportSingleExcel(item); showToast('正在导出...', 'success'); } 
            else { showToast('未找到记录', 'error'); }
        }

        function initCharts() {
            // 【修复】检查两个图表实例，防止重复创建
            if (lineChartInstance && pieChartInstance) {
                return; // 都已创建，直接返回
            }
            
            const months = [];
            const dataPoints = [];
            const today = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                months.push(`${d.getMonth() + 1}月`);
                const sum = database.filter(item => {
                    if (!item.entry_date) return false;
                    const parts = item.entry_date.split('-');
                    if (parts.length < 2) return false;
                    const itemYear = parseInt(parts[0]);
                    const itemMonth = parseInt(parts[1]) - 1;
                    return itemMonth === d.getMonth() && itemYear === d.getFullYear();
                }).reduce((acc, curr) => acc + (parseFloat(curr.claim_total) || 0), 0);
                dataPoints.push(sum);
            }
            
            // 【修复】只在未创建时创建折线图
            if (!lineChartInstance) {
                const lineCtx = document.getElementById('lineChart');
                if (lineCtx) {
                    lineChartInstance = new Chart(lineCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                                label: '索赔金额',
                                data: dataPoints,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { display: true, grid: { display: false } },
                                x: { display: true, grid: { display: false } }
                            }
                        }
                    });
                }
            }
            
            // 【修复】只在未创建时创建饼图
            if (!pieChartInstance) {
                const pieCtx = document.getElementById('pieChart');
                if (pieCtx) {
                    pieChartInstance = new Chart(pieCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            cutout: '70%'
                        }
                    });
                }
            }
        }

        // 渲染分页控件
        function renderPaginationControls() {
            const paginationContainer = document.getElementById('pagination-container');
            if (!paginationContainer) return;
            
            const totalPages = Math.ceil(ListState.totalCount / ListState.pagination.pageSize);
            const currentPage = ListState.pagination.page;
            
            let paginationHTML = `
                <div class="flex items-center justify-between p-4 border-t border-slate-100">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-slate-600 dark:text-slate-100 font-medium">显示行数：</span>
                        <select id="page-size-select" class="text-sm border-2 border-slate-300 dark:border-slate-500 rounded-md px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-700 text-slate-800 dark:text-white font-medium">
            `;
            
            ListState.pagination.pageSizeOptions.forEach(size => {
                paginationHTML += `<option value="${size}" ${ListState.pagination.pageSize === size ? 'selected' : ''}>${size}</option>`;
            });
            
            paginationHTML += `
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-slate-600 dark:text-slate-100 font-medium">共 ${ListState.totalCount} 条记录，第 ${currentPage} / ${totalPages} 页</span>
                        <button id="prev-page" class="px-3 py-1.5 bg-white dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-500 rounded-md text-sm text-slate-700 dark:text-white font-medium hover:bg-slate-50 dark:hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" ${currentPage === 1 ? 'disabled' : ''}>
                            上一页
                        </button>
                        <button id="next-page" class="px-3 py-1.5 bg-white dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-500 rounded-md text-sm text-slate-700 dark:text-white font-medium hover:bg-slate-50 dark:hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" ${currentPage < totalPages ? '' : 'disabled'}>
                            下一页
                        </button>
                    </div>
                </div>
            `;
            
            paginationContainer.innerHTML = paginationHTML;
            
            // 为下拉框添加事件监听
            document.getElementById('page-size-select').addEventListener('change', (e) => {
                ListState.pagination.pageSize = parseInt(e.target.value);
                ListState.pagination.page = 1; // 切换每页条数时重置到第一页
                localStorage.setItem('wh_claims_pageSize', ListState.pagination.pageSize);
                if (typeof window.fetchTableData === 'function') {
                    window.fetchTableData();
                } else if (typeof fetchTableData === 'function') {
                    fetchTableData();
                } else {
                    // fetchTableData函数未定义，等待模块加载
                    setTimeout(() => {
                        if (typeof window.fetchTableData === 'function') {
                            window.fetchTableData();
                        }
                    }, 100);
                }
            });
            
            // 为上一页按钮添加事件监听
            document.getElementById('prev-page').addEventListener('click', () => {
                if (ListState.pagination.page > 1) {
                    ListState.pagination.page--;
                    if (typeof window.fetchTableData === 'function') {
                        window.fetchTableData();
                    } else if (typeof fetchTableData === 'function') {
                        fetchTableData();
                    }
                }
            });
            
            // 为下一页按钮添加事件监听
            document.getElementById('next-page').addEventListener('click', () => {
                if (ListState.pagination.page < totalPages) {
                    ListState.pagination.page++;
                    if (typeof window.fetchTableData === 'function') {
                        window.fetchTableData();
                    } else if (typeof fetchTableData === 'function') {
                        fetchTableData();
                    }
                }
            });
        }

        function updatePieChart(data) {
            if (!pieChartInstance) return;
            const typeCounts = {};
            data.forEach(i => typeCounts[i.claim_type] = (typeCounts[i.claim_type] || 0) + 1);
            pieChartInstance.data.labels = Object.keys(typeCounts);
            pieChartInstance.data.datasets[0].data = Object.values(typeCounts);
            pieChartInstance.update();
            if(lineChartInstance) lineChartInstance.update(); 
        }

        /**
         * 【优化】快速搜索处理函数 - 限制搜索字段为海外仓单号、物流运单号、订单SKU
         * 同时处理快速筛选（发货仓、索赔类型、发货日期、申请提交日期）
         */
        function handleQuickSearch() {
            const quickSearchInput = document.getElementById('quickSearch');
            if (!quickSearchInput) return;
            
            const searchValue = quickSearchInput.value.trim();
            const searchModeSelect = document.getElementById('searchModeSelect');
            const searchMode = searchModeSelect ? searchModeSelect.value : 'fuzzy';
            
            // 【修复】获取快速筛选字段（所属店铺、发货仓、索赔类型、发货日期、申请提交日期）
            const quickFilterStoreBy = document.getElementById('quickFilterStoreBy')?.value?.trim() || '';
            const quickFilterWarehouse = document.getElementById('quickFilterWarehouse')?.value?.trim() || '';
            const quickFilterClaimType = document.getElementById('quickFilterClaimType')?.value?.trim() || '';
            const quickFilterShipDateStart = document.getElementById('quickFilterShipDateStart')?.value?.trim() || '';
            const quickFilterShipDateEnd = document.getElementById('quickFilterShipDateEnd')?.value?.trim() || '';
            const quickFilterEntryDateStart = document.getElementById('quickFilterEntryDateStart')?.value?.trim() || '';
            const quickFilterEntryDateEnd = document.getElementById('quickFilterEntryDateEnd')?.value?.trim() || '';
            
            // 检查是否有快速筛选条件
            const hasQuickFilters = !!(quickFilterStoreBy || quickFilterWarehouse || quickFilterClaimType || 
                                     quickFilterShipDateStart || quickFilterShipDateEnd || 
                                     quickFilterEntryDateStart || quickFilterEntryDateEnd);
            
            // 【优化】限制搜索字段为：海外仓单号(order_no)、物流运单号(tracking_no)、订单SKU(sku)
            // 设置搜索字段为这三个字段的组合
            ListState.filters.search = searchValue;
            ListState.filters.searchMode = searchMode;
            ListState.filters.searchField = 'order_tracking_sku'; // 自定义字段标识，用于标识只搜索这三个字段
            
            // 【修复】清空旧的type筛选，避免与快速筛选的claim_type冲突
            // 当使用快速筛选的索赔类型时，应该忽略旧的type筛选
            if (quickFilterClaimType) {
                ListState.filters.type = 'all'; // 清空旧的type筛选
            }
            
            // 构建筛选条件对象
            const allFilters = {};
            
            // 【修复】快速筛选字段映射到数据库字段
            // 1. 所属店铺 -> store_by（对应明细列表中的"所属店铺"字段）
            if (quickFilterStoreBy) {
                // 【修复】确保值完全匹配，去除首尾空格
                const storeByValue = quickFilterStoreBy.trim();
                allFilters.store_by = storeByValue;
            }
            
            // 2. 发货仓 -> warehouse（对应明细列表中的"发货仓"字段）
            if (quickFilterWarehouse) {
                // 【修复】确保值完全匹配，去除首尾空格
                const warehouseValue = quickFilterWarehouse.trim();
                allFilters.warehouse = warehouseValue;
            }
            
            // 3. 索赔类型 -> claim_type（对应明细列表中的"索赔类型"字段）
            if (quickFilterClaimType) {
                // 【修复】确保值完全匹配，去除首尾空格
                const claimTypeValue = quickFilterClaimType.trim();
                allFilters.claim_type = claimTypeValue;
            }
            
            // 4. 发货日期 -> ship_date（对应明细列表中的"发货日期"字段）
            if (quickFilterShipDateStart) {
                allFilters.ship_date_start = quickFilterShipDateStart;
            }
            if (quickFilterShipDateEnd) {
                allFilters.ship_date_end = quickFilterShipDateEnd;
            }
            
            // 5. 申请提交日期 -> entry_date（对应明细列表中的"申请提交日期"字段）
            if (quickFilterEntryDateStart) {
                allFilters.entry_date_start = quickFilterEntryDateStart;
            }
            if (quickFilterEntryDateEnd) {
                allFilters.entry_date_end = quickFilterEntryDateEnd;
            }
            
            // 设置高级筛选条件
            // 【修复】即使没有搜索关键词，只要有筛选条件就应该应用
            if (Object.keys(allFilters).length > 0) {
                ListState.filters.advancedFilters = allFilters;
            } else {
                ListState.filters.advancedFilters = null;
            }
            
            // 如果没有搜索关键词也没有筛选条件，清空所有筛选
            if (!searchValue && !hasQuickFilters) {
                ListState.filters.advancedFilters = null;
                // 【清理】advancedSearch 已废弃，但保留清空操作以确保兼容性
                ListState.filters.advancedSearch = null;
            }
            
            // 重置到第一页并强制刷新数据
            ListState.pagination.page = 1;
            
            // 【修复】确保使用全局的fetchTableData函数，并强制刷新
            // 使用window.fetchTableData确保调用正确的函数，并强制刷新（跳过缓存）
            if (typeof window.fetchTableData === 'function') {
                window.fetchTableData(false, true); // append=false, forceRefresh=true
            } else if (typeof fetchTableData === 'function') {
                fetchTableData(false, true); // append=false, forceRefresh=true
            } else {
                alert('搜索功能异常：无法找到数据获取函数，请刷新页面重试。');
            }
        }
        
        
        /**
         * 【优化】重置所有筛选条件 - 包括快速筛选字段
         */
        function handleResetFilters() {
            const quickSearchInput = document.getElementById('quickSearch');
            if (quickSearchInput) {
                quickSearchInput.value = '';
            }
            
            // 【新增】重置快速筛选字段（所属店铺、发货仓、索赔类型、发货日期、申请提交日期）
            const quickFilterStoreBy = document.getElementById('quickFilterStoreBy');
            if (quickFilterStoreBy) quickFilterStoreBy.value = '';
            
            const quickFilterWarehouse = document.getElementById('quickFilterWarehouse');
            if (quickFilterWarehouse) quickFilterWarehouse.value = '';
            
            const quickFilterClaimType = document.getElementById('quickFilterClaimType');
            if (quickFilterClaimType) quickFilterClaimType.value = '';
            
            const quickFilterShipDateStart = document.getElementById('quickFilterShipDateStart');
            if (quickFilterShipDateStart) quickFilterShipDateStart.value = '';
            
            const quickFilterShipDateEnd = document.getElementById('quickFilterShipDateEnd');
            if (quickFilterShipDateEnd) quickFilterShipDateEnd.value = '';
            
            const quickFilterEntryDateStart = document.getElementById('quickFilterEntryDateStart');
            if (quickFilterEntryDateStart) quickFilterEntryDateStart.value = '';
            
            const quickFilterEntryDateEnd = document.getElementById('quickFilterEntryDateEnd');
            if (quickFilterEntryDateEnd) quickFilterEntryDateEnd.value = '';
            
            // 重置状态按钮
            const statusBtns = document.querySelectorAll('.filter-status-btn');
            if (statusBtns.length > 0) {
                statusBtns.forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'dark:bg-blue-600', 'border-blue-500', 'dark:border-blue-600', 'text-white', 'shadow-sm');
                    btn.classList.add('bg-white', 'dark:bg-slate-700', 'border-slate-200', 'dark:border-slate-600', 'text-slate-600', 'dark:text-slate-300');
                });
                statusBtns[0].classList.remove('bg-white', 'dark:bg-slate-700', 'border-slate-200', 'dark:border-slate-600', 'text-slate-600', 'dark:text-slate-300');
                statusBtns[0].classList.add('bg-blue-500', 'dark:bg-blue-600', 'border-blue-500', 'dark:border-blue-600', 'text-white', 'shadow-sm');
            }
            
            // 重置ListState
            ListState.filters.search = '';
            ListState.filters.status = 'all';
            ListState.filters.advancedFilters = null;
            // 【清理】advancedSearch 已废弃，但保留清空操作以确保兼容性
            ListState.filters.advancedSearch = null;
            ListState.filters.searchField = 'order_tracking_sku'; // 重置为默认搜索字段
            
            const processStatusInput = document.getElementById('processStatusInput');
            if (processStatusInput) {
                processStatusInput.value = 'all';
            }
            
            // 重置状态筛选按钮
            if (typeof switchSubTab === 'function') {
                switchSubTab('all');
            }
            
            // 重新加载数据
            ListState.pagination.page = 1;
            
            // 【修复】强制刷新数据，跳过缓存
            if (typeof window.fetchTableData === 'function') {
                window.fetchTableData(false, true); // append=false, forceRefresh=true
            } else if (typeof fetchTableData === 'function') {
                fetchTableData(false, true); // append=false, forceRefresh=true
            }
        }
        
        /**
         * 【高级搜索重构】初始化状态按钮交互
         */
        function initFilterStatusButtons() {
            const statusBtns = document.querySelectorAll('.filter-status-btn');
            const processStatusInput = document.getElementById('processStatusInput');
            
            // 先移除所有现有的事件监听器（通过克隆节点）
            statusBtns.forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
            });
            
            // 重新获取按钮列表（因为已经替换了）
            const newStatusBtns = document.querySelectorAll('.filter-status-btn');
            
            newStatusBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const status = this.getAttribute('data-status');
                    
                    // 更新所有按钮样式
                    newStatusBtns.forEach(b => {
                        b.classList.remove('bg-blue-500', 'dark:bg-blue-600', 'border-blue-500', 'dark:border-blue-600', 'text-white', 'shadow-sm');
                        b.classList.add('bg-white', 'dark:bg-slate-700', 'border-slate-200', 'dark:border-slate-600', 'text-slate-600', 'dark:text-slate-300');
                    });
                    
                    // 激活当前按钮
                    this.classList.remove('bg-white', 'dark:bg-slate-700', 'border-slate-200', 'dark:border-slate-600', 'text-slate-600', 'dark:text-slate-300');
                    this.classList.add('bg-blue-500', 'dark:bg-blue-600', 'border-blue-500', 'dark:border-blue-600', 'text-white', 'shadow-sm');
                    
                    // 更新隐藏输入值（确保搜索时能正确读取）
                    if (processStatusInput) {
                        processStatusInput.value = status === 'all' ? '全部' : status;
                    }
                    
                    // 更新状态筛选（与顶部状态按钮同步）
                    if (status === 'all') {
                        ListState.filters.status = 'all';
                        // 同步顶部状态按钮
                        if (typeof switchSubTab === 'function') {
                            switchSubTab('all');
                        }
                    } else {
                        ListState.filters.status = status;
                        // 同步顶部状态按钮
                        if (typeof switchSubTab === 'function') {
                            switchSubTab(status);
                        }
                    }
                    
                    // 注意：这里不自动应用筛选，让用户点击搜索按钮时统一应用
                    // 如果需要在点击状态按钮时立即搜索，可以取消下面的注释
                    // ListState.pagination.page = 1;
                    // fetchTableData();
                });
            });
        }
        // 【vxe-table风格】增强排序函数 - 支持直接指定排序方向
        function sortColumn(col, order) {
            if (!order) {
                // 如果没有指定order，则切换排序方向
                if (ListState.sort && ListState.sort.field === col) {
                    ListState.sort.order = ListState.sort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    ListState.sort = { field: col, order: 'asc' };
                }
            } else {
                // 直接设置排序方向
                ListState.sort = { field: col, order: order };
            }
            ListState.pagination.page = 1; // 排序时重置到第一页
            if (typeof window.fetchTableData === 'function') {
                window.fetchTableData();
            } else if (typeof fetchTableData === 'function') {
                fetchTableData();
            } else {
                // fetchTableData函数未定义，等待模块加载
                setTimeout(() => {
                    if (typeof window.fetchTableData === 'function') {
                        window.fetchTableData();
                    }
                }, 100);
            }
        }
        
        // 【vxe-table风格】初始化列宽拖拽功能
        function initColumnResize() {
            const handles = document.querySelectorAll('.vxe-resizable--handle');
            handles.forEach(handle => {
                let isDragging = false;
                let startX = 0;
                let startWidth = 0;
                let th = null;
                
                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    isDragging = true;
                    startX = e.clientX;
                    th = handle.closest('th');
                    startWidth = th.offsetWidth;
                    handle.classList.add('vxe-resizable--dragging');
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
                
                function onMouseMove(e) {
                    if (!isDragging) return;
                    const diff = e.clientX - startX;
                    const newWidth = startWidth + diff;
                    if (newWidth > 60) { // 最小宽度60px
                        th.style.width = newWidth + 'px';
                        th.style.minWidth = newWidth + 'px';
                        
                        // 同步更新同一列的所有td
                        const colIndex = Array.from(th.parentNode.children).indexOf(th);
                        const tbody = document.getElementById('dbContent');
                        if (tbody) {
                            tbody.querySelectorAll('tr').forEach(tr => {
                                const td = tr.children[colIndex];
                                if (td) {
                                    td.style.width = newWidth + 'px';
                                    td.style.minWidth = newWidth + 'px';
                                }
                            });
                        }
                    }
                }
                
                function onMouseUp() {
                    isDragging = false;
                    handle.classList.remove('vxe-resizable--dragging');
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }
            });
        }
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div');
            const styles = { success: 'bg-emerald-500 text-white', error: 'bg-red-500 text-white', info: 'bg-blue-600 text-white' };
            toast.className = `flex items-center justify-center w-full px-6 py-3 rounded-xl shadow-lg pointer-events-auto transform transition-all duration-300 toast-enter font-bold text-sm gap-3 ${styles[type]}`;
            toast.innerHTML = `<span>${message}</span>`; container.appendChild(toast); setTimeout(() => { toast.classList.remove('toast-enter'); toast.classList.add('toast-exit'); toast.addEventListener('animationend', () => toast.remove()); }, 3000);
        }
        
        /**
         * 导出筛选后的数据
         * 优化：排除 id 列，按照 TABLE_COLUMNS 顺序排列，使用中文表头
         */
        /**
         * 下载导入格式范本
         * 生成一个包含表头和示例数据的Excel文件，供用户下载作为导入模板
         * 示例数据中币种统一为"USD"，处理状态统一为"待审核"
         */
        function downloadImportTemplate() {
            // 获取表格列配置（排除隐藏列和 id 列）
            const exportColumns = (typeof TABLE_COLUMNS !== 'undefined' ? TABLE_COLUMNS : tableColumns).filter(col => 
                col.key !== 'id' && !col.hidden
            );
            
            // 构建表头（中文）
            const headers = exportColumns.map(col => col.label);
            
            // 构建示例数据行：币种为"USD"，处理状态为"待审核"，其他字段为空
            const exampleRow = exportColumns.map(col => {
                if (col.key === 'currency') {
                    return 'USD';
                } else if (col.key === 'process_status') {
                    return '待审核';
                } else {
                    return ''; // 其他字段为空，供用户填写
                }
            });
            
            // 构建工作表数据：表头 + 示例数据行
            const wsData = [headers, exampleRow];
            
            // 创建工作表
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // 设置列宽
            const colWidths = exportColumns.map(col => {
                const width = parseInt(col.minW) || 15;
                return { wch: Math.max(width / 8, 10) };
            });
            ws['!cols'] = colWidths;
            
            // 创建工作簿并添加工作表
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "导入模板");
            
            // 导出文件
            XLSX.writeFile(wb, `索赔数据导入格式范本_${new Date().toLocaleDateString()}.xlsx`);
            
            showToast('格式范本下载成功，请按照范本格式填写数据', 'success');
        }

        // 将 Excel 日期序列号转换为日期字符串
        function excelSerialToDate(serial) {
            // Excel 日期序列号从 1900-01-01 开始（但 Excel 错误地认为 1900 是闰年）
            // 实际应该从 1899-12-30 开始计算
            const excelEpoch = new Date(1899, 11, 30); // 1899-12-30
            const millisecondsPerDay = 24 * 60 * 60 * 1000;
            const date = new Date(excelEpoch.getTime() + (serial - 1) * millisecondsPerDay);
            return date;
        }
        
        // 转换日期值为标准格式
        function convertDateValue(value, fieldName) {
            if (!value && value !== 0) return null;
            
            // 如果是数字，可能是 Excel 日期序列号
            if (typeof value === 'number') {
                // 检查是否可能是 Excel 日期序列号（通常在 1 到 100000 之间）
                if (value > 0 && value < 100000) {
                    try {
                        const date = excelSerialToDate(value);
                        if (!isNaN(date.getTime())) {
                            if (fieldName === 'ship_date') {
                                return date.toISOString().split('T')[0]; // YYYY-MM-DD
                            } else if (fieldName === 'entry_date') {
                                return date.toISOString(); // ISO 格式
                            }
                        }
                    } catch (e) {
                        console.warn('Excel 日期序列号转换失败:', value, e);
                    }
                }
                // 如果不是日期序列号，返回 null
                return null;
            }
            
            // 如果是 Date 对象
            if (value instanceof Date) {
                if (fieldName === 'ship_date') {
                    return value.toISOString().split('T')[0];
                } else if (fieldName === 'entry_date') {
                    return value.toISOString();
                }
            }
            
            // 如果是字符串
            if (typeof value === 'string') {
                // 检查是否是 YYYY-MM-DD 格式
                const dateMatch = value.match(/^\d{4}-\d{2}-\d{2}/);
                if (dateMatch) {
                    if (fieldName === 'ship_date') {
                        return dateMatch[0];
                    } else if (fieldName === 'entry_date') {
                        return new Date(dateMatch[0] + 'T00:00:00').toISOString();
                    }
                }
                
                // 尝试解析其他日期格式
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    if (fieldName === 'ship_date') {
                        return date.toISOString().split('T')[0];
                    } else if (fieldName === 'entry_date') {
                        return date.toISOString();
                    }
                }
            }
            
            return null;
        }
        
        /**
         * 处理导入文件
         * @param {Event} event - 文件选择事件
         */
        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 验证文件类型
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'];
            const validExtensions = ['.xlsx', '.xls'];
            const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            
            if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
                showToast('请选择Excel文件（.xlsx 或 .xls）', 'error');
                event.target.value = ''; // 清空文件选择
                return;
            }
            
            showToast('正在解析文件...', 'info');
            
            try {
                // 读取文件，设置 cellDates 选项以正确解析日期
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { 
                    type: 'array',
                    cellDates: true,  // 尝试将日期单元格解析为 Date 对象
                    cellNF: false,
                    cellText: false
                });
                
                // 获取第一个工作表
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // 转换为JSON格式，使用 raw: false 以获取格式化后的文本
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,
                    raw: false,  // 获取格式化后的文本值
                    defval: ''   // 空单元格的默认值
                });
                
                if (jsonData.length < 2) {
                    showToast('文件格式错误：至少需要包含表头和数据行', 'error');
                    event.target.value = '';
                    return;
                }
                
                // 第一行是表头（中文），需要映射到字段名
                const headers = jsonData[0];
                const dataRows = jsonData.slice(1);
                
                // 获取表格列配置（用于映射中文表头到字段名）
                const exportColumns = (typeof TABLE_COLUMNS !== 'undefined' ? TABLE_COLUMNS : tableColumns).filter(col => 
                    col.key !== 'id' && !col.hidden
                );
                
                // 创建表头映射：中文 -> 字段名
                const headerMap = {};
                exportColumns.forEach(col => {
                    headerMap[col.label] = col.key;
                });
                
                // 验证表头是否匹配
                const missingHeaders = [];
                headers.forEach((header, index) => {
                    if (header && !headerMap[header]) {
                        missingHeaders.push(`第${index + 1}列: "${header}"`);
                    }
                });
                
                if (missingHeaders.length > 0) {
                    showToast(`表头不匹配：${missingHeaders.join(', ')}。请使用格式范本。`, 'error');
                    event.target.value = '';
                    return;
                }
                
                // 转换数据：将中文表头映射为字段名
                const importedData = dataRows
                    .filter(row => row.some(cell => cell !== undefined && cell !== null && cell !== '')) // 过滤空行
                    .map((row, rowIndex) => {
                        const record = {};
                        headers.forEach((header, colIndex) => {
                            if (header && headerMap[header]) {
                                const value = row[colIndex];
                                const fieldName = headerMap[header];
                                
                                // 处理日期字段
                                if (fieldName === 'ship_date' || fieldName === 'entry_date') {
                                    const convertedDate = convertDateValue(value, fieldName);
                                    if (convertedDate) {
                                        record[fieldName] = convertedDate;
                                    } else if (value) {
                                        // 如果转换失败但有值，尝试直接使用（可能是其他格式）
                                        console.warn(`日期字段 ${fieldName} 转换失败，原值:`, value);
                                        // 对于日期字段，如果无法转换，设置为 null 而不是无效值
                                        record[fieldName] = null;
                                    } else {
                                        record[fieldName] = null;
                                    }
                                } else if (['val_amount', 'claim_qty', 'claim_total', 'claim_ratio'].includes(fieldName)) {
                                    // 数字字段：空字符串转换为 null，否则转换为数字
                                    if (value === '' || value === null || value === undefined) {
                                        record[fieldName] = null;
                                    } else {
                                        const numValue = parseFloat(value);
                                        record[fieldName] = isNaN(numValue) ? null : numValue;
                                    }
                                } else {
                                    // 其他文本字段：保留原值，但空值转为空字符串
                                    record[fieldName] = value !== undefined && value !== null ? value : '';
                                }
                            }
                        });
                        
                        // 生成ID（如果不存在）
                        if (!record.id) {
                            record.id = generateUUID();
                        }
                        
                        // 设置默认值
                        if (!record.process_status) {
                            record.process_status = '待审核';
                        }
                        if (!record.currency) {
                            record.currency = 'USD';
                        }
                        if (!record.claim_ratio) {
                            record.claim_ratio = '100';
                        }
                        if (!record.liable_party) {
                            record.liable_party = '待核实';
                        }
                        if (!record.entry_date) {
                            record.entry_date = new Date().toISOString();
                        }
                        // 客户信息默认值
                        if (!record.cust_name || String(record.cust_name).trim() === '') {
                            record.cust_name = '深圳市信凯源科技有限公司';
                        }
                        if (!record.contact_name || String(record.contact_name).trim() === '') {
                            record.contact_name = '沈学章';
                        }
                        if (!record.contact_info || String(record.contact_info).trim() === '') {
                            record.contact_info = 'shenxz1989@foxmail.com';
                        }
                        
                        return record;
                    });
                
                if (importedData.length === 0) {
                    showToast('文件中没有有效数据', 'error');
                    event.target.value = '';
                    return;
                }
                
                // 验证必填字段（只验证 order_no 和 store_by，客户信息已自动填充默认值）
                const requiredFields = ['order_no', 'store_by'];
                const invalidRecords = [];
                
                importedData.forEach((record, index) => {
                    const missingFields = requiredFields.filter(field => !record[field] || String(record[field]).trim() === '');
                    if (missingFields.length > 0) {
                        invalidRecords.push({
                            row: index + 2, // +2 因为表头占一行，且从1开始计数
                            missingFields: missingFields.map(f => {
                                const col = exportColumns.find(c => c.key === f);
                                return col ? col.label : f;
                            })
                        });
                    }
                });
                
                if (invalidRecords.length > 0) {
                    const errorMsg = `以下行缺少必填字段：\n${invalidRecords.map(r => `第${r.row}行：${r.missingFields.join('、')}`).join('\n')}\n\n请补充完整后重新导入，或导入后使用编辑功能补充。`;
                    if (confirm(errorMsg + '\n\n是否继续导入其他有效数据？')) {
                        // 过滤掉无效记录
                        const validData = importedData.filter((record, index) => {
                            const rowIndex = index + 2;
                            return !invalidRecords.some(r => r.row === rowIndex);
                        });
                        
                        if (validData.length > 0) {
                            await importDataToDatabase(validData);
                        } else {
                            showToast('没有有效数据可以导入', 'error');
                        }
                    }
                    event.target.value = '';
                    return;
                }
                
                // 导入数据
                await importDataToDatabase(importedData);
                
                // 清空文件选择
                event.target.value = '';
                
            } catch (error) {
                console.error('导入文件错误：', error);
                showToast('导入失败：' + (error.message || '文件格式错误'), 'error');
                event.target.value = '';
            }
        }

        /**
         * 批量导入数据到数据库
         * @param {Array} data - 要导入的数据数组
         */
        async function importDataToDatabase(data) {
            if (!data || data.length === 0) {
                showToast('没有数据需要导入', 'error');
                return;
            }
            
            showToast(`正在导入 ${data.length} 条数据...`, 'info');
            
            try {
                // 清洗数据：只保留数据库允许的字段，并确保所有必需字段都有值
                const cleanedData = data.map(record => {
                    const cleaned = sanitizeDataForSupabase(record);
                    // 确保每条记录都有 id
                    if (!cleaned.id) {
                        cleaned.id = generateUUID();
                    }
                    // 确保所有必需字段都存在（即使为空字符串也要保留）
                    const requiredFields = ['cust_name', 'contact_name', 'contact_info', 'store_by', 'order_no'];
                    requiredFields.forEach(field => {
                        if (!cleaned.hasOwnProperty(field)) {
                            // 如果字段不存在，设置默认值
                            if (field === 'cust_name') cleaned.cust_name = '深圳市信凯源科技有限公司';
                            else if (field === 'contact_name') cleaned.contact_name = '沈学章';
                            else if (field === 'contact_info') cleaned.contact_info = 'shenxz1989@foxmail.com';
                            else cleaned[field] = '';
                        }
                    });
                    return cleaned;
                });
                
                // 调试：打印第一条数据用于检查
                if (cleanedData.length > 0) {
                    console.log('准备导入的数据示例（第一条）：', cleanedData[0]);
                    console.log('数据字段列表：', Object.keys(cleanedData[0]));
                    console.log('数据字段数量：', Object.keys(cleanedData[0]).length);
                }
                
                // 检查是否有重复的海外仓单号
                const orderNos = cleanedData.map(r => r.order_no).filter(Boolean);
                const duplicateOrderNos = orderNos.filter((no, index) => orderNos.indexOf(no) !== index);
                
                if (duplicateOrderNos.length > 0) {
                    const uniqueDuplicates = [...new Set(duplicateOrderNos)];
                    if (!confirm(`检测到重复的海外仓单号：${uniqueDuplicates.join('、')}\n\n是否继续导入？`)) {
                        return;
                    }
                }
                
                // 检查数据库中是否已存在相同的海外仓单号（批量查询优化）
                const orderNosToCheck = cleanedData.map(r => r.order_no).filter(Boolean);
                if (orderNosToCheck.length > 0) {
                    const { data: existingRecords } = await supabaseClient
                        .from('claims_v2')
                        .select('order_no')
                        .in('order_no', orderNosToCheck);
                    
                    const existingOrderNos = existingRecords ? existingRecords.map(r => r.order_no) : [];
                    
                    if (existingOrderNos.length > 0) {
                        const uniqueExisting = [...new Set(existingOrderNos)];
                        if (!confirm(`以下海外仓单号已存在：${uniqueExisting.join('、')}\n\n是否跳过这些记录继续导入？`)) {
                            return;
                        }
                        // 过滤掉已存在的记录
                        const filteredData = cleanedData.filter(record => 
                            !record.order_no || !uniqueExisting.includes(record.order_no)
                        );
                        cleanedData.length = 0;
                        cleanedData.push(...filteredData);
                    }
                }
                
                if (cleanedData.length === 0) {
                    showToast('没有新数据需要导入', 'info');
                    return;
                }
                
                // 批量插入数据（Supabase支持批量插入，但建议分批处理以避免超时）
                const batchSize = 50; // 每批50条
                let totalInserted = 0;
                let allInsertedData = [];
                let hasError = false;
                let lastError = null;
                
                for (let i = 0; i < cleanedData.length; i += batchSize) {
                    const batch = cleanedData.slice(i, i + batchSize);
                    
                    // 验证批次数据：确保每条记录都有必需的字段
                    const validBatch = batch.filter(record => {
                        // 验证必需字段
                        if (!record.id) {
                            console.warn('记录缺少 id 字段，已自动生成');
                            record.id = generateUUID();
                        }
                        if (!record.order_no || String(record.order_no).trim() === '') {
                            console.warn('记录缺少 order_no 字段，跳过：', record);
                            return false;
                        }
                        return true;
                    });
                    
                    if (validBatch.length === 0) {
                        console.warn(`第${Math.floor(i / batchSize) + 1}批没有有效数据，跳过`);
                        continue;
                    }
                    
                    // 调试：打印批次数据
                    console.log(`准备插入第${Math.floor(i / batchSize) + 1}批数据，共${validBatch.length}条（原始${batch.length}条）`);
                    if (validBatch.length > 0) {
                        console.log('批次第一条数据示例：', validBatch[0]);
                    }
                    
                    const { data: insertedData, error } = await supabaseClient
                        .from('claims_v2')
                        .insert(validBatch)
                        .select();
                    
                    if (error) {
                        console.error(`批量导入错误（第${Math.floor(i / batchSize) + 1}批）：`, error);
                        console.error('错误详情：', JSON.stringify(error, null, 2));
                        console.error('失败的数据批次（前3条）：', validBatch.slice(0, 3));
                        hasError = true;
                        lastError = error;
                        showToast(`导入部分失败：第${Math.floor(i / batchSize) + 1}批数据导入失败 - ${error.message}`, 'error');
                        continue;
                    }
                    
                    if (insertedData && insertedData.length > 0) {
                        console.log(`第${Math.floor(i / batchSize) + 1}批成功插入 ${insertedData.length} 条数据`);
                        allInsertedData.push(...insertedData);
                        totalInserted += insertedData.length;
                    } else {
                        console.warn(`第${Math.floor(i / batchSize) + 1}批插入完成，但没有返回数据。可能原因：1. 数据已存在 2. 数据格式错误`);
                    }
                }
                
                const insertedData = allInsertedData;
                
                // 检查是否有错误
                if (hasError && lastError) {
                    console.error('导入过程中发生错误：', lastError);
                    if (insertedData && insertedData.length > 0) {
                        showToast(`部分导入成功：${insertedData.length} 条数据已导入，但有部分失败`, 'error');
                    } else {
                        showToast(`导入失败：${lastError.message}`, 'error');
                        return;
                    }
                }
                
                // 更新本地数据库
                if (insertedData && insertedData.length > 0) {
                    console.log(`总共成功导入 ${insertedData.length} 条数据到数据库`);
                    insertedData.forEach(record => {
                        database.unshift(record);
                    });
                    localStorage.setItem('wh_claims_db_pro', JSON.stringify(database));
                    
                    // 刷新数据列表
                    if (typeof window.fetchTableData === 'function') {
                        await window.fetchTableData(false, true); // 强制刷新
                    }
                    
                    // 更新看板视图
                    if (typeof renderKanban === 'function') {
                        renderKanban();
                    }
                    
                    showToast(`成功导入 ${insertedData.length} 条数据！`, 'success');
                } else {
                    console.warn('导入完成，但没有数据被插入。可能的原因：1. 所有数据都已存在 2. 数据格式错误 3. 数据库插入失败');
                    showToast('导入完成，但没有数据被插入。请检查控制台日志查看详情', 'error');
                }
                
            } catch (error) {
                console.error('导入数据错误：', error);
                showToast('导入失败：' + (error.message || '未知错误'), 'error');
            }
        }

        function exportFilteredData() { 
            const dataToExport = currentFilteredData.length > 0 ? currentFilteredData : [];
            if(dataToExport.length === 0) return showToast('当前没有可导出的数据', 'error');
            
            // 获取表格列配置（排除隐藏列和 id 列）
            const exportColumns = (typeof TABLE_COLUMNS !== 'undefined' ? TABLE_COLUMNS : tableColumns).filter(col => 
                col.key !== 'id' && !col.hidden
            );
            
            // 构建表头（中文）
            const headers = exportColumns.map(col => col.label);
            
            // 构建数据行，按照 TABLE_COLUMNS 的顺序
            const rows = dataToExport.map(item => {
                return exportColumns.map(col => {
                    const value = item[col.key];
                    // 日期字段格式化：只显示日期部分
                    if ((col.key === 'ship_date' || col.key === 'entry_date') && value) {
                        const dateStr = String(value);
                        return dateStr.length >= 10 ? dateStr.substring(0, 10) : dateStr;
                    }
                    return value || '';
                });
            });
            
            // 构建工作表数据：表头 + 数据行
            const wsData = [headers, ...rows];
            
            // 创建工作表
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // 设置列宽（可选，根据 minW 设置）
            const colWidths = exportColumns.map(col => {
                // 将 minW 转换为数字（去掉 px）
                const width = parseInt(col.minW) || 15;
                return { wch: Math.max(width / 8, 10) }; // 转换为 Excel 列宽单位
            });
            ws['!cols'] = colWidths;
            
            // 创建工作簿并添加工作表
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "全数据清单"); 
            XLSX.writeFile(wb, `全数据清单_导出_${new Date().toLocaleDateString()}.xlsx`);
            
            showToast(`成功导出 ${dataToExport.length} 条数据`, 'success');
        }
        
        function exportSingleExcel(data) { 
            const wb = XLSX.utils.book_new();
            const ws_data = [
                [null, "有只熊海外仓索赔申请表", null, null, null, null, null, null],
                [null, "信息类型", "字段名称", "填写内容", "填写方", "公式/验证", null, null, null],
                [null, "客户信息", "客户名称 (公司全称)", data.cust_name, "客户", "必填项", null, null, null],
                [null, null, "联系人", data.contact_name, "客户", "必填项", null, null, null],
                [null, null, "联系方式", data.contact_info, "客户", "必填项", null, null, null],
                [null, "订单信息", "海外仓单号", data.order_no, "客户", "必填项", null, null, null],
                [null, null, "物流运单号", data.tracking_no, "客户", "必填项", null, null, null],
                [null, null, "发货日期", data.ship_date, "客户", "必填项", null, null, null],
                [null, null, "订单SKU", data.sku, "客户", "必填项", null, null, null],
                [null, null, "发货仓", data.warehouse, "客户", "必填项", null, null, null],
                [null, "索赔详情", "索赔类型", data.claim_type, "客户", "必填项", null, null, null],
                [null, null, "问题描述", data.description, "客户", "必填项", null, null, null],
                [null, null, "责任方判定", data.liable_party, "有只熊", "选择项", null, null, null],
                [null, "赔偿计算", "货物声明价值(USD)", "$" + data.val_amount, "客户", "必填项", null, null, null],
                [null, null, "索赔数量", data.claim_qty, "客户", "必填项", null, null, null],
                [null, null, "赔偿比例(%)", data.claim_ratio + "%", "有只熊", "必填项", null, null, null],
                [null, null, "总赔偿金额(USD)", "$" + data.claim_total, "客户", "必填项", null, null, null],
                [null, "其他信息", "附件清单", data.attachments, "客户", "必填项", null, null, null],
                [null, null, "申请提交日期", data.entry_date, "客户", "日期格式", null, null, null],
                [null, null, "处理状态", data.process_status, "客户", "下拉菜单", null, null, null],
                [null, null, "备注", data.remarks, "有只熊", "必填项", null, null, null]
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // 修复合并单元格定义，确保所有合并区域正确
            ws['!merges'] = [
                { s: {r: 0, c: 1}, e: {r: 0, c: 4} }, // 标题
                { s: {r: 2, c: 1}, e: {r: 4, c: 1} }, // 客户信息
                { s: {r: 5, c: 1}, e: {r: 9, c: 1} }, // 订单信息
                { s: {r: 10, c: 1}, e: {r: 12, c: 1} }, // 索赔详情
                { s: {r: 13, c: 1}, e: {r: 16, c: 1} }, // 赔偿计算
                { s: {r: 17, c: 1}, e: {r: 20, c: 1} }  // 其他信息
            ];
            
            ws['!cols'] = [{wch: 2}, {wch: 15}, {wch: 25}, {wch: 40}, {wch: 15}];
            
            // 获取所有单元格范围
            const range = XLSX.utils.decode_range(ws['!ref']);
            
            // 遍历所有单元格，设置样式
            for (let r = range.s.r; r <= range.e.r; r++) {
                for (let c = range.s.c; c <= range.e.c; c++) {
                    const cellRef = XLSX.utils.encode_cell({ r, c });
                    if (!ws[cellRef]) ws[cellRef] = { v: '' };
                    
                    // 基础样式：全表垂直居中，水平居中
                    ws[cellRef].s = {
                        alignment: {
                            vertical: 'center',
                            horizontal: 'center',
                            wrapText: true
                        },
                        border: {
                            top: { style: "thin" },
                            bottom: { style: "thin" },
                            left: { style: "thin" },
                            right: { style: "thin" }
                        }
                    };
                    
                    // 第1-2行表头加粗显示
                    if (r <= 1) {
                        ws[cellRef].s.font = {
                            bold: true
                        };
                    }
                    
                    // 确保合并单元格的文本内容被正确保留
                    // 对于所有合并区域的左上角单元格，确保文本存在且样式正确
                    ws['!merges'].forEach(merge => {
                        if (r === merge.s.r && c === merge.s.c) {
                            // 这是合并区域的左上角单元格
                            // 确保它有值
                            if (!ws[cellRef].v && ws_data[r][c]) {
                                ws[cellRef].v = ws_data[r][c];
                            }
                            // 合并区域标题加粗
                            ws[cellRef].s.font = {
                                bold: true
                            };
                        }
                    });
                }
            }
            
            XLSX.utils.book_append_sheet(wb, ws, "申请表");
            XLSX.writeFile(wb, `索赔单_${data.order_no}_${data.claim_total}.xlsx`); 
        }

        // --- 公告中心逻辑 ---
        // 格式化UTC时间为本地时区的YYYY-MM-DD HH:mm:ss格式（全局函数）
        window.formatLocalTime = function(utcString) {
            if (!utcString) return '';
            const date = new Date(utcString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/\//g, '-'); // 将斜杠替换为横杠，确保格式为YYYY-MM-DD
        };
        
        // 加载公告列表（全局函数）
        window.loadNotices = async function() {
            // 确保使用全局的 supabaseClient
            const client = window.supabaseClient || (typeof supabaseClient !== 'undefined' ? supabaseClient : null);
            
            if (!client) {
                const list = document.getElementById('notice-list');
                if (list) {
                    list.innerHTML = '<div class="text-center py-10"><p class="text-red-500 dark:text-red-400">数据库连接失败，请刷新页面重试</p></div>';
                }
                return;
            }
            
            const list = document.getElementById('notice-list');
            if (!list) {
                // 等待一段时间后重试
                setTimeout(() => {
                    const retryList = document.getElementById('notice-list');
                    if (retryList && typeof window.loadNotices === 'function') {
                        window.loadNotices();
                    }
                }, 300);
                return;
            }
            
            const emptyState = document.getElementById('empty-state');
            
            // 显示加载状态
            list.innerHTML = '<div class="text-center py-10"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div><p class="mt-4 text-slate-500 dark:text-slate-400">正在加载公告...</p></div>';
            
            try {
                // 从Supabase获取公告列表
                
                const { data: notices, error } = await client
                    .from('notices')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (error) {
                    list.innerHTML = '<div class="text-center py-10"><p class="text-red-500 dark:text-red-400">加载公告失败，请刷新页面重试</p></div>';
                    return;
                }
                
                // 清空现有公告
                list.innerHTML = '';
                
                if (notices && notices.length > 0) {
                    // 隐藏空状态
                    if (emptyState) emptyState.remove();
                    
                    // 在客户端对公告进行排序：按更新时间（如有）或创建时间降序排列
                    const sortedNotices = notices.sort((a, b) => {
                        const timeA = new Date(a.updated_at || a.created_at).getTime();
                        const timeB = new Date(b.updated_at || b.created_at).getTime();
                        return timeB - timeA; // 降序：新的在前
                    });
                    
                    // 渲染公告列表
                    sortedNotices.forEach(notice => {
                        let imageHtml = '';
                        if (notice.image_url) {
                            imageHtml = `
                            <div class="relative bg-slate-50 dark:bg-slate-900 cursor-zoom-in w-full flex justify-center py-6 border-t border-slate-100 dark:border-slate-700 group mt-5 rounded-b-2xl transition-colors hover:bg-slate-100 dark:hover:bg-slate-800" onclick="window.openLightbox('${notice.image_url}')">
                                <img src="${notice.image_url}?t=${Date.now()}" class="max-h-[500px] w-auto max-w-full object-contain shadow-md rounded-lg" alt="公告附件">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors flex items-center justify-center pointer-events-none">
                                    <div class="bg-white/90 dark:bg-slate-800/90 backdrop-blur text-slate-800 dark:text-white px-4 py-2 rounded-full shadow-xl opacity-0 group-hover:opacity-100 transform translate-y-2 group-hover:translate-y-0 transition-all font-bold text-xs flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                                        点击查看高清大图
                                    </div>
                                </div>
                            </div>`;
                        }
                        
                        const newCard = `
                        <div class="glass-card overflow-hidden animate-fade-up border-l-4 border-l-blue-600 mb-6 group hover:shadow-md">
                            <div class="p-7 pb-2">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-black text-slate-800 dark:text-white text-xl flex items-center gap-3">
                                        ${notice.title}
                                    </h3>
                                    <div class="flex gap-2">
                                        <button class="text-slate-300 hover:text-blue-500 transition p-1 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-lg" onclick="window.editNotice('${notice.id}')" title="编辑这条公告"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                                        <button class="text-slate-300 hover:text-red-500 transition p-1 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg" onclick="window.deleteNotice('${notice.id}')" title="删除这条公告"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                    </div>
                                </div>
                                <p class="text-slate-600 dark:text-slate-300 text-base mt-4 leading-relaxed whitespace-pre-wrap">${notice.content}</p>
                                <div class="flex items-center gap-4 mt-6 pb-4 border-b border-slate-50 dark:border-slate-700">
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-xs text-slate-500 dark:text-slate-400 font-bold">${notice.author.charAt(0).toUpperCase()}</div>
                                        <span class="text-xs font-bold text-slate-500 dark:text-slate-400">${notice.author}</span>
                                    </div>
                                    <span class="text-xs text-slate-300 dark:text-slate-600">•</span>
<div class="flex flex-col items-end">
    <span class="text-xs font-mono text-slate-400 dark:text-slate-500">
        ${window.formatLocalTime(notice.updated_at || notice.created_at)}
    </span>
    ${notice.updated_at ? '<span class="text-[10px] text-blue-500 bg-blue-50 px-1 rounded">已编辑</span>' : ''}
</div>
                                </div>
                            </div>
                            ${imageHtml}
                        </div>`;
                        
                        list.insertAdjacentHTML('afterbegin', newCard);
                    });
                } else {
                    // 显示空状态
                    const emptyHtml = `
                    <div id="empty-state" class="text-center py-20">
                        <svg class="w-16 h-16 mx-auto text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white mt-4">暂无公告内容</h3>
                        <p class="text-sm text-slate-400 mt-2 max-w-xs mx-auto">点击右上角的“发布新公告”按钮，发布第一条通知。</p>
                    </div>`;
                    list.innerHTML = emptyHtml;
                }
            } catch (error) {
                list.innerHTML = '<div class="text-center py-10"><p class="text-red-500 dark:text-red-400">加载公告失败，请刷新页面重试</p></div>';
            }
        };
        
        // 注意：togglePublisher 已在脚本开头定义（第945行），这里不再重复定义
        
        // 删除公告（全局函数，供onclick调用）
        window.deleteNotice = async function(id) {
            const client = window.supabaseClient || supabaseClient;
            if (!client) return;
            
            try {
                // 1. 先获取公告信息，包括图片URL
                const { data: notice, error: fetchError } = await client
                    .from('notices')
                    .select('image_url')
                    .eq('id', id)
                    .single();
                
                if (fetchError) throw fetchError;
                
                // 2. 如果有图片URL，先删除存储桶中的图片
                if (notice && notice.image_url) {
                    try {
                        // 从URL中提取存储路径
                        const url = new URL(notice.image_url);
                        // 提取路径：从 /storage/v1/object/public/claim-images/ 之后开始
                        const path = url.pathname.replace('/storage/v1/object/public/claim-images/', '');
                        
                        // 删除存储桶中的图片
                        const { error: storageError } = await client
                            .storage
                            .from('claim-images')
                            .remove([path]);
                        
                        if (storageError) {
                            // 图片删除失败不影响公告删除，继续执行
                        }
                    } catch (urlError) {
                        // URL解析失败不影响公告删除，继续执行
                    }
                }
                
                // 3. 删除数据库中的公告记录
                const { error: deleteError } = await client
                    .from('notices')
                    .delete()
                    .eq('id', id);
                
                if (deleteError) {
                    showToast('删除公告失败', 'error');
                    return;
                }
                
                // 4. 重新加载公告列表
                await window.loadNotices();
                showToast('公告已删除', 'success');
            } catch (error) {
                showToast('删除公告失败', 'error');
            }
        };

        // 存储上传后的图片URL（全局变量）
        window.uploadedImageUrl = null;
        
        // 图片选择和上传处理（全局函数，供onchange调用）
        window.handleFileSelect = async function(input) {
            const display = document.getElementById('file-name-display');
            const zone = document.getElementById('upload-zone');
            const client = window.supabaseClient || supabaseClient;
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const fileName = file.name;
                
                // 显示上传中状态
                display.innerHTML = `<span class="text-blue-600 font-bold flex items-center justify-center gap-1"><svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> 上传中: ${fileName}</span>`;
                zone.classList.add('bg-blue-50', 'border-blue-300', 'dark:bg-blue-900/30', 'dark:border-blue-500');
                
                try {
                    if (client) {
                        // 生成唯一的文件名
                        const timestamp = new Date().getTime();
                        const uniqueFileName = `${timestamp}_${fileName}`;
                        
                        // 上传图片到Supabase Storage
                        const { data, error } = await client
                            .storage
                            .from('claim-images')
                            .upload(uniqueFileName, file, { contentType: file.type });
                        
                        if (error) {
                            display.innerHTML = `<span class="text-red-600 font-bold flex items-center justify-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> 上传失败: ${error.message}</span>`;
                            window.uploadedImageUrl = null;
                            return;
                        }
                        
                        // 获取公共URL
                        const { data: urlData } = client
                            .storage
                            .from('claim-images')
                            .getPublicUrl(data.path);
                        const publicUrl = urlData.publicUrl;
                        
                        window.uploadedImageUrl = publicUrl;
                        display.innerHTML = `<span class="text-emerald-600 font-bold flex items-center justify-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> 已选择: ${fileName}</span>`;
                    } else {
                        // Supabase未初始化时的处理（保持原有逻辑）
                        display.innerHTML = `<span class="text-emerald-600 font-bold flex items-center justify-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> 已选择: ${fileName}</span>`;
                        window.uploadedImageUrl = URL.createObjectURL(file);
                    }
                } catch (error) {
                    display.innerHTML = `<span class="text-red-600 font-bold flex items-center justify-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> 上传失败</span>`;
                    window.uploadedImageUrl = null;
                }
            } else {
                // 未选择文件时重置状态
                display.textContent = '支持 JPG, PNG, GIF 格式';
                zone.classList.remove('bg-blue-50', 'border-blue-300', 'dark:bg-blue-900/30', 'dark:border-blue-500');
                window.uploadedImageUrl = null;
            }
        };

        // 发布公告（全局函数，供onclick调用）
        window.publishNotice = async function() {
            const titleInput = document.getElementById('post-title');
            const contentInput = document.getElementById('post-content');
            const fileInput = document.getElementById('post-file');
            const list = document.getElementById('notice-list');
            const emptyState = document.getElementById('empty-state');
            const client = window.supabaseClient || supabaseClient;

            if (!titleInput.value.trim()) {
                showToast('请填写公告标题', 'error');
                return;
            }
            
            if (!client) {
                showToast('数据库连接失败，请刷新页面重试', 'error');
                return;
            }

            try {
                // 准备公告数据
                const now = new Date();
                const timeString = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                
                // 保存公告到数据库
                const { data, error } = await client.from('notices').insert([
                    {
                        title: titleInput.value,
                        content: contentInput.value,
                        created_at: now.toISOString(),
                        image_url: window.uploadedImageUrl || null,
                        author: '当前管理员' // 添加作者信息
                    }
                ]).select();

                if (error) {
                    throw error;
                }

                if(emptyState) emptyState.remove();

                // 使用保存后的公告数据渲染
                const notice = data[0];

            let imageHtml = '';
            if (notice.image_url) {
                const imgUrl = notice.image_url;
                imageHtml = `
                <div class="relative bg-slate-50 dark:bg-slate-900 cursor-zoom-in w-full flex justify-center py-6 border-t border-slate-100 dark:border-slate-700 group mt-5 rounded-b-2xl transition-colors hover:bg-slate-100 dark:hover:bg-slate-800" onclick="window.openLightbox('${imgUrl}')">
                    <img src="${imgUrl}" class="max-h-[500px] w-auto max-w-full object-contain shadow-md rounded-lg" alt="公告附件">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors flex items-center justify-center pointer-events-none">
                        <div class="bg-white/90 dark:bg-slate-800/90 backdrop-blur text-slate-800 dark:text-white px-4 py-2 rounded-full shadow-xl opacity-0 group-hover:opacity-100 transform translate-y-2 group-hover:translate-y-0 transition-all font-bold text-xs flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                            点击查看高清大图
                        </div>
                    </div>
                </div>`;
            }

            const newCard = `
            <div class="glass-card overflow-hidden animate-fade-up border-l-4 border-l-blue-600 mb-6 group hover:shadow-md">
                <div class="p-7 pb-2">
                    <div class="flex justify-between items-start">
                        <h3 class="font-black text-slate-800 dark:text-white text-xl flex items-center gap-3">
                            ${notice.title}
                            <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full animate-pulse font-extrabold uppercase tracking-wide">New</span>
                        </h3>
                        <button class="text-slate-300 hover:text-red-500 transition p-1 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg" onclick="deleteNotice('${notice.id}')" title="删除这条公告"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                    <p class="text-slate-600 dark:text-slate-300 text-base mt-4 leading-relaxed whitespace-pre-wrap">${notice.content}</p>
                    <div class="flex items-center gap-4 mt-6 pb-4 border-b border-slate-50 dark:border-slate-700">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-xs text-slate-500 dark:text-slate-400 font-bold">U</div>
                            <span class="text-xs font-bold text-slate-500 dark:text-slate-400">当前管理员</span>
                        </div>
                        <span class="text-xs text-slate-300 dark:text-slate-600">•</span>
                        <span class="text-xs font-mono text-slate-400 dark:text-slate-500">${timeString}</span>
                    </div>
                </div>
                ${imageHtml}
            </div>`;

            list.insertAdjacentHTML('afterbegin', newCard);

            // 重置表单
            titleInput.value = ''; 
            contentInput.value = ''; 
            fileInput.value = '';
            window.uploadedImageUrl = null;
            document.getElementById('file-name-display').textContent = '支持 JPG, PNG, GIF 格式';
            document.getElementById('upload-zone').classList.remove('bg-blue-50', 'border-blue-300', 'dark:bg-blue-900/30', 'dark:border-blue-500');
            window.togglePublisher();
            showToast('公告发布成功！', 'success');
        } catch (error) {
            // 清理临时上传的图片
            window.cleanupUploadedImage();
            showToast('公告发布失败: ' + (error.message || '未知错误'), 'error');
        }
    };

    // 清理临时上传的图片（全局函数）
    window.cleanupUploadedImage = function() {
        const client = window.supabaseClient || (typeof supabaseClient !== 'undefined' ? supabaseClient : null);
        if (window.uploadedImageUrl && client) {
            try {
                const url = new URL(window.uploadedImageUrl);
                // 提取路径：从 /storage/v1/object/public/claim-images/ 之后开始
                        const path = url.pathname.replace('/storage/v1/object/public/claim-images/', '');
                        
                        client
                            .storage
                            .from('claim-images')
                            .remove([path])
                    .then(() => {
                        window.uploadedImageUrl = null;
                    })
                    .catch(error => {
                        // 临时图片清理失败，静默处理
                    });
            } catch (error) {
                // 清理图片URL解析失败，静默处理
            }
        }
    }

    // 打开图片查看器（全局函数，供onclick调用）
    window.openLightbox = function(src) {
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = src;
            lightbox.classList.remove('hidden');
            requestAnimationFrame(() => {
                lightbox.classList.remove('opacity-0');
                img.classList.replace('scale-95', 'scale-100');
            });
        };

        // 关闭图片查看器（全局函数，供onclick调用）
        window.closeLightbox = function() {
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            lightbox.classList.add('opacity-0');
            img.classList.replace('scale-100', 'scale-95');
            setTimeout(() => lightbox.classList.add('hidden'), 300);
        };

        // --- 一键复制到微信（增强兼容性） ---
        function copyToWeChat() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxes.length === 0) return showToast('请先勾选需要复制的数据行', 'error');

            let clipboardText = "";
            let count = 0;

            checkboxes.forEach((checkbox, index) => {
                const item = database.find(i => i.id === checkbox.value);
                if (item) {
                    const entryText = `问题类型：${item.claim_type || ''}
仓库问题：${item.description || ''}
出库单号OWS：${item.order_no || ''}
物流运单号：${item.tracking_no || ''}
产品编码：${item.sku || ''}
数量：${item.claim_qty || ''}
发货日期：${item.ship_date || ''}
索赔金额：${item.claim_total || ''} ${item.currency || ''}
索赔申请表：已提交`;
                    clipboardText += entryText + (index < checkboxes.length - 1 ? "\n------------------------\n" : "");
                    count++;
                }
            });

            // 优先使用 Clipboard API，在失败或不安全上下文（如 http/file）时回退
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(clipboardText).then(() => {
                    showToast(`成功复制 ${count} 条数据到剪贴板！`, 'success');
                }).catch(err => {
                    fallbackCopyTextToClipboard(clipboardText, count);
                });
            } else {
                fallbackCopyTextToClipboard(clipboardText, count);
            }
        }

        // 兼容性复制函数
        function fallbackCopyTextToClipboard(text, count) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                var successful = document.execCommand('copy');
                if(successful) {
                    showToast(`成功复制 ${count} 条数据到剪贴板！`, 'success');
                } else {
                    showToast('复制失败，请手动复制', 'error');
                }
            } catch (err) {
                showToast('复制失败，请手动复制', 'error');
            }

            document.body.removeChild(textArea);
        }

        /**
         * 复制列数据
         * 获取当前显示的所有行的指定列数据，用换行符分隔后复制到剪贴板
         * @param {string} columnKey - 列字段名（如 'order_no' 或 'tracking_no'）
         */
        function copyColumnData(columnKey) {
            // 获取当前显示的数据
            const currentData = (typeof ListState !== 'undefined' && ListState.data) ? ListState.data : [];
            
            if (currentData.length === 0) {
                showToast('当前没有可复制的数据', 'error');
                return;
            }
            
            // 检查是否全选
            const selectAllBox = document.getElementById('selectAll');
            const rowBoxes = document.querySelectorAll('.row-checkbox');
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const isAllSelected = selectAllBox && selectAllBox.checked && checkedBoxes.length === rowBoxes.length;
            
            let dataToCopy = [];
            let dataCount = 0;
            
            if (isAllSelected) {
                // 全选状态：复制整列数据
                dataToCopy = currentData;
                dataCount = currentData.length;
            } else {
                // 部分选择：只复制已选数据
                if (checkedBoxes.length === 0) {
                    showToast('请先勾选需要复制的数据行', 'error');
                    return;
                }
                
                const selectedIds = Array.from(checkedBoxes).map(cb => cb.value).filter(id => id);
                dataToCopy = currentData.filter(item => selectedIds.includes(item.id));
                dataCount = dataToCopy.length;
            }
            
            // 提取指定列的值
            const columnValues = dataToCopy.map(item => {
                const value = item[columnKey];
                // 如果值是日期类型，格式化显示
                if (columnKey === 'ship_date' || columnKey === 'entry_date') {
                    if (value) {
                        // 如果是ISO格式日期，只取日期部分
                        const dateStr = String(value);
                        return dateStr.length >= 10 ? dateStr.substring(0, 10) : dateStr;
                    }
                    return '';
                }
                return value || '';
            });
            
            // 用换行符连接所有值
            const clipboardText = columnValues.join('\n');
            
            // 获取列名用于提示
            const colConfig = (typeof TABLE_COLUMNS !== 'undefined') ? 
                TABLE_COLUMNS.find(c => c.key === columnKey) : null;
            const columnLabel = colConfig ? colConfig.label : columnKey;
            
            // 复制到剪贴板
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(clipboardText).then(() => {
                    const message = isAllSelected ? 
                        `成功复制 ${dataCount} 条${columnLabel}数据到剪贴板！` : 
                        `成功复制 ${dataCount} 条已选${columnLabel}数据到剪贴板！`;
                    showToast(message, 'success');
                }).catch(err => {
                    fallbackCopyColumnData(clipboardText, dataCount, columnLabel);
                });
            } else {
                fallbackCopyColumnData(clipboardText, dataCount, columnLabel);
            }
        }
        
        /**
         * 更新复制按钮的显示/隐藏状态
         */
        function updateCopyButtonsVisibility() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const hasSelection = checkedBoxes.length > 0;
            
            // 更新所有复制按钮的显示状态
            const copyButtons = document.querySelectorAll('.copy-column-btn');
            copyButtons.forEach(btn => {
                if (hasSelection) {
                    btn.style.display = 'inline-block';
                } else {
                    btn.style.display = 'none';
                }
            });
        }

        /**
         * 兼容性复制列数据函数
         * @param {string} text - 要复制的文本
         * @param {number} count - 数据条数
         * @param {string} columnLabel - 列名
         */
        function fallbackCopyColumnData(text, count, columnLabel) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                var successful = document.execCommand('copy');
                if(successful) {
                    showToast(`成功复制 ${count} 条${columnLabel}数据到剪贴板！`, 'success');
                } else {
                    showToast('复制失败，请手动复制', 'error');
                }
            } catch (err) {
                showToast('复制失败，请手动复制', 'error');
            }

            document.body.removeChild(textArea);
        }

        // --- 全选/反选逻辑 ---
        function toggleSelectAll() {
            const selectAllBox = document.getElementById('selectAll');
            const rowBoxes = document.querySelectorAll('.row-checkbox');
            rowBoxes.forEach(box => box.checked = selectAllBox.checked);
            // 更新批量操作工具栏
            if (typeof updateBatchActionBar === 'function') {
                updateBatchActionBar();
            }
            // 更新复制按钮的显示/隐藏状态
            updateCopyButtonsVisibility();
        }

        // --- 单个勾选更新全选框状态 ---
        function updateSelectAllState() {
            const selectAllBox = document.getElementById('selectAll');
            const rowBoxes = document.querySelectorAll('.row-checkbox');
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            
            if (rowBoxes.length === 0) return;
            
            if (checkedBoxes.length === rowBoxes.length) {
                selectAllBox.checked = true;
                selectAllBox.indeterminate = false;
            } else if (checkedBoxes.length > 0) {
                selectAllBox.checked = false;
                selectAllBox.indeterminate = true;
            } else {
                selectAllBox.checked = false;
                selectAllBox.indeterminate = false;
            }
            // 更新批量操作工具栏
            if (typeof updateBatchActionBar === 'function') {
                updateBatchActionBar();
            }
            // 更新复制按钮的显示/隐藏状态
            updateCopyButtonsVisibility();
        }

        // ============================================
        // 【新增】批量操作功能
        // ============================================

        /**
         * 【新增】获取选中行的ID数组
         */
        function getSelectedRowIds() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            return Array.from(checkedBoxes).map(cb => cb.value).filter(id => id);
        }

        /**
         * 【新增】清除选择状态
         */
        function clearSelection() {
            const selectAllBox = document.getElementById('selectAll');
            const rowBoxes = document.querySelectorAll('.row-checkbox');
            
            // 清除所有行的复选框
            rowBoxes.forEach(box => {
                box.checked = false;
            });
            
            // 清除全选框
            if (selectAllBox) {
                selectAllBox.checked = false;
                selectAllBox.indeterminate = false;
            }
            
            // 更新批量操作工具栏
            if (typeof updateBatchActionBar === 'function') {
                updateBatchActionBar();
            }
            
            // 更新复制按钮的显示/隐藏状态
            updateCopyButtonsVisibility();
        }

        /**
         * 【新增】批量更新选中记录的状态
         * @param {string} status - 状态值
         */
        async function batchUpdateStatus(status) {
            const selectedIds = getSelectedRowIds();
            if (selectedIds.length === 0) {
                showToast('请先选择要更新的记录', 'error');
                return;
            }
            
            // 状态映射：英文标识 -> 中文名称（保留以兼容可能传入的英文值）
            const statusMap = {
                'pending_review': '待审核',
                'processing': '处理中',
                'pending_payment': '等待赔付',
                'paid': '已赔付',
                'rejected': '已驳回'
            };
            
            // 获取中文状态名称
            const chineseStatus = statusMap[status] || status;
            
            // 确认对话框
            if (!confirm(`确定要批量更新 ${selectedIds.length} 条记录的状态为"${chineseStatus}"吗？`)) {
                return;
            }
            
            try {
                // 批量更新API调用
                const client = window.supabaseClient || (typeof supabaseClient !== 'undefined' ? supabaseClient : null);
                if (!client) {
                    showToast('数据库连接失败，请刷新页面重试', 'error');
                    return;
                }
                
                // 传输中文状态名称到后端
                const { error } = await client
                    .from('claims_v2')
                    .update({ process_status: chineseStatus }) // 使用中文状态名称
                    .in('id', selectedIds);
                
                if (error) throw error;
                
                showToast(`成功更新 ${selectedIds.length} 条记录`, 'success');
                
                // 【修复】立即更新 ListState.data 中对应项的状态，确保UI能立即反映状态变化
                selectedIds.forEach(id => {
                    const listStateIndex = ListState.data.findIndex(i => i && i.id === id);
                    if (listStateIndex !== -1) {
                        ListState.data[listStateIndex].process_status = chineseStatus;
                    }
                });
                
                // 【修复】直接更新虚拟滚动管理器内部的数据，并强制重新渲染可见区域
                const vManager = (typeof window !== 'undefined' && window.virtualScrollManager) ? window.virtualScrollManager : null;
                if (vManager && vManager.data) {
                    selectedIds.forEach(id => {
                        const dataIndex = vManager.data.findIndex(i => i && i.id === id);
                        if (dataIndex !== -1) {
                            vManager.data[dataIndex].process_status = chineseStatus;
                        }
                    });
                    
                    // 强制重新渲染可见区域
                    if (vManager.startIndex >= 0 && vManager.endIndex > vManager.startIndex) {
                        vManager.renderVisibleItems();
                    }
                }
                
                // 【修复】立即刷新UI，确保及时性
                if (typeof renderDatabase === 'function') {
                    renderDatabase();
                }
                
                // 【修复】从后端获取最新数据，确保数据一致性（异步执行，不阻塞主流程）
                // 添加小延迟确保数据库更新已传播
                setTimeout(async () => {
                    try {
                        if (typeof window !== 'undefined' && typeof window.clearAllCache === 'function') {
                            window.clearAllCache();
                        }
                        if (typeof window !== 'undefined' && typeof window.fetchTableData === 'function') {
                            await window.fetchTableData(false, true, null, true); // append=false, forceRefresh=true, keepScrollPosition=true
                        } else if (typeof fetchTableData === 'function') {
                            await fetchTableData(false, true, null, true);
                        }
                    } catch (error) {
                        // 刷新数据失败，静默处理
                    }
                }, 200); // 200ms 延迟，确保数据库更新已传播
                
                clearSelection(); // 清空选择
            } catch (error) {
                showToast('批量更新失败: ' + (error.message || '未知错误'), 'error');
            }
        }

        /**
         * 【新增】从选择框中获取状态并批量更新选中记录
         */
        function batchUpdateStatusFromSelect() {
            const statusSelect = document.getElementById('bulk-status-select');
            const selectedStatus = statusSelect ? statusSelect.value : '';
            
            if (!selectedStatus) {
                showToast('请选择要更新的状态', 'error');
                return;
            }
            
            batchUpdateStatus(selectedStatus);
        }

        /**
         * 【新增】批量导出选中记录
         */
        async function batchExportSelected() {
            const selectedIds = getSelectedRowIds();
            if (selectedIds.length === 0) {
                showToast('请先选择要导出的记录', 'error');
                return;
            }
            
            try {
                // 获取选中记录的数据
                const client = window.supabaseClient || (typeof supabaseClient !== 'undefined' ? supabaseClient : null);
                if (!client) {
                    showToast('数据库连接失败，请刷新页面重试', 'error');
                    return;
                }
                
                const { data, error } = await client
                    .from('claims_v2')
                    .select('*')
                    .in('id', selectedIds);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    showToast('没有找到要导出的数据', 'error');
                    return;
                }
                
                // 获取表格列配置（排除隐藏列和 id 列）
                const exportColumns = (typeof TABLE_COLUMNS !== 'undefined' ? TABLE_COLUMNS : []).filter(col => 
                    col.key !== 'id' && !col.hidden
                );
                
                // 构建表头（中文）
                const headers = exportColumns.map(col => col.label);
                
                // 构建数据行，按照 TABLE_COLUMNS 的顺序
                const rows = data.map(item => {
                    return exportColumns.map(col => {
                        const value = item[col.key];
                        // 日期字段格式化：只显示日期部分
                        if ((col.key === 'ship_date' || col.key === 'entry_date') && value) {
                            const dateStr = String(value);
                            return dateStr.length >= 10 ? dateStr.substring(0, 10) : dateStr;
                        }
                        return value || '';
                    });
                });
                
                // 构建工作表数据：表头 + 数据行
                const wsData = [headers, ...rows];
                
                // 创建工作表
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // 设置单元格样式：全表垂直居中，水平居中
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let r = range.s.r; r <= range.e.r; r++) {
                    for (let c = range.s.c; c <= range.e.c; c++) {
                        const cellRef = XLSX.utils.encode_cell({ r, c });
                        if (!ws[cellRef]) ws[cellRef] = { v: '' };
                        
                        ws[cellRef].s = {
                            alignment: {
                                vertical: 'center',
                                horizontal: 'center',
                                wrapText: true
                            }
                        };
                        
                        // 表头（第1行）加粗
                        if (r === 0) {
                            ws[cellRef].s.font = {
                                bold: true
                            };
                        }
                    }
                }
                
                // 自动调整列宽
                ws['!cols'] = exportColumns.map(col => {
                    // 根据内容自动调整列宽
                    const maxWidth = Math.max(
                        col.label.length + 2, // 表头宽度
                        ...rows.map(row => {
                            const value = row[exportColumns.indexOf(col)];
                            return String(value).length + 2;
                        })
                    );
                    return { wch: Math.min(maxWidth, 50) }; // 限制最大宽度为50
                });
                
                // 创建工作簿并添加工作表
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "索赔清单");
                
                // 导出文件
                XLSX.writeFile(wb, `追溯索赔清单列表_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showToast(`成功导出 ${data.length} 条记录`, 'success');
            } catch (error) {
                showToast('批量导出失败: ' + (error.message || '未知错误'), 'error');
            }
        }

        /**
         * 【新增】批量删除选中记录
         */
        async function batchDelete() {
            const selectedIds = getSelectedRowIds();
            if (selectedIds.length === 0) {
                showToast('请先选择要删除的记录', 'error');
                return;
            }
            
            // 二次确认
            if (!confirm(`确定要删除 ${selectedIds.length} 条记录吗？此操作不可恢复！`)) {
                return;
            }
            
            if (!confirm(`再次确认：真的要删除这 ${selectedIds.length} 条记录吗？`)) {
                return;
            }
            
            try {
                const client = window.supabaseClient || (typeof supabaseClient !== 'undefined' ? supabaseClient : null);
                if (!client) {
                    showToast('数据库连接失败，请刷新页面重试', 'error');
                    return;
                }
                
                // 批量删除
                const { error } = await client
                    .from('claims_v2')
                    .delete()
                    .in('id', selectedIds);
                
                if (error) throw error;
                
                showToast(`成功删除 ${selectedIds.length} 条记录`, 'success');
                
                // 刷新列表
                if (typeof window !== 'undefined' && typeof window.fetchTableData === 'function') {
                    await window.fetchTableData(false, true); // append=false, forceRefresh=true
                } else if (typeof fetchTableData === 'function') {
                    await fetchTableData(false, true);
                } else if (typeof renderDatabase === 'function') {
                    renderDatabase();
                }
                
                clearSelection(); // 清空选择
            } catch (error) {
                showToast('批量删除失败: ' + (error.message || '未知错误'), 'error');
            }
        }

        /**
         * 【新增】将数据转换为CSV格式（用于导出）
         */
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            // 定义列头（中文）
            const headers = ['海外仓单号', '物流运单号', '发货仓', '发货日期', '订单SKU', '索赔类型', '问题描述', '货物声明价值', '索赔数量', '总赔偿金额', '币种', '处理状态', '申请提交日期'];
            const keys = ['order_no', 'tracking_no', 'warehouse', 'ship_date', 'sku', 'claim_type', 'description', 'val_amount', 'claim_qty', 'claim_total', 'currency', 'process_status', 'entry_date'];
            
            // 构建CSV内容
            let csv = headers.join(',') + '\n';
            
            data.forEach(item => {
                const row = keys.map(key => {
                    let value = item[key] || '';
                    // 处理包含逗号的值
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }

        // 将批量操作函数暴露到全局作用域
        window.getSelectedRowIds = getSelectedRowIds;
        window.clearSelection = clearSelection;
        window.batchUpdateStatus = batchUpdateStatus;
        window.batchUpdateStatusFromSelect = batchUpdateStatusFromSelect;
        window.batchExportSelected = batchExportSelected;
        window.batchDelete = batchDelete;
    </script>
</body>
</html>